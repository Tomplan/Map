import{u as de,r as o,ap as ge,a1 as ue,R as t,I as v,m as pe,aq as fe,a3 as he,d as G,e as J,aj as V}from"./index-1e4c7e6c.js";import{u as ye}from"./useAssignments-4f6fb97f.js";import{u as be}from"./useEventSubscriptions-6efe7c48.js";import{u as xe}from"./useMarkerGlyphs-bf81b2ba.js";import"./phone-376c158e.js";const K="assignmentsTab_sortPreferences";function Ae({selectedYear:y}){const{t:d}=de(),[N,Z]=o.useState(""),{preferences:l,loading:w,updatePreferences:z}=ge(),_=o.useRef(null),k=(()=>{try{const e=localStorage.getItem(K);if(e)return JSON.parse(e)}catch(e){console.error("Error loading sort preferences:",e)}return{sortBy:"alphabetic",sortDirection:"asc",columnSort:"marker_id",columnSortDirection:"asc"}})(),[b,T]=o.useState(k.sortBy),[g,j]=o.useState(k.sortDirection),[x,L]=o.useState(k.columnSort),[u,R]=o.useState(k.columnSortDirection);o.useEffect(()=>{if(!w&&l){const e=l.assignments_sort_by||"alphabetic",s=l.assignments_sort_direction||"asc",n=l.assignments_column_sort||"marker_id",r=l.assignments_column_sort_direction||"asc";_.current={sortBy:e,sortDirection:s,columnSort:n,columnSortDirection:r},T(e),j(s),L(n),R(r)}},[w,l]);const{markers:U,loading:Q}=xe(),{assignments:i,loading:X,error:F,assignCompanyToMarker:I,unassignCompanyFromMarker:Y,archiveCurrentYear:ee,loadArchivedAssignments:te}=ye(y),{subscriptions:H}=be(y),{confirm:O,toastError:A,toastSuccess:se,toastInfo:ne}=ue(),E=o.useMemo(()=>H.map(e=>{var s,n;return{id:e.company_id,name:((s=e.company)==null?void 0:s.name)||"Unknown",logo:((n=e.company)==null?void 0:n.logo)||""}}),[H]);o.useEffect(()=>{try{const e={sortBy:b,sortDirection:g,columnSort:x,columnSortDirection:u};localStorage.setItem(K,JSON.stringify(e))}catch(e){console.error("Error saving sort preferences to localStorage:",e)}if(!w&&l){const e=l.assignments_sort_by!==b||l.assignments_sort_direction!==g||l.assignments_column_sort!==x||l.assignments_column_sort_direction!==u,s=!_.current||_.current.sortBy!==b||_.current.sortDirection!==g||_.current.columnSort!==x||_.current.columnSortDirection!==u;e&&s&&z({assignments_sort_by:b,assignments_sort_direction:g,assignments_column_sort:x,assignments_column_sort_direction:u})}},[b,g,x,u,w,l,z]);const $=o.useMemo(()=>{const e={};return i.forEach(s=>{e[s.company_id]=(e[s.company_id]||0)+1}),e},[i]),C=o.useMemo(()=>{const e={};return i.forEach(s=>{(!e[s.company_id]||s.marker_id<e[s.company_id])&&(e[s.company_id]=s.marker_id)}),e},[i]),M=o.useMemo(()=>[...N?E.filter(n=>{var r;return(r=n.name)==null?void 0:r.toLowerCase().includes(N.toLowerCase())}):E].sort((n,r)=>{const p=$[n.id]||0,f=$[r.id]||0,m=C[n.id],c=C[r.id];let a=0;switch(b){case"by_marker":!m&&c?a=1:m&&!c?a=-1:!m&&!c?a=n.name.localeCompare(r.name):m!==c?a=m-c:a=n.name.localeCompare(r.name);break;case"unassigned_first":p===0&&f>0?a=-1:p>0&&f===0?a=1:p===0&&f===0?a=n.name.localeCompare(r.name):!m&&c?a=1:m&&!c?a=-1:m!==c?a=m-c:a=n.name.localeCompare(r.name);break;case"alphabetic":default:a=n.name.localeCompare(r.name);break}return g==="desc"?-a:a}),[E,N,b,g,$,C]),D=o.useMemo(()=>[...U].sort((s,n)=>{let r=0;return x==="glyph_text"?r=s.glyph.localeCompare(n.glyph,void 0,{numeric:!0,sensitivity:"base"}):r=s.id-n.id,u==="desc"?-r:r}),[U,x,u]),W=o.useMemo(()=>{const e={};return i.forEach(s=>{const n=`${s.company_id}_${s.marker_id}`;e[n]=s}),e},[i]),re=o.useMemo(()=>{const e=new Set;return i.forEach(s=>{e.add(s.marker_id)}),e},[i]),q=e=>re.has(e),ae=(e,s)=>{const n=`${e}_${s}`;return!!W[n]},oe=(e,s)=>{const n=`${e}_${s}`;return W[n]},ie=async(e,s)=>{if(oe(e,s)){const{error:r}=await Y(s,e);r&&A(`Error removing assignment: ${r}`)}else{const r=i.filter(f=>f.marker_id===s);if(r.length>0){const f=E.find(h=>h.id===e),m=(f==null?void 0:f.name)||"this company",c=D.find(h=>h.id===s),a=(c==null?void 0:c.glyph)||s;let P;if(r.length===1){const h=E.find(S=>S.id===r[0].company_id),B=(h==null?void 0:h.name)||"another company";P=`Booth ${a} is already assigned to ${B}.

Assign ${m} as an additional company for this booth?`}else{const h=r.map(B=>{const S=E.find(me=>me.id===B.company_id);return S==null?void 0:S.name}).filter(Boolean).join(", ");P=`Booth ${a} is already assigned to ${r.length} companies: ${h}.

Assign ${m} as another company for this booth?`}if(!await O({title:"Multiple Assignments",message:P,confirmText:"Assign",variant:"warning"}))return}const{error:p}=await I(s,e,null);p&&A(`Error creating assignment: ${p}`)}},ce=async()=>{if(!await O({title:"Archive Assignments",message:`Archive all assignments for ${y}? This will move them to the archive and clear the current year.`,confirmText:"Archive",variant:"warning"}))return;const{error:s}=await ee();s?A(`Error archiving: ${s}`):se(`Successfully archived ${i.length} assignments for ${y}`)},le=async e=>{const{error:s}=await te(e);s?A(`Error loading archived assignments: ${s}`):ne(`Archived data loaded for ${e}. Feature coming soon: display in table.`)};return X||Q?t.createElement("div",{className:"p-4"},"Loading assignments..."):F?t.createElement("div",{className:"p-4 text-red-600"},"Error: ",F):t.createElement("div",{className:"h-full flex flex-col p-4"},t.createElement("div",{className:"flex items-center justify-between mb-4 flex-shrink-0"},t.createElement("div",{className:"flex items-center gap-2"},t.createElement(v,{path:pe,size:1,className:"text-gray-500"}),t.createElement("input",{type:"text",placeholder:d("helpPanel.assignments.searchPlaceholder"),value:N,onChange:e=>Z(e.target.value),className:"px-3 py-2 border rounded-lg"}),t.createElement("span",{className:"text-sm text-gray-600"},M.length," of ",E.length)),t.createElement("div",{className:"flex gap-2"},t.createElement("button",{onClick:()=>le(y),className:"flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700",title:`View archived assignments for ${y}`},t.createElement(v,{path:fe,size:.8}),t.createElement("span",null,d("helpPanel.assignments.archive"))),t.createElement("button",{onClick:ce,className:"flex items-center gap-2 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed",disabled:i.length===0,title:`Archive all assignments for ${y}`},t.createElement(v,{path:he,size:.8})),t.createElement("div",{className:"flex items-end gap-3"},t.createElement("div",null,t.createElement("label",{className:"block text-sm font-medium text-gray-700 mb-1"},d("helpPanel.assignments.sortCompanies")),t.createElement("div",{className:"flex items-center border border-gray-300 rounded-md shadow-sm bg-white"},t.createElement("select",{value:b,onChange:e=>T(e.target.value),className:"flex-1 pl-3 pr-3 py-1.5 border-0 rounded-l-md bg-white text-gray-900 text-sm focus:ring-0 appearance-none",title:"Sort table rows"},t.createElement("option",{value:"alphabetic"},"A-Z"),t.createElement("option",{value:"by_marker"},d("helpPanel.assignments.byMarker")),t.createElement("option",{value:"unassigned_first"},d("helpPanel.assignments.unassignedFirst"))),t.createElement("button",{onClick:()=>j(g==="asc"?"desc":"asc"),className:"px-2 py-1.5 border-l border-gray-300 text-gray-500 hover:bg-gray-50 rounded-r-md",title:g==="asc"?"Ascending":"Descending"},t.createElement(v,{path:g==="asc"?G:J,size:.8})))),t.createElement("div",null,t.createElement("label",{className:"block text-sm font-medium text-gray-700 mb-1"},d("helpPanel.assignments.sortMarkers")),t.createElement("div",{className:"flex items-center border border-gray-300 rounded-md shadow-sm bg-white"},t.createElement("select",{value:x,onChange:e=>L(e.target.value),className:"flex-1 pl-3 pr-3 py-1.5 border-0 rounded-l-md bg-white text-gray-900 text-sm focus:ring-0 appearance-none",title:"Sort table columns"},t.createElement("option",{value:"marker_id"},d("helpPanel.assignments.markerId")),t.createElement("option",{value:"glyph_text"},d("helpPanel.assignments.glyphText"))),t.createElement("button",{onClick:()=>R(u==="asc"?"desc":"asc"),className:"px-2 py-1.5 border-l border-gray-300 text-gray-500 hover:bg-gray-50 rounded-r-md",title:u==="asc"?"Ascending":"Descending"},t.createElement(v,{path:u==="asc"?G:J,size:.8}))))))),t.createElement("div",{className:"flex-1 overflow-auto border rounded-lg relative",style:{maxHeight:"calc(100vh - 8rem)"}},t.createElement("table",{className:"w-full table-auto border-separate",style:{fontSize:"11px"}},t.createElement("thead",{className:"bg-gray-100"},t.createElement("tr",{className:"text-gray-900"},t.createElement("th",{className:"p-2 text-left font-semibold border-b border-r bg-gray-200 sticky left-0 top-0 z-30",style:{minWidth:"200px",background:"#f3f4f6"}},"Company"),D.map(e=>{const s=q(e.id);return t.createElement("th",{key:e.id,className:`p-1 text-center border-b sticky top-0 z-20 ${s?"":"bg-gray-200"}`,style:{minWidth:"45px",maxWidth:"45px",background:s?"#f9fafb":"#f3f4f6"},title:`Marker ID: ${e.id}, Booth: ${e.glyph}${s?"":" (Unassigned)"}`},t.createElement("div",{className:`font-semibold ${s?"":"text-gray-500"}`},e.glyph))}))),t.createElement("tbody",null,M.map(e=>{const s=$[e.id]||0;return t.createElement("tr",{key:e.id,className:"hover:bg-gray-50"},t.createElement("td",{className:"p-2 border-b border-r bg-white sticky left-0 z-20",style:{background:"white"}},t.createElement("div",{className:"flex items-center justify-between gap-2"},t.createElement("div",{className:"font-semibold text-gray-900 truncate",title:e.name},e.name),t.createElement("span",{className:`inline-flex items-center justify-center min-w-[24px] h-5 px-1.5 rounded-full text-xs font-medium ${s===0?"bg-gray-200 text-gray-600":"bg-blue-100 text-blue-700"}`,title:`${s} assignment${s!==1?"s":""}`},s))),D.map(n=>{const r=ae(e.id,n.id),p=q(n.id);return t.createElement("td",{key:n.id,className:`p-0 border-b border-r text-center ${p?"":"bg-gray-100"}`},t.createElement("button",{onClick:()=>ie(e.id,n.id),className:`w-full h-full p-2 transition-colors ${r?"bg-green-100 hover:bg-green-200 text-green-700":p?"bg-white hover:bg-gray-100 text-gray-300":"bg-gray-100 hover:bg-gray-200 text-gray-400"}`,title:r?`${e.name} â†’ Booth ${n.glyph}`:`Assign ${e.name} to Booth ${n.glyph}`},r&&t.createElement(v,{path:V,size:.6})))}))}))),M.length===0&&t.createElement("div",{className:"text-center py-8 text-gray-500"},N?"No companies found matching your search":"No companies available. Add companies in the Companies tab.")),t.createElement("div",{className:"mt-4 p-3 bg-gray-100 rounded-lg space-y-2"},t.createElement("div",{className:"flex items-center gap-4 text-sm text-gray-900"},t.createElement("div",{className:"flex items-center gap-2"},t.createElement("div",{className:"w-6 h-6 bg-green-100 border border-green-200 rounded flex items-center justify-center"},t.createElement(v,{path:V,size:.5,className:"text-green-700"})),t.createElement("span",{className:"font-medium"},d("helpPanel.assignments.assigned"))),t.createElement("div",{className:"flex items-center gap-2"},t.createElement("div",{className:"w-6 h-6 border-2 border-gray-300 bg-white rounded"}),t.createElement("span",{className:"font-medium"},d("helpPanel.assignments.notAssigned")))),t.createElement("div",{className:"text-sm text-gray-900"},t.createElement("strong",null,"Statistics for ",y,":")," ",i.length," assignments,"," ",new Set(i.map(e=>e.company_id)).size," unique companies,"," ",new Set(i.map(e=>e.marker_id)).size," markers assigned")))}export{Ae as default};
