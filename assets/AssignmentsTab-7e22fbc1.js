import{u as de,r as o,aR as me,ak as ge,K as he,j as s,I as v,m as ue,f as z,h as T,an as pe,aJ as Z}from"./index-12ba77bc.js";import{u as xe}from"./useEventSubscriptions-383803ab.js";import{u as fe}from"./useMarkerGlyphs-0043ecf8.js";import"./phone-376c158e.js";const Q="assignmentsTab_sortPreferences";function Ae({selectedYear:_}){const{t:h}=de(),[w,X]=o.useState(""),{preferences:d,loading:A,updatePreferences:L}=me(),N=o.useRef(null),k=(()=>{try{const e=localStorage.getItem(Q);if(e)return JSON.parse(e)}catch(e){console.error("Error loading sort preferences:",e)}return{sortBy:"alphabetic",sortDirection:"asc",columnSort:"glyph_text",columnSortDirection:"asc"}})(),[f,R]=o.useState(k.sortBy),[u,U]=o.useState(k.sortDirection),[y,O]=o.useState(k.columnSort),[p,F]=o.useState(k.columnSortDirection),[M,H]=o.useState(!1);o.useEffect(()=>{if(!A&&d){const e=d.assignments_sort_by||"alphabetic",t=d.assignments_sort_direction||"asc",n=d.assignments_column_sort||"glyph_text",r=d.assignments_column_sort_direction||"asc";N.current={sortBy:e,sortDirection:t,columnSort:n,columnSortDirection:r},R(e),U(t),O(n),F(r)}},[A,d]);const{markers:J,loading:I}=fe(_),{assignments:m,loading:Y,error:W,assignCompanyToMarker:ee,unassignCompanyFromMarker:se,archiveCurrentYear:be,loadArchivedAssignments:te}=ge(_),{subscriptions:G}=xe(_),{confirm:K,toastError:D,toastSuccess:je,toastInfo:ne}=he(),b=o.useMemo(()=>G.map(e=>{var t,n;return{id:e.company_id,name:((t=e.company)==null?void 0:t.name)||"Unknown",logo:((n=e.company)==null?void 0:n.logo)||""}}),[G]);o.useEffect(()=>{try{const e={sortBy:f,sortDirection:u,columnSort:y,columnSortDirection:p};localStorage.setItem(Q,JSON.stringify(e))}catch(e){console.error("Error saving sort preferences to localStorage:",e)}if(!A&&d){const e=d.assignments_sort_by!==f||d.assignments_sort_direction!==u||d.assignments_column_sort!==y||d.assignments_column_sort_direction!==p,t=!N.current||N.current.sortBy!==f||N.current.sortDirection!==u||N.current.columnSort!==y||N.current.columnSortDirection!==p;e&&t&&L({assignments_sort_by:f,assignments_sort_direction:u,assignments_column_sort:y,assignments_column_sort_direction:p})}},[f,u,y,p,A,d,L]);const C=o.useMemo(()=>{const e={};return m.forEach(t=>{e[t.company_id]=(e[t.company_id]||0)+1}),e},[m]),P=o.useMemo(()=>{const e={};return m.forEach(t=>{(!e[t.company_id]||t.marker_id<e[t.company_id])&&(e[t.company_id]=t.marker_id)}),e},[m]),E=o.useMemo(()=>[...w?b.filter(n=>{var r;return(r=n.name)==null?void 0:r.toLowerCase().includes(w.toLowerCase())}):b].sort((n,r)=>{const g=C[n.id]||0,l=C[r.id]||0,i=P[n.id],c=P[r.id];let a=0;switch(f){case"by_marker":!i&&c?a=1:i&&!c?a=-1:!i&&!c?a=n.name.localeCompare(r.name):i!==c?a=i-c:a=n.name.localeCompare(r.name);break;case"unassigned_first":g===0&&l>0?a=-1:g>0&&l===0?a=1:g===0&&l===0?a=n.name.localeCompare(r.name):!i&&c?a=1:i&&!c?a=-1:i!==c?a=i-c:a=n.name.localeCompare(r.name);break;case"alphabetic":default:a=n.name.localeCompare(r.name);break}return u==="desc"?-a:a}),[b,w,f,u,C,P]),$=o.useMemo(()=>[...J].sort((t,n)=>{let r=0;return y==="glyph_text"?r=t.glyph.localeCompare(n.glyph,void 0,{numeric:!0,sensitivity:"base"}):r=t.id-n.id,p==="desc"?-r:r}),[J,y,p]),V=o.useMemo(()=>{const e={};return m.forEach(t=>{const n=`${t.company_id}_${t.marker_id}`;e[n]=t}),e},[m]),re=o.useMemo(()=>{const e=new Set;return m.forEach(t=>{e.add(t.marker_id)}),e},[m]),q=e=>re.has(e),ae=(e,t)=>{const n=`${e}_${t}`;return!!V[n]},oe=(e,t)=>{const n=`${e}_${t}`;return V[n]},ie=async(e,t)=>{if(oe(e,t)){const r=b.find(j=>j.id===e),g=(r==null?void 0:r.name)||"this company",l=$.find(j=>j.id===t),i=(l==null?void 0:l.glyph)||t;if(!await K({title:"Remove Assignment",message:`Are you sure you want to unassign ${g} from Booth ${i}?`,confirmText:"Unassign",variant:"destructive"}))return;const{error:a}=await se(t,e);a&&D(`Error removing assignment: ${a}`)}else{const r=m.filter(l=>l.marker_id===t);if(r.length>0){const l=b.find(x=>x.id===e),i=(l==null?void 0:l.name)||"this company",c=$.find(x=>x.id===t),a=(c==null?void 0:c.glyph)||t;let j;if(r.length===1){const x=b.find(S=>S.id===r[0].company_id),B=(x==null?void 0:x.name)||"another company";j=`Booth ${a} is already assigned to ${B}.

Assign ${i} as an additional company for this booth?`}else{const x=r.map(B=>{const S=b.find(le=>le.id===B.company_id);return S==null?void 0:S.name}).filter(Boolean).join(", ");j=`Booth ${a} is already assigned to ${r.length} companies: ${x}.

Assign ${i} as another company for this booth?`}if(!await K({title:"Multiple Assignments",message:j,confirmText:"Assign",variant:"warning"}))return}const{error:g}=await ee(t,e,null);g&&D(`Error creating assignment: ${g}`)}},ce=async e=>{const{error:t}=await te(e);t?D(`Error loading archived assignments: ${t}`):ne(`Archived data loaded for ${e}. Feature coming soon: display in table.`)};return Y||I?s.jsx("div",{className:"p-4",children:"Loading assignments..."}):W?s.jsxs("div",{className:"p-4 text-red-600",children:["Error: ",W]}):s.jsxs("div",{className:"h-full flex flex-col p-4",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4 flex-shrink-0",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(v,{path:ue,size:1,className:"text-gray-500"}),s.jsx("input",{type:"text",placeholder:h("helpPanel.assignments.searchPlaceholder"),value:w,onChange:e=>X(e.target.value),className:"px-3 py-2 border rounded-lg"}),s.jsxs("span",{className:"text-sm text-gray-600",children:[E.length," of ",b.length]})]}),s.jsxs("div",{className:"flex gap-2 relative z-50",children:[s.jsxs("div",{className:"relative",children:[s.jsxs("button",{onClick:()=>H(!M),className:"flex items-center gap-2 px-3 py-1.5 text-sm font-medium bg-white text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-sm transition-all",title:"Actions Menu",children:[s.jsx("span",{children:"Actions"}),s.jsx(v,{path:M?z:T,size:.7})]}),M&&s.jsxs("div",{className:"absolute right-0 mt-1 w-56 bg-white border border-gray-200 rounded-lg shadow-xl z-50 overflow-hidden py-1",children:[s.jsx("div",{className:"px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-50 border-b border-gray-100",children:"Data Tools"}),s.jsxs("button",{onClick:()=>{ce(_),H(!1)},className:"w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2",title:`View archived assignments for ${_}`,children:[s.jsx(v,{path:pe,size:.7,className:"text-gray-400"}),s.jsx("span",{children:h("helpPanel.assignments.archive")})]})]})]}),s.jsxs("div",{className:"flex items-end gap-3",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:h("helpPanel.assignments.sortCompanies")}),s.jsxs("div",{className:"flex items-center border border-gray-300 rounded-md shadow-sm bg-white",children:[s.jsxs("select",{value:f,onChange:e=>R(e.target.value),className:"flex-1 pl-3 pr-3 py-1.5 border-0 rounded-l-md bg-white text-gray-900 text-sm focus:ring-0 appearance-none",title:"Sort table rows",children:[s.jsx("option",{value:"alphabetic",children:"A-Z"}),s.jsx("option",{value:"by_marker",children:h("helpPanel.assignments.byMarker")}),s.jsx("option",{value:"unassigned_first",children:h("helpPanel.assignments.unassignedFirst")})]}),s.jsx("button",{onClick:()=>U(u==="asc"?"desc":"asc"),className:"px-2 py-1.5 border-l border-gray-300 text-gray-500 hover:bg-gray-50 rounded-r-md",title:u==="asc"?"Ascending":"Descending",children:s.jsx(v,{path:u==="asc"?z:T,size:.8})})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:h("helpPanel.assignments.sortMarkers")}),s.jsxs("div",{className:"flex items-center border border-gray-300 rounded-md shadow-sm bg-white",children:[s.jsxs("select",{value:y,onChange:e=>O(e.target.value),className:"flex-1 pl-3 pr-3 py-1.5 border-0 rounded-l-md bg-white text-gray-900 text-sm focus:ring-0 appearance-none",title:"Sort table columns",children:[s.jsx("option",{value:"marker_id",children:h("helpPanel.assignments.markerId")}),s.jsx("option",{value:"glyph_text",children:h("helpPanel.assignments.glyphText")})]}),s.jsx("button",{onClick:()=>F(p==="asc"?"desc":"asc"),className:"px-2 py-1.5 border-l border-gray-300 text-gray-500 hover:bg-gray-50 rounded-r-md",title:p==="asc"?"Ascending":"Descending",children:s.jsx(v,{path:p==="asc"?z:T,size:.8})})]})]})]})]})]}),s.jsxs("div",{className:"flex-1 overflow-auto border rounded-lg relative",style:{maxHeight:"calc(100vh - 8rem)"},children:[s.jsxs("table",{className:"w-full table-auto border-separate",style:{fontSize:"11px"},children:[s.jsx("thead",{className:"bg-gray-100",children:s.jsxs("tr",{className:"text-gray-900",children:[s.jsx("th",{className:"p-2 text-left font-semibold border-b border-r bg-gray-200 sticky left-0 top-0 z-30",style:{minWidth:"200px",background:"#f3f4f6"},children:"Company"}),$.map(e=>{const t=q(e.id);return s.jsx("th",{className:`p-1 text-center border-b sticky top-0 z-20 ${t?"":"bg-gray-200"}`,style:{minWidth:"45px",maxWidth:"45px",background:t?"#f9fafb":"#f3f4f6"},title:`Marker ID: ${e.id}, Booth: ${e.glyph}${t?"":" (Unassigned)"}`,children:s.jsx("div",{className:`font-semibold ${t?"":"text-gray-500"}`,children:e.glyph})},e.id)})]})}),s.jsx("tbody",{children:E.map(e=>{const t=C[e.id]||0;return s.jsxs("tr",{className:"hover:bg-gray-50",children:[s.jsx("td",{className:"p-2 border-b border-r bg-white sticky left-0 z-20",style:{background:"white"},children:s.jsxs("div",{className:"flex items-center justify-between gap-2",children:[s.jsx("div",{className:"font-semibold text-gray-900 truncate",title:e.name,children:e.name}),s.jsx("span",{className:`inline-flex items-center justify-center min-w-[24px] h-5 px-1.5 rounded-full text-xs font-medium ${t===0?"bg-gray-200 text-gray-600":"bg-blue-100 text-blue-700"}`,title:`${t} assignment${t!==1?"s":""}`,children:t})]})}),$.map(n=>{const r=ae(e.id,n.id),g=q(n.id);return s.jsx("td",{className:`p-0 border-b border-r text-center ${g?"":"bg-gray-100"}`,children:s.jsx("button",{onClick:()=>ie(e.id,n.id),className:`w-full h-full p-2 transition-colors ${r?"bg-green-100 hover:bg-green-200 text-green-700":g?"bg-white hover:bg-gray-100 text-gray-300":"bg-gray-100 hover:bg-gray-200 text-gray-400"}`,title:r?`${e.name} â†’ Booth ${n.glyph}`:`Assign ${e.name} to Booth ${n.glyph}`,children:r&&s.jsx(v,{path:Z,size:.6})})},n.id)})]},e.id)})})]}),E.length===0&&s.jsx("div",{className:"text-center py-8 text-gray-500",children:w?"No companies found matching your search":"No companies available. Add companies in the Companies tab."})]}),s.jsxs("div",{className:"mt-4 p-3 bg-gray-100 rounded-lg space-y-2",children:[s.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-900",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-6 h-6 bg-green-100 border border-green-200 rounded flex items-center justify-center",children:s.jsx(v,{path:Z,size:.5,className:"text-green-700"})}),s.jsx("span",{className:"font-medium",children:h("helpPanel.assignments.assigned")})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-6 h-6 border-2 border-gray-300 bg-white rounded"}),s.jsx("span",{className:"font-medium",children:h("helpPanel.assignments.notAssigned")})]})]}),s.jsxs("div",{className:"text-sm text-gray-900",children:[s.jsxs("strong",{children:["Statistics for ",_,":"]})," ",m.length," assignments,"," ",new Set(m.map(e=>e.company_id)).size," unique companies,"," ",new Set(m.map(e=>e.marker_id)).size," markers assigned"]})]})]})}export{Ae as default};
