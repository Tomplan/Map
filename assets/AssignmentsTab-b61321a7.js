import{c as me,r as i,j as s,I as j}from"./vendor-react-505adfae.js";import{u as ge}from"./useAssignments-671cc28d.js";import{u as he}from"./useEventSubscriptions-015b6bb3.js";import{u as ue}from"./useMarkerGlyphs-2b5d6d82.js";import{n as pe,i as fe}from"./index-5891cb02.js";import{ak as xe,b4 as ye,aT as be,al as J,am as V,aY as q}from"./vendor-3a7855fa.js";import"./vendor-i18n-2e1fa53c.js";import"./phone-a3a14bef.js";import"./vendor-supabase-54a3b136.js";import"./vendor-map-5eb3cb24.js";const K="assignmentsTab_sortPreferences";function Ee({selectedYear:u}){const{t:m}=me(),[N,Z]=i.useState(""),{preferences:l,loading:S,updatePreferences:B}=pe(),_=i.useRef(null),k=(()=>{try{const e=localStorage.getItem(K);if(e)return JSON.parse(e)}catch(e){console.error("Error loading sort preferences:",e)}return{sortBy:"alphabetic",sortDirection:"asc",columnSort:"marker_id",columnSortDirection:"asc"}})(),[y,T]=i.useState(k.sortBy),[g,z]=i.useState(k.sortDirection),[b,L]=i.useState(k.columnSort),[h,U]=i.useState(k.columnSortDirection);i.useEffect(()=>{if(!S&&l){const e=l.assignments_sort_by||"alphabetic",t=l.assignments_sort_direction||"asc",r=l.assignments_column_sort||"marker_id",n=l.assignments_column_sort_direction||"asc";_.current={sortBy:e,sortDirection:t,columnSort:r,columnSortDirection:n},T(e),z(t),L(r),U(n)}},[S,l]);const{markers:R,loading:Q}=ue(u),{assignments:o,loading:X,error:F,assignCompanyToMarker:I,unassignCompanyFromMarker:Y,archiveCurrentYear:ee,loadArchivedAssignments:se}=ge(u),{subscriptions:H}=he(u),{confirm:O,toastError:A,toastSuccess:te,toastInfo:re}=fe(),v=i.useMemo(()=>H.map(e=>{var t,r;return{id:e.company_id,name:((t=e.company)==null?void 0:t.name)||"Unknown",logo:((r=e.company)==null?void 0:r.logo)||""}}),[H]);i.useEffect(()=>{try{const e={sortBy:y,sortDirection:g,columnSort:b,columnSortDirection:h};localStorage.setItem(K,JSON.stringify(e))}catch(e){console.error("Error saving sort preferences to localStorage:",e)}if(!S&&l){const e=l.assignments_sort_by!==y||l.assignments_sort_direction!==g||l.assignments_column_sort!==b||l.assignments_column_sort_direction!==h,t=!_.current||_.current.sortBy!==y||_.current.sortDirection!==g||_.current.columnSort!==b||_.current.columnSortDirection!==h;e&&t&&B({assignments_sort_by:y,assignments_sort_direction:g,assignments_column_sort:b,assignments_column_sort_direction:h})}},[y,g,b,h,S,l,B]);const $=i.useMemo(()=>{const e={};return o.forEach(t=>{e[t.company_id]=(e[t.company_id]||0)+1}),e},[o]),C=i.useMemo(()=>{const e={};return o.forEach(t=>{(!e[t.company_id]||t.marker_id<e[t.company_id])&&(e[t.company_id]=t.marker_id)}),e},[o]),M=i.useMemo(()=>[...N?v.filter(r=>{var n;return(n=r.name)==null?void 0:n.toLowerCase().includes(N.toLowerCase())}):v].sort((r,n)=>{const p=$[r.id]||0,f=$[n.id]||0,d=C[r.id],c=C[n.id];let a=0;switch(y){case"by_marker":!d&&c?a=1:d&&!c?a=-1:!d&&!c?a=r.name.localeCompare(n.name):d!==c?a=d-c:a=r.name.localeCompare(n.name);break;case"unassigned_first":p===0&&f>0?a=-1:p>0&&f===0?a=1:p===0&&f===0?a=r.name.localeCompare(n.name):!d&&c?a=1:d&&!c?a=-1:d!==c?a=d-c:a=r.name.localeCompare(n.name);break;case"alphabetic":default:a=r.name.localeCompare(n.name);break}return g==="desc"?-a:a}),[v,N,y,g,$,C]),D=i.useMemo(()=>[...R].sort((t,r)=>{let n=0;return b==="glyph_text"?n=t.glyph.localeCompare(r.glyph,void 0,{numeric:!0,sensitivity:"base"}):n=t.id-r.id,h==="desc"?-n:n}),[R,b,h]),W=i.useMemo(()=>{const e={};return o.forEach(t=>{const r=`${t.company_id}_${t.marker_id}`;e[r]=t}),e},[o]),ne=i.useMemo(()=>{const e=new Set;return o.forEach(t=>{e.add(t.marker_id)}),e},[o]),G=e=>ne.has(e),ae=(e,t)=>{const r=`${e}_${t}`;return!!W[r]},ie=(e,t)=>{const r=`${e}_${t}`;return W[r]},oe=async(e,t)=>{if(ie(e,t)){const{error:n}=await Y(t,e);n&&A(`Error removing assignment: ${n}`)}else{const n=o.filter(f=>f.marker_id===t);if(n.length>0){const f=v.find(x=>x.id===e),d=(f==null?void 0:f.name)||"this company",c=D.find(x=>x.id===t),a=(c==null?void 0:c.glyph)||t;let E;if(n.length===1){const x=v.find(w=>w.id===n[0].company_id),P=(x==null?void 0:x.name)||"another company";E=`Booth ${a} is already assigned to ${P}.

Assign ${d} as an additional company for this booth?`}else{const x=n.map(P=>{const w=v.find(de=>de.id===P.company_id);return w==null?void 0:w.name}).filter(Boolean).join(", ");E=`Booth ${a} is already assigned to ${n.length} companies: ${x}.

Assign ${d} as another company for this booth?`}if(!await O({title:"Multiple Assignments",message:E,confirmText:"Assign",variant:"warning"}))return}const{error:p}=await I(t,e,null);p&&A(`Error creating assignment: ${p}`)}},ce=async()=>{if(!await O({title:"Archive Assignments",message:`Archive all assignments for ${u}? This will move them to the archive and clear the current year.`,confirmText:"Archive",variant:"warning"}))return;const{error:t}=await ee();t?A(`Error archiving: ${t}`):te(`Successfully archived ${o.length} assignments for ${u}`)},le=async e=>{const{error:t}=await se(e);t?A(`Error loading archived assignments: ${t}`):re(`Archived data loaded for ${e}. Feature coming soon: display in table.`)};return X||Q?s.jsx("div",{className:"p-4",children:"Loading assignments..."}):F?s.jsxs("div",{className:"p-4 text-red-600",children:["Error: ",F]}):s.jsxs("div",{className:"h-full flex flex-col p-4","data-testid":"assignments-container",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4 flex-shrink-0",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(j,{path:xe,size:1,className:"text-gray-500"}),s.jsx("input",{"data-testid":"assignments-search",type:"text",placeholder:m("helpPanel.assignments.searchPlaceholder"),value:N,onChange:e=>Z(e.target.value),className:"px-3 py-2 border rounded-lg"}),s.jsxs("span",{className:"text-sm text-gray-600",children:[M.length," of ",v.length]})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs("button",{onClick:()=>le(u),"data-testid":"view-archived-button",className:"flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700",title:`View archived assignments for ${u}`,children:[s.jsx(j,{path:ye,size:.8}),s.jsx("span",{children:m("helpPanel.assignments.archive")})]}),s.jsx("button",{onClick:ce,"data-testid":"archive-assignments-button",className:"flex items-center gap-2 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed",disabled:o.length===0,title:`Archive all assignments for ${u}`,children:s.jsx(j,{path:be,size:.8})}),s.jsxs("div",{className:"flex items-end gap-3",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:m("helpPanel.assignments.sortCompanies")}),s.jsxs("div",{className:"flex items-center border border-gray-300 rounded-md shadow-sm bg-white",children:[s.jsxs("select",{value:y,onChange:e=>T(e.target.value),"data-testid":"sort-companies-dropdown",className:"flex-1 pl-3 pr-3 py-1.5 border-0 rounded-l-md bg-white text-gray-900 text-sm focus:ring-0 appearance-none",title:"Sort table rows",children:[s.jsx("option",{value:"alphabetic",children:"A-Z"}),s.jsx("option",{value:"by_marker",children:m("helpPanel.assignments.byMarker")}),s.jsx("option",{value:"unassigned_first",children:m("helpPanel.assignments.unassignedFirst")})]}),s.jsx("button",{onClick:()=>z(g==="asc"?"desc":"asc"),"data-testid":"sort-companies-direction",className:"px-2 py-1.5 border-l border-gray-300 text-gray-500 hover:bg-gray-50 rounded-r-md",title:g==="asc"?"Ascending":"Descending",children:s.jsx(j,{path:g==="asc"?J:V,size:.8})})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:m("helpPanel.assignments.sortMarkers")}),s.jsxs("div",{className:"flex items-center border border-gray-300 rounded-md shadow-sm bg-white",children:[s.jsxs("select",{value:b,onChange:e=>L(e.target.value),"data-testid":"sort-markers-dropdown",className:"flex-1 pl-3 pr-3 py-1.5 border-0 rounded-l-md bg-white text-gray-900 text-sm focus:ring-0 appearance-none",title:"Sort table columns",children:[s.jsx("option",{value:"marker_id",children:m("helpPanel.assignments.markerId")}),s.jsx("option",{value:"glyph_text",children:m("helpPanel.assignments.glyphText")})]}),s.jsx("button",{onClick:()=>U(h==="asc"?"desc":"asc"),"data-testid":"sort-markers-direction",className:"px-2 py-1.5 border-l border-gray-300 text-gray-500 hover:bg-gray-50 rounded-r-md",title:h==="asc"?"Ascending":"Descending",children:s.jsx(j,{path:h==="asc"?J:V,size:.8})})]})]})]})]})]}),s.jsxs("div",{className:"flex-1 overflow-auto border rounded-lg relative",style:{maxHeight:"calc(100vh - 8rem)"},"data-testid":"assignments-matrix",children:[s.jsxs("table",{className:"w-full table-auto border-separate",style:{fontSize:"11px"},children:[s.jsx("thead",{className:"bg-gray-100",children:s.jsxs("tr",{className:"text-gray-900",children:[s.jsx("th",{className:"p-2 text-left font-semibold border-b border-r bg-gray-200 sticky left-0 top-0 z-30",style:{minWidth:"200px",background:"#f3f4f6"},children:"Company"}),D.map(e=>{const t=G(e.id);return s.jsx("th",{className:`p-1 text-center border-b sticky top-0 z-20 ${t?"":"bg-gray-200"}`,style:{minWidth:"45px",maxWidth:"45px",background:t?"#f9fafb":"#f3f4f6"},title:`Marker ID: ${e.id}, Booth: ${e.glyph}${t?"":" (Unassigned)"}`,children:s.jsx("div",{className:`font-semibold ${t?"":"text-gray-500"}`,children:e.glyph})},e.id)})]})}),s.jsx("tbody",{children:M.map(e=>{const t=$[e.id]||0;return s.jsxs("tr",{className:"hover:bg-gray-50",children:[s.jsx("td",{className:"p-2 border-b border-r bg-white sticky left-0 z-20",style:{background:"white"},children:s.jsxs("div",{className:"flex items-center justify-between gap-2",children:[s.jsx("div",{className:"font-semibold text-gray-900 truncate",title:e.name,children:e.name}),s.jsx("span",{className:`inline-flex items-center justify-center min-w-[24px] h-5 px-1.5 rounded-full text-xs font-medium ${t===0?"bg-gray-200 text-gray-600":"bg-blue-100 text-blue-700"}`,title:`${t} assignment${t!==1?"s":""}`,children:t})]})}),D.map(r=>{const n=ae(e.id,r.id),p=G(r.id);return s.jsx("td",{className:`p-0 border-b border-r text-center ${p?"":"bg-gray-100"}`,children:s.jsx("button",{onClick:()=>oe(e.id,r.id),className:`w-full h-full p-2 transition-colors ${n?"bg-green-100 hover:bg-green-200 text-green-700":p?"bg-white hover:bg-gray-100 text-gray-300":"bg-gray-100 hover:bg-gray-200 text-gray-400"}`,title:n?`${e.name} â†’ Booth ${r.glyph}`:`Assign ${e.name} to Booth ${r.glyph}`,children:n&&s.jsx(j,{path:q,size:.6})})},r.id)})]},e.id)})})]}),M.length===0&&s.jsx("div",{className:"text-center py-8 text-gray-500",children:N?"No companies found matching your search":"No companies available. Add companies in the Companies tab."})]}),s.jsxs("div",{className:"mt-4 p-3 bg-gray-100 rounded-lg space-y-2","data-testid":"assignments-legend",children:[s.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-900",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-6 h-6 bg-green-100 border border-green-200 rounded flex items-center justify-center",children:s.jsx(j,{path:q,size:.5,className:"text-green-700"})}),s.jsx("span",{className:"font-medium",children:m("helpPanel.assignments.assigned")})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-6 h-6 border-2 border-gray-300 bg-white rounded"}),s.jsx("span",{className:"font-medium",children:m("helpPanel.assignments.notAssigned")})]})]}),s.jsxs("div",{className:"text-sm text-gray-900",children:[s.jsxs("strong",{children:["Statistics for ",u,":"]})," ",o.length," assignments,"," ",new Set(o.map(e=>e.company_id)).size," unique companies,"," ",new Set(o.map(e=>e.marker_id)).size," markers assigned"]})]})]})}export{Ee as default};
