import{r as u,s as H,j as e,I as $,aw as pe,R as xe,d as ue,K as he,u as Q,m as be,ax as fe,M as ye,g as je,b as Ce,c as Ne,ay as z,az as we,aA as ve,a1 as Se,aB as Ee,aC as Pe,aD as Le}from"./index-88c468a1.js";import{u as Te}from"./useCompanies-ba96e93b.js";import{u as ze}from"./useOrganizationProfile-023000c0.js";import{u as $e}from"./useCategories-83124c03.js";import{L as De}from"./LogoUploader-1f7c92e3.js";import{E as ke,I as Fe,P as Ie,g as Ae,f as _e}from"./ImportButton-2936e156.js";import"./phone-376c158e.js";import"./dataExportImport-f20c9953.js";function Me({createCompany:s,updateCompany:t,deleteCompany:m,updateProfile:g,organizationLogo:c,confirm:y,toastError:j}){const[x,C]=u.useState(null),[r,i]=u.useState({}),[o,p]=u.useState(!1),[A,k]=u.useState({name:"",logo:c||"",website:"",info:""});return{editingId:x,editForm:r,setEditForm:i,isCreating:o,newCompanyForm:A,setNewCompanyForm:k,handleEdit:N=>{C(N.id),i({...N})},handleSave:async()=>{const N=x;if(N==="organization"){const{name:E,logo:R,website:I,info:G,contact:P,phone:U,email:M}=r;await g({name:E,logo:R,website:I,info:G,contact:P,phone:U,email:M})}else await t(N,r);C(null),i({})},handleCancel:()=>{C(null),i({})},handleDelete:async(N,E)=>{if(!await y({title:"Delete Company",message:`Are you sure you want to delete "${E}"? This will also delete all assignments for this company.`,confirmText:"Delete",variant:"danger"}))return;const{error:I}=await m(N);I&&j(`Error deleting company: ${I}`)},handleCreate:async()=>{if(!A.name.trim()){j("Company name is required");return}const{error:N}=await s(A);N?j(`Error creating company: ${N}`):(p(!1),k({name:"",logo:c,website:"",info:""}))},handleStartCreate:()=>{p(!0),k({name:"",logo:c,website:"",info:""})},handleCancelCreate:()=>{p(!1),k({name:"",logo:c,website:"",info:""})}}}function D(s){D.cache||(D.cache=new Map);let t=s?D.cache.get(s):null;s&&!t&&(t={state:{translations:{},loading:!1,error:null},listeners:new Set,refCount:0,loadPromise:null},D.cache.set(s,t));const[m,g]=u.useState(t?{...t.state}:{translations:{},loading:!1,error:null}),c=u.useCallback(async()=>{if(!s){t&&(t.state.translations={},t.listeners.forEach(r=>r(t.state))),g({translations:{},loading:!1,error:null});return}return t.loadPromise||(t.state.loading=!0,t.state.error=null,t.listeners.forEach(r=>r(t.state)),t.loadPromise=(async()=>{try{const{data:r,error:i}=await H.from("company_translations").select("language_code, info").eq("company_id",s);if(i)throw i;const o={};(r||[]).forEach(p=>{o[p.language_code]=p.info}),t.state.translations=o}catch(r){console.error("Error loading translations:",r),t.state.error=r.message}finally{t.state.loading=!1,t.listeners.forEach(r=>r(t.state)),t.loadPromise=null}})()),t.loadPromise},[s,t]),y=async(r,i)=>{if(s)try{t&&(t.state.error=null);const{error:o}=await H.from("company_translations").upsert({company_id:s,language_code:r,info:i,updated_at:new Date().toISOString()},{onConflict:"company_id,language_code"});if(o)throw o;return t&&(t.state.translations={...t.state.translations,[r]:i},t.listeners.forEach(p=>p(t.state))),g(p=>({...p,translations:{...p.translations,[r]:i}})),!0}catch(o){return console.error("Error saving translation:",o),g(p=>({...p,error:o.message})),!1}},j=async r=>{if(s)try{t&&(t.state.error=null);const{error:i}=await H.from("company_translations").delete().eq("company_id",s).eq("language_code",r);if(i)throw i;if(t){const o={...t.state.translations};delete o[r],t.state.translations=o,t.listeners.forEach(p=>p(t.state))}return g(o=>{const p={...o.translations};return delete p[r],{...o,translations:p}}),!0}catch(i){return console.error("Error deleting translation:",i),g(o=>({...o,error:i.message})),!1}},x=(r,i="nl")=>{const o=m.translations||{};return o[r]||o[i]||""},C=()=>Object.keys(m.translations||{});return u.useEffect(()=>{if(!s)return;const r=D.cache.get(s);if(!r)return;r.refCount+=1;const i=o=>g({...o});return r.listeners.add(i),g({...r.state}),r.refCount===1&&c(),()=>{r.listeners.delete(i),r.refCount-=1,r.refCount<=0&&D.cache.delete(s)}},[s,c]),{translations:m.translations,loading:m.loading,error:m.error,saveTranslation:y,deleteTranslation:j,getTranslation:x,getAvailableLanguages:C,reload:c}}const Oe=[{code:"nl",label:"Nederlands",flag:"ðŸ‡³ðŸ‡±"},{code:"en",label:"English",flag:"ðŸ‡¬ðŸ‡§"},{code:"de",label:"Deutsch",flag:"ðŸ‡©ðŸ‡ª"}];function We({currentLanguage:s,onLanguageChange:t,translations:m={},className:g=""}){return e.jsx("div",{className:`flex items-center gap-1 ${g}`,children:Oe.map(c=>{const y=s===c.code,j=m[c.code]&&m[c.code].trim()!=="";return e.jsxs("button",{type:"button",onClick:()=>t(c.code),className:`px-2 py-1 rounded text-xs font-medium transition flex items-center gap-1 ${y?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx("span",{children:c.flag}),e.jsx("span",{children:c.label}),j&&!y&&e.jsx($,{path:pe,size:.5,className:"text-green-600"})]},c.code)})})}function Be({translations:s={}}){const t=Object.keys(s).filter(m=>s[m]&&s[m].trim()!=="").length;return t<=1?null:e.jsx("span",{className:"inline-block ml-1 text-blue-600",title:`Available in ${t} languages`,children:"ðŸŒ"})}const se={en:Ee,nl:Pe,de:Le};function n(s,t){var m,g,c;try{if(z&&z.exists(s))return z.t(s,t);const y=((m=z)==null?void 0:m.language)||"nl",j=s.split(".");let x=se[y]||se.nl;for(const C of j){if(!x||typeof x!="object"){x=void 0;break}x=x[C]}return x!==void 0?typeof x=="string"?x:JSON.stringify(x):(g=z)!=null&&g.t?z.t(s,t):s}catch{return(c=z)!=null&&c.t?z.t(s,t):s}}function Re({companyId:s,editingLanguage:t,onLanguageChange:m}){const{translations:g,saveTranslation:c}=D(s),{t:y}=Q(),[j,x]=u.useState(""),[C,r]=u.useState(!1);u.useEffect(()=>{x(g[t]||"")},[t,g]);const i=async()=>{if(j!==(g[t]||"")){r(!0);try{await c(t,j)}catch(o){console.error("Failed to save translation:",o)}finally{r(!1)}}};return e.jsxs("div",{className:"space-y-2",children:[e.jsx(We,{currentLanguage:t,onLanguageChange:m,translations:g,className:"mb-2"}),e.jsx("textarea",{value:j,onChange:o=>x(o.target.value),onBlur:i,className:"w-full bg-white text-gray-900 border rounded px-2 py-1",rows:4,placeholder:n("companies.modal.enterInfoInLanguage",{lang:y(t==="nl"?"languages.dutch":"languages.english")}),disabled:C}),C&&e.jsx("span",{className:"text-xs text-gray-500 italic",children:n("companies.saving")})]})}function Ue({companyId:s,currentLanguage:t}){const{translations:m,getTranslation:g}=D(s);Q();const c=g(t,"nl");return e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("p",{className:"line-clamp-3 whitespace-pre-wrap flex-1",children:c||e.jsx("span",{className:"text-gray-400 text-sm italic",children:n("companies.notSet")})}),e.jsx(Be,{translations:m})]})}function Ye(){const{companies:s,loading:t,error:m,createCompany:g,updateCompany:c,deleteCompany:y,searchCompanies:j,reload:x}=Te();xe.useEffect(()=>{s.length===0&&!t&&x()},[s.length,x,t]);const{profile:C,loading:r,error:i,updateProfile:o}=ze(),{organizationLogo:p}=ue(),{confirm:A,toastError:k}=he(),{i18n:ne,t:F}=Q(),{categories:_,getCompanyCategories:B,getAllCompanyCategories:K,assignCategoriesToCompany:X}=$e(),V=u.useMemo(()=>(_||[]).map(a=>`${a.id}:${a.name||""}`).join("|"),[_]),N=u.useMemo(()=>(s||[]).map(a=>`${a.id}`).join(","),[s]),[E,R]=u.useState(""),[I,G]=u.useState("nl"),[P,U]=u.useState("public"),[M,Y]=u.useState({}),[O,W]=u.useState([]),{editingId:f,editForm:b,setEditForm:L,isCreating:d,newCompanyForm:h,setNewCompanyForm:v,handleEdit:re,handleSave:oe,handleCancel:le,handleDelete:ie,handleCreate:ce,handleStartCreate:de,handleCancelCreate:Z}=Me({createCompany:g,updateCompany:c,deleteCompany:y,updateProfile:o,organizationLogo:p,confirm:A,toastError:k});u.useEffect(()=>{(async()=>{if(f&&f!=="organization"){const w=(await B(f)).map(S=>S.id);W(w)}else f||W([])})()},[f,V,B]),u.useEffect(()=>{const a=async()=>{if(s.length>0){const l=s.map(S=>S.id),w=await K(l);Y(w)}};P==="public"&&s.length>0&&a()},[P,s,N,V,K]);const ge=async()=>{if(await oe(),f&&f!=="organization"){const a=await X(f,O);if(!a.success)console.error("Failed to assign categories:",a.error),alert("Failed to save categories: "+a.error);else{const l=await B(f);Y(w=>({...w,[f]:l}))}}W([])},ee=()=>{le(),W([])},J=u.useMemo(()=>{const a=[];if(C&&a.push({...C,id:"organization",isOrganization:!0}),a.push(...s),!E)return a;const l=E.toLowerCase();return a.filter(w=>{var S;return(S=w.name)==null?void 0:S.toLowerCase().includes(l)})},[C,s,E]),me=t||r,ae=m||i;return me?e.jsx("div",{className:"p-4",children:n("companies.loadingData")}):ae?e.jsx("div",{className:"p-4 text-red-600",children:n("companies.errorWithMessage",{message:ae})}):e.jsxs("div",{className:"h-full flex flex-col p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{path:be,size:1,className:"text-gray-500"}),e.jsx("input",{type:"text",placeholder:n("companies.searchPlaceholder"),value:E,onChange:a=>R(a.target.value),className:"px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsxs("span",{className:"text-sm text-gray-600",children:[J.length," of ",s.length+1]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ke,{dataType:"companies",data:s,filename:`companies-${new Date().toISOString().split("T")[0]}`,additionalData:{supabase:H}}),e.jsx(Fe,{dataType:"companies",existingData:s,onImportComplete:async()=>{await x()}}),e.jsxs("button",{onClick:de,className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx($,{path:fe,size:.8}),n("companies.addCompany")]})]})]}),e.jsxs("div",{className:"flex gap-2 mb-4 border-b flex-shrink-0",children:[e.jsx("button",{onClick:()=>U("public"),className:`px-4 py-2 font-medium transition-colors ${P==="public"?"text-blue-600 border-b-2 border-blue-600":"text-gray-600 hover:text-gray-900"}`,children:F("companies.publicInfoTab")}),e.jsx("button",{onClick:()=>U("manager"),className:`px-4 py-2 font-medium transition-colors ${P==="manager"?"text-green-600 border-b-2 border-green-600":"text-gray-600 hover:text-gray-900"}`,children:F("companies.privateInfoTab")})]}),e.jsx(ye,{isOpen:d||!!f,onClose:d?Z:ee,title:d?n("companies.newCompany"):n("companies.modal.editTitle",{name:b.name||n("companies.newCompany")}),size:"lg",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-sm mb-3 text-blue-800",children:n("companies.modal.publicInfoHeading","Public Info (visible to attendees)")}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{type:"text",placeholder:n("companies.companyNamePlaceholder"),value:d?h.name:b.name,onChange:a=>d?v({...h,name:a.target.value}):L({...b,name:a.target.value}),className:"w-full px-3 py-2 border rounded bg-white text-gray-900"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1 text-gray-900",children:n("companies.companyLogo")}),e.jsx(De,{currentLogo:d?h.logo:b.logo,onUploadComplete:(a,l)=>{d?v({...h,logo:a}):L({...b,logo:a})},folder:f==="organization"?"organization":"companies",label:n("companies.modal.uploadLogo"),showPreview:!0,allowDelete:!0,onDelete:()=>{d?v({...h,logo:p}):L({...b,logo:p})}}),e.jsx("input",{type:"text",placeholder:n("companies.logoUrlPlaceholder"),value:d?h.logo:b.logo||"",onChange:a=>d?v({...h,logo:a.target.value}):L({...b,logo:a.target.value}),className:"w-full px-3 py-2 border rounded mt-2 text-sm bg-white text-gray-900"})]}),e.jsx("input",{type:"text",placeholder:n("companies.websiteUrlPlaceholder"),value:d?h.website:b.website||"",onChange:a=>d?v({...h,website:a.target.value}):L({...b,website:a.target.value}),className:"w-full px-3 py-2 border rounded bg-white text-gray-900"}),f==="organization"?e.jsx("textarea",{placeholder:n("companies.infoPlaceholder"),value:d?h.info:b.info||"",onChange:a=>d?v({...h,info:a.target.value}):L({...b,info:a.target.value}),className:"w-full px-3 py-2 border rounded bg-white text-gray-900",rows:3}):d?e.jsx("textarea",{placeholder:n("companies.infoPlaceholder"),value:h.info,onChange:a=>v({...h,info:a.target.value}),className:"w-full px-3 py-2 border rounded bg-white text-gray-900",rows:3}):e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1 text-gray-900",children:n("companies.modal.infoMultiLanguageLabel")}),e.jsx(Re,{companyId:f,editingLanguage:I,onLanguageChange:G})]}),!d&&f!=="organization"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2 text-gray-900",children:n("companies.modal.categoriesLabel")}),_.length>0?e.jsx("div",{className:"flex flex-col gap-1.5",children:_.map(a=>e.jsxs("label",{className:"inline-flex items-center gap-2 cursor-pointer px-2.5 py-1.5 rounded text-sm",style:{backgroundColor:O.includes(a.id)?a.color+"30":a.color+"15",color:a.color,border:`1px solid ${a.color}40`},children:[e.jsx("input",{type:"checkbox",checked:O.includes(a.id),onChange:l=>{const w=l.target.checked?[...O,a.id]:O.filter(S=>S!==a.id);W(w)},className:"cursor-pointer"}),a.icon&&e.jsx($,{path:a.icon,size:.6}),a.name]},a.id))}):e.jsx("span",{className:"text-red-500 text-sm italic",children:n("companies.noCategoriesAvailable")})]})]})]}),e.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-sm mb-3 text-green-800",children:n("companies.modal.managerInfoHeading","Manager-only Info (default contact info)")}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsx("input",{type:"text",placeholder:n("companies.contactPlaceholder"),value:d?h.contact||"":b.contact||"",onChange:a=>d?v({...h,contact:a.target.value}):L({...b,contact:a.target.value}),className:"px-3 py-2 border rounded bg-white text-gray-900"}),e.jsx(Ie,{value:d?h.phone||"":b.phone||"",onChange:a=>d?v({...h,phone:a}):L({...b,phone:a}),placeholder:n("companies.phonePlaceholder")}),e.jsx("input",{type:"email",placeholder:n("companies.emailPlaceholder"),value:d?h.email||"":b.email||"",onChange:a=>{const l=a.target.value.toLowerCase();d?v({...h,email:l}):L({...b,email:l})},className:"px-3 py-2 border rounded bg-white text-gray-900"})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6 justify-end",children:[e.jsx("button",{onClick:d?Z:ee,className:"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300",children:F("cancel")}),e.jsx("button",{onClick:d?ce:ge,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:F(d?"companies.create":"save")})]})]})}),e.jsxs("div",{className:"flex-1 overflow-auto border rounded-lg",children:[e.jsxs("table",{className:"w-full rounded",style:{tableLayout:"fixed",fontSize:"11px"},children:[e.jsx("thead",{className:"sticky top-0 z-10",children:e.jsxs("tr",{children:[P==="public"?e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"p-2 text-left bg-blue-100 border-b text-gray-900",children:n("companies.table.name")}),e.jsx("th",{className:"p-2 text-left bg-blue-100 border-b text-gray-900",children:n("companies.table.logo")}),e.jsx("th",{className:"p-2 text-left bg-blue-100 border-b text-gray-900",children:n("companies.table.website")}),e.jsx("th",{className:"p-2 text-left bg-blue-100 border-b text-gray-900",children:n("companies.table.info")}),e.jsx("th",{className:"p-2 text-left bg-blue-100 border-b text-gray-900",children:n("companies.table.categories")})]}):e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"p-2 text-left bg-green-100 border-b text-gray-900",children:n("companies.table.name")}),e.jsx("th",{className:"p-2 text-left bg-green-100 border-b text-gray-900",children:n("companies.table.contact")}),e.jsx("th",{className:"p-2 text-left bg-green-100 border-b text-gray-900",children:n("companies.table.phone")}),e.jsx("th",{className:"p-2 text-left bg-green-100 border-b text-gray-900",children:n("companies.table.email")})]}),e.jsx("th",{className:"p-2 bg-gray-100 border-b font-semibold text-gray-900",style:{minWidth:"90px",width:"90px",maxWidth:"120px"},children:n("companies.table.actions")})]})}),e.jsx("tbody",{children:J.map(a=>{const l=a.isOrganization,w=l?"bg-gray-700 text-white":"bg-white text-gray-900 hover:bg-gray-50",S=P==="public"?"bg-blue-50":"bg-green-50";return e.jsxs("tr",{className:`${w} border-b`,children:[e.jsx("td",{className:`py-2 px-3 border-b text-left ${l?"":S}`,children:e.jsx("span",{className:"font-semibold",children:a.name})}),P==="public"?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:`py-2 px-3 border-b text-left ${l?"":"bg-blue-50"}`,children:e.jsx("img",{...(()=>{const T=je(),te=l?T:a.logo&&a.logo.trim()!==""?a.logo:T,q=Ce(te);return q?{src:q.src,srcSet:q.srcSet,sizes:q.sizes}:{src:Ne(te)}})(),alt:a.name,className:"h-8 object-contain"})}),e.jsx("td",{className:`py-2 px-3 border-b text-left ${l?"":"bg-blue-50"}`,children:a.website?e.jsx("a",{href:a.website.startsWith("http")?a.website:`https://${a.website}`,target:"_blank",rel:"noopener noreferrer",className:l?"text-blue-300 hover:underline":"text-blue-600 hover:underline",children:a.website.replace(/^https?:\/\//,"").substring(0,30)}):e.jsx("span",{className:"text-gray-400 text-sm italic",children:n("companies.notSet")})}),e.jsx("td",{className:`py-2 px-3 border-b text-left max-w-xs ${l?"":"bg-blue-50"}`,children:l?e.jsx("p",{className:"line-clamp-3 whitespace-pre-wrap",children:a.info||e.jsx("span",{className:"text-gray-400 text-sm italic",children:n("companies.notSet")})}):e.jsx(Ue,{companyId:a.id,currentLanguage:f===a.id?z.language:"nl"})}),e.jsx("td",{className:`py-2 px-3 border-b text-left ${l?"":"bg-blue-50"}`,children:l?e.jsx("span",{className:"text-gray-400 text-xs italic",children:n("companies.notApplicable")}):e.jsxs("div",{className:"flex flex-wrap gap-1",children:[(M[a.id]||[]).map(T=>e.jsxs("span",{className:"text-xs px-1.5 py-0.5 rounded inline-flex items-center gap-1",style:{backgroundColor:T.color+"20",color:T.color},children:[T.icon&&e.jsx($,{path:T.icon,size:.5}),T.name]},T.id)),(!M[a.id]||M[a.id].length===0)&&e.jsx("span",{className:"text-gray-400 text-xs italic",children:n("companies.none")})]})})]}):e.jsxs(e.Fragment,{children:[e.jsx("td",{className:`py-2 px-3 border-b text-left ${l?"":"bg-green-50"}`,children:e.jsx("span",{className:"text-xs",children:a.contact||e.jsx("span",{className:"text-gray-400 italic",children:n("companies.notSet")})})}),e.jsx("td",{className:`py-2 px-3 border-b text-left ${l?"":"bg-green-50"}`,children:a.phone?e.jsxs("span",{className:"text-xs flex items-center gap-1",children:[e.jsx("span",{children:Ae(a.phone)}),e.jsx("span",{children:_e(a.phone)})]}):e.jsx("span",{className:"text-gray-400 italic text-xs",children:n("companies.notSet")})}),e.jsx("td",{className:`py-2 px-3 border-b text-left ${l?"":"bg-green-50"}`,children:e.jsx("span",{className:"text-xs",children:a.email||e.jsx("span",{className:"text-gray-400 italic",children:n("companies.notSet")})})})]}),e.jsx("td",{className:"py-2 px-3 border-b text-left",children:e.jsxs("div",{className:"flex gap-1 justify-center",children:[e.jsx("button",{onClick:()=>re(a),className:"p-1.5 bg-blue-600 text-white rounded hover:bg-blue-700",title:n("companies.edit"),children:e.jsx($,{path:we,size:.8})}),!l&&e.jsx("button",{onClick:()=>ie(a.id,a.name),className:"p-1.5 bg-red-600 text-white rounded hover:bg-red-700",title:n("companies.delete"),children:e.jsx($,{path:ve,size:.8})}),l&&e.jsx("div",{className:"flex items-center justify-center pt-1 text-gray-300",children:e.jsx($,{path:Se,size:.8})})]})})]},a.id)})})]}),J.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:n(E?"companies.noResults":"companies.noCompanies")})]})]})}export{Ye as default};
