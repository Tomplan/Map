import{r as l,j as e,I,c as le}from"./vendor-react-600751b5.js";import{u as ie}from"./useCompanies-f212f302.js";import{s as L,u as ce,i as de,M as ge,g as pe,a as xe,b as me}from"./index-c9551a19.js";import{n as he}from"./phone-fab9ac3a.js";import{u as ue}from"./useCategories-e5851c15.js";import{aY as be,ak as fe,aZ as ye,a_ as je,a$ as Ne,aF as Ce}from"./vendor-57b332a3.js";import{L as we}from"./LogoUploader-4899a986.js";import{E as ve,I as Pe,P as Ee,g as Se,f as ze}from"./ImportButton-0f514934.js";import"./vendor-i18n-2e1fa53c.js";import"./vendor-supabase-a724a182.js";import"./vendor-map-53abdaff.js";import"./dataExportImport-1463487f.js";function ke(){const[s,r]=l.useState(null),[d,u]=l.useState(!0),[i,y]=l.useState(null),p=l.useCallback(async()=>{try{u(!0);const{data:a,error:c}=await L.from("organization_profile").select("*").single();if(c)if(c.code==="PGRST116")console.warn("No organization profile found. A default one should be created by the migration."),r(null);else throw c;r(a),y(null)}catch(a){console.error("Error fetching organization profile:",a),y(a.message)}finally{u(!1)}},[]);return l.useEffect(()=>{p();const a=L.channel("public:organization_profile").on("postgres_changes",{event:"*",schema:"public",table:"organization_profile",filter:"id=eq.1"},c=>{c.new&&r(c.new)}).subscribe();return()=>{L.removeChannel(a)}},[p]),{profile:s,loading:d,error:i,updateProfile:async a=>{try{(a!=null&&a.phone||(a==null?void 0:a.phone)==="")&&(a.phone=he(a.phone)),a!=null&&a.email&&(a.email=a.email.toLowerCase().trim());const{data:c,error:j}=await L.from("organization_profile").update(a).eq("id",1).select().single();if(j)throw j;return r(c),{data:c,error:null}}catch(c){return console.error("Error updating organization profile:",c),{data:null,error:c.message}}}}}function Te({createCompany:s,updateCompany:r,deleteCompany:d,updateProfile:u,organizationLogo:i,confirm:y,toastError:p}){const[C,a]=l.useState(null),[c,j]=l.useState({}),[D,g]=l.useState(!1),[x,b]=l.useState({name:"",logo:i||"",website:"",info:""});return{editingId:C,editForm:c,setEditForm:j,isCreating:D,newCompanyForm:x,setNewCompanyForm:b,handleEdit:w=>{a(w.id),j({...w})},handleSave:async()=>{const w=C;if(w==="organization"){const{name:F,logo:W,website:v,info:q,contact:A,phone:U,email:$}=c;await u({name:F,logo:W,website:v,info:q,contact:A,phone:U,email:$})}else await r(w,c);a(null),j({})},handleCancel:()=>{a(null),j({})},handleDelete:async(w,F)=>{if(!await y({title:"Delete Company",message:`Are you sure you want to delete "${F}"? This will also delete all assignments for this company.`,confirmText:"Delete",variant:"danger"}))return;const{error:v}=await d(w);v&&p(`Error deleting company: ${v}`)},handleCreate:async()=>{if(!x.name.trim()){p("Company name is required");return}const{error:w}=await s(x);w?p(`Error creating company: ${w}`):(g(!1),b({name:"",logo:i,website:"",info:""}))},handleStartCreate:()=>{g(!0),b({name:"",logo:i,website:"",info:""})},handleCancelCreate:()=>{g(!1),b({name:"",logo:i,website:"",info:""})}}}function Q(s){const[r,d]=l.useState({}),[u,i]=l.useState(!1),[y,p]=l.useState(null),C=l.useCallback(async()=>{if(!s){d({});return}try{i(!0),p(null);const{data:g,error:x}=await L.from("company_translations").select("language_code, info").eq("company_id",s);if(x)throw x;const b={};(g||[]).forEach(E=>{b[E.language_code]=E.info}),d(b)}catch(g){console.error("Error loading translations:",g),p(g.message)}finally{i(!1)}},[s]),a=async(g,x)=>{if(s)try{p(null);const{error:b}=await L.from("company_translations").upsert({company_id:s,language_code:g,info:x,updated_at:new Date().toISOString()},{onConflict:"company_id,language_code"});if(b)throw b;return d(E=>({...E,[g]:x})),!0}catch(b){return console.error("Error saving translation:",b),p(b.message),!1}},c=async g=>{if(s)try{p(null);const{error:x}=await L.from("company_translations").delete().eq("company_id",s).eq("language_code",g);if(x)throw x;return d(b=>{const E={...b};return delete E[g],E}),!0}catch(x){return console.error("Error deleting translation:",x),p(x.message),!1}},j=(g,x="nl")=>r[g]||r[x]||"",D=()=>Object.keys(r);return l.useEffect(()=>{C()},[C]),{translations:r,loading:u,error:y,saveTranslation:a,deleteTranslation:c,getTranslation:j,getAvailableLanguages:D,reload:C}}const Ie=[{code:"nl",label:"Nederlands",flag:"ðŸ‡³ðŸ‡±"},{code:"en",label:"English",flag:"ðŸ‡¬ðŸ‡§"},{code:"de",label:"Deutsch",flag:"ðŸ‡©ðŸ‡ª"}];function Le({currentLanguage:s,onLanguageChange:r,translations:d={},className:u=""}){return e.jsx("div",{className:`flex items-center gap-1 ${u}`,children:Ie.map(i=>{const y=s===i.code,p=d[i.code]&&d[i.code].trim()!=="";return e.jsxs("button",{type:"button",onClick:()=>r(i.code),className:`px-2 py-1 rounded text-xs font-medium transition flex items-center gap-1 ${y?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx("span",{children:i.flag}),e.jsx("span",{children:i.label}),p&&!y&&e.jsx(I,{path:be,size:.5,className:"text-green-600"})]},i.code)})})}function $e({translations:s={}}){const r=Object.keys(s).filter(d=>s[d]&&s[d].trim()!=="").length;return r<=1?null:e.jsx("span",{className:"inline-block ml-1 text-blue-600",title:`Available in ${r} languages`,children:"ðŸŒ"})}function _e({companyId:s,editingLanguage:r,onLanguageChange:d}){const{translations:u,saveTranslation:i}=Q(s),[y,p]=l.useState(""),[C,a]=l.useState(!1);l.useEffect(()=>{p(u[r]||"")},[r,u]);const c=async()=>{if(y!==(u[r]||"")){a(!0);try{await i(r,y)}catch(j){console.error("Failed to save translation:",j)}finally{a(!1)}}};return e.jsxs("div",{className:"space-y-2",children:[e.jsx(Le,{currentLanguage:r,onLanguageChange:d,translations:u,className:"mb-2"}),e.jsx("textarea",{value:y,onChange:j=>p(j.target.value),onBlur:c,className:"w-full bg-white text-gray-900 border rounded px-2 py-1",rows:4,placeholder:`Enter info in ${r==="nl"?"Dutch":"English"}...`,disabled:C}),C&&e.jsx("span",{className:"text-xs text-gray-500 italic",children:"Saving..."})]})}function De({companyId:s,currentLanguage:r}){const{translations:d,getTranslation:u}=Q(s),i=u(r,"nl");return e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("p",{className:"line-clamp-3 whitespace-pre-wrap flex-1",children:i||e.jsx("span",{className:"text-gray-400 text-sm italic",children:"Not set"})}),e.jsx($e,{translations:d})]})}function Ze(){const{companies:s,loading:r,error:d,createCompany:u,updateCompany:i,deleteCompany:y,searchCompanies:p,reload:C}=ie(),{profile:a,loading:c,error:j,updateProfile:D}=ke(),{organizationLogo:g}=ce(),{confirm:x,toastError:b}=de(),{i18n:E,t:N}=le(),{categories:R,getCompanyCategories:M,getAllCompanyCategories:G,assignCategoriesToCompany:Y}=ue(),[_,w]=l.useState(""),[F,W]=l.useState("nl"),[v,q]=l.useState("public"),[A,U]=l.useState({}),[$,O]=l.useState([]),{editingId:f,editForm:h,setEditForm:k,isCreating:o,newCompanyForm:m,setNewCompanyForm:S,handleEdit:X,handleSave:ee,handleCancel:te,handleDelete:ae,handleCreate:se,handleStartCreate:ne,handleCancelCreate:Z}=Te({createCompany:u,updateCompany:i,deleteCompany:y,updateProfile:D,organizationLogo:g,confirm:x,toastError:b});l.useEffect(()=>{(async()=>{if(f&&f!=="organization"){const P=(await M(f)).map(z=>z.id);O(P)}else f||O([])})()},[f,M]),l.useEffect(()=>{const t=async()=>{if(s.length>0){const n=s.map(z=>z.id),P=await G(n);U(P)}};v==="public"&&s.length>0&&t()},[v,s.length,s,G]);const re=async()=>{if(await ee(),f&&f!=="organization"){const t=await Y(f,$);if(!t.success)console.error("Failed to assign categories:",t.error),alert("Failed to save categories: "+t.error);else{const n=await M(f);U(P=>({...P,[f]:n}))}}O([])},H=()=>{te(),O([])},V=l.useMemo(()=>{const t=[];if(a&&t.push({...a,id:"organization",isOrganization:!0}),t.push(...s),!_)return t;const n=_.toLowerCase();return t.filter(P=>{var z;return(z=P.name)==null?void 0:z.toLowerCase().includes(n)})},[a,s,_]),oe=r||c,J=d||j;return oe?e.jsx("div",{className:"p-4",children:"Loading data..."}):J?e.jsxs("div",{className:"p-4 text-red-600",children:["Error: ",J]}):e.jsxs("div",{className:"h-full flex flex-col p-4","data-testid":"companies-container",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{path:fe,size:1,className:"text-gray-500"}),e.jsx("input",{type:"text",placeholder:N("helpPanel.companies.searchPlaceholder"),value:_,onChange:t=>w(t.target.value),className:"px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsxs("span",{className:"text-sm text-gray-600",children:[V.length," of ",s.length+1]})]}),e.jsxs("div",{className:"flex gap-2","data-testid":"import-export-buttons",children:[e.jsx(ve,{dataType:"companies",data:s,filename:`companies-${new Date().toISOString().split("T")[0]}`,additionalData:{supabase:L}}),e.jsx(Pe,{dataType:"companies",existingData:s,onImportComplete:async()=>{await C()}}),e.jsxs("button",{onClick:ne,"data-testid":"add-company-button",className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(I,{path:ye,size:.8}),N("helpPanel.companies.addCompany")]})]})]}),e.jsxs("div",{className:"flex gap-2 mb-4 border-b flex-shrink-0",children:[e.jsx("button",{onClick:()=>q("public"),"data-testid":"public-info-tab",className:`px-4 py-2 font-medium transition-colors ${v==="public"?"text-blue-600 border-b-2 border-blue-600":"text-gray-600 hover:text-gray-900"}`,children:N("helpPanel.companies.publicInfoTab","Public Info")}),e.jsx("button",{onClick:()=>q("manager"),"data-testid":"private-info-tab",className:`px-4 py-2 font-medium transition-colors ${v==="manager"?"text-green-600 border-b-2 border-green-600":"text-gray-600 hover:text-gray-900"}`,children:N("helpPanel.companies.privateInfoTab","Private Info")})]}),e.jsx(ge,{isOpen:o||!!f,onClose:o?Z:H,title:o?N("helpPanel.companies.newCompany"):`Edit: ${h.name||"Company"}`,size:"lg",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-sm mb-3 text-blue-800",children:"Public Info (visible to attendees)"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{type:"text",placeholder:N("helpPanel.companies.companyNamePlaceholder"),value:o?m.name:h.name,onChange:t=>o?S({...m,name:t.target.value}):k({...h,name:t.target.value}),className:"w-full px-3 py-2 border rounded bg-white text-gray-900"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1 text-gray-900",children:N("helpPanel.companies.companyLogo")}),e.jsx(we,{currentLogo:o?m.logo:h.logo,onUploadComplete:(t,n)=>{o?S({...m,logo:t}):k({...h,logo:t})},folder:f==="organization"?"organization":"companies",label:"Upload Logo",showPreview:!0,allowDelete:!0,onDelete:()=>{o?S({...m,logo:g}):k({...h,logo:g})}}),e.jsx("input",{type:"text",placeholder:N("helpPanel.companies.logoUrlPlaceholder"),value:o?m.logo:h.logo||"",onChange:t=>o?S({...m,logo:t.target.value}):k({...h,logo:t.target.value}),className:"w-full px-3 py-2 border rounded mt-2 text-sm bg-white text-gray-900"})]}),e.jsx("input",{type:"text",placeholder:"Website URL",value:o?m.website:h.website||"",onChange:t=>o?S({...m,website:t.target.value}):k({...h,website:t.target.value}),className:"w-full px-3 py-2 border rounded bg-white text-gray-900"}),f==="organization"?e.jsx("textarea",{placeholder:N("helpPanel.companies.infoPlaceholder"),value:o?m.info:h.info||"",onChange:t=>o?S({...m,info:t.target.value}):k({...h,info:t.target.value}),className:"w-full px-3 py-2 border rounded bg-white text-gray-900",rows:3}):o?e.jsx("textarea",{placeholder:N("helpPanel.companies.infoPlaceholder"),value:m.info,onChange:t=>S({...m,info:t.target.value}),className:"w-full px-3 py-2 border rounded bg-white text-gray-900",rows:3}):e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1 text-gray-900",children:"Info (Multi-language)"}),e.jsx(_e,{companyId:f,editingLanguage:F,onLanguageChange:W})]}),!o&&f!=="organization"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2 text-gray-900",children:"Categories"}),R.length>0?e.jsx("div",{className:"flex flex-col gap-1.5",children:R.map(t=>e.jsxs("label",{className:"inline-flex items-center gap-2 cursor-pointer px-2.5 py-1.5 rounded text-sm",style:{backgroundColor:$.includes(t.id)?t.color+"30":t.color+"15",color:t.color,border:`1px solid ${t.color}40`},children:[e.jsx("input",{type:"checkbox",checked:$.includes(t.id),onChange:n=>{const P=n.target.checked?[...$,t.id]:$.filter(z=>z!==t.id);O(P)},className:"cursor-pointer"}),t.icon&&e.jsx(I,{path:t.icon,size:.6}),t.name]},t.id))}):e.jsx("span",{className:"text-red-500 text-sm italic",children:"No categories available"})]})]})]}),e.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-sm mb-3 text-green-800",children:"Manager-Only Info (default contact info)"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsx("input",{type:"text",placeholder:"Contact Person",value:o?m.contact||"":h.contact||"",onChange:t=>o?S({...m,contact:t.target.value}):k({...h,contact:t.target.value}),className:"px-3 py-2 border rounded bg-white text-gray-900"}),e.jsx(Ee,{value:o?m.phone||"":h.phone||"",onChange:t=>o?S({...m,phone:t}):k({...h,phone:t}),placeholder:"Phone (e.g., +31612345678)"}),e.jsx("input",{type:"email",placeholder:"Email",value:o?m.email||"":h.email||"",onChange:t=>{const n=t.target.value.toLowerCase();o?S({...m,email:n}):k({...h,email:n})},className:"px-3 py-2 border rounded bg-white text-gray-900"})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6 justify-end",children:[e.jsx("button",{onClick:o?Z:H,className:"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300",children:"Cancel"}),e.jsx("button",{onClick:o?se:re,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:o?"Create":"Save"})]})]})}),e.jsxs("div",{className:"flex-1 overflow-auto border rounded-lg",children:[e.jsxs("table",{className:"w-full rounded",style:{tableLayout:"fixed",fontSize:"11px"},children:[e.jsx("thead",{className:"sticky top-0 z-10",children:e.jsxs("tr",{children:[v==="public"?e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"p-2 text-left bg-blue-100 border-b text-gray-900",children:"Name"}),e.jsx("th",{className:"p-2 text-left bg-blue-100 border-b text-gray-900",children:"Logo"}),e.jsx("th",{className:"p-2 text-left bg-blue-100 border-b text-gray-900",children:"Website"}),e.jsx("th",{className:"p-2 text-left bg-blue-100 border-b text-gray-900",children:"Info"}),e.jsx("th",{className:"p-2 text-left bg-blue-100 border-b text-gray-900",children:"Categories"})]}):e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"p-2 text-left bg-green-100 border-b text-gray-900",children:"Name"}),e.jsx("th",{className:"p-2 text-left bg-green-100 border-b text-gray-900",children:"Contact"}),e.jsx("th",{className:"p-2 text-left bg-green-100 border-b text-gray-900",children:"Phone"}),e.jsx("th",{className:"p-2 text-left bg-green-100 border-b text-gray-900",children:"Email"})]}),e.jsx("th",{className:"p-2 bg-gray-100 border-b font-semibold text-gray-900",style:{minWidth:"90px",width:"90px",maxWidth:"120px"},children:"Actions"})]})}),e.jsx("tbody",{children:V.map(t=>{const n=t.isOrganization,P=n?"bg-gray-700 text-white":"bg-white text-gray-900 hover:bg-gray-50",z=v==="public"?"bg-blue-50":"bg-green-50";return e.jsxs("tr",{className:`${P} border-b`,children:[e.jsx("td",{className:`py-2 px-3 border-b text-left ${n?"":z}`,children:e.jsx("span",{className:"font-semibold",children:t.name})}),v==="public"?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:`py-2 px-3 border-b text-left ${n?"":"bg-blue-50"}`,children:e.jsx("img",{...(()=>{const T=pe(),K=n?T:t.logo&&t.logo.trim()!==""?t.logo:T,B=xe(K);return B?{src:B.src,srcSet:B.srcSet,sizes:B.sizes}:{src:me(K)}})(),alt:t.name,className:"h-8 object-contain"})}),e.jsx("td",{className:`py-2 px-3 border-b text-left ${n?"":"bg-blue-50"}`,children:t.website?e.jsx("a",{href:t.website.startsWith("http")?t.website:`https://${t.website}`,target:"_blank",rel:"noopener noreferrer",className:n?"text-blue-300 hover:underline":"text-blue-600 hover:underline",children:t.website.replace(/^https?:\/\//,"").substring(0,30)}):e.jsx("span",{className:"text-gray-400 text-sm italic",children:"Not set"})}),e.jsx("td",{className:`py-2 px-3 border-b text-left max-w-xs ${n?"":"bg-blue-50"}`,children:n?e.jsx("p",{className:"line-clamp-3 whitespace-pre-wrap",children:t.info||e.jsx("span",{className:"text-gray-400 text-sm italic",children:"Not set"})}):e.jsx(De,{companyId:t.id,currentLanguage:f===t.id?E.language:"nl"})}),e.jsx("td",{className:`py-2 px-3 border-b text-left ${n?"":"bg-blue-50"}`,children:n?e.jsx("span",{className:"text-gray-400 text-xs italic",children:"N/A"}):e.jsxs("div",{className:"flex flex-wrap gap-1",children:[(A[t.id]||[]).map(T=>e.jsxs("span",{className:"text-xs px-1.5 py-0.5 rounded inline-flex items-center gap-1",style:{backgroundColor:T.color+"20",color:T.color},children:[T.icon&&e.jsx(I,{path:T.icon,size:.5}),T.name]},T.id)),(!A[t.id]||A[t.id].length===0)&&e.jsx("span",{className:"text-gray-400 text-xs italic",children:"None"})]})})]}):e.jsxs(e.Fragment,{children:[e.jsx("td",{className:`py-2 px-3 border-b text-left ${n?"":"bg-green-50"}`,children:e.jsx("span",{className:"text-xs",children:t.contact||e.jsx("span",{className:"text-gray-400 italic",children:"Not set"})})}),e.jsx("td",{className:`py-2 px-3 border-b text-left ${n?"":"bg-green-50"}`,children:t.phone?e.jsxs("span",{className:"text-xs flex items-center gap-1",children:[e.jsx("span",{children:Se(t.phone)}),e.jsx("span",{children:ze(t.phone)})]}):e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Not set"})}),e.jsx("td",{className:`py-2 px-3 border-b text-left ${n?"":"bg-green-50"}`,children:e.jsx("span",{className:"text-xs",children:t.email||e.jsx("span",{className:"text-gray-400 italic",children:"Not set"})})})]}),e.jsx("td",{className:"py-2 px-3 border-b text-left",children:e.jsxs("div",{className:"flex gap-1 justify-center",children:[e.jsx("button",{onClick:()=>X(t),className:"p-1.5 bg-blue-600 text-white rounded hover:bg-blue-700",title:"Edit",children:e.jsx(I,{path:je,size:.8})}),!n&&e.jsx("button",{onClick:()=>ae(t.id,t.name),className:"p-1.5 bg-red-600 text-white rounded hover:bg-red-700",title:"Delete",children:e.jsx(I,{path:Ne,size:.8})}),n&&e.jsx("div",{className:"flex items-center justify-center pt-1 text-gray-300",children:e.jsx(I,{path:Ce,size:.8})})]})})]},t.id)})})]}),V.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:N(_?"helpPanel.companies.noResults":"helpPanel.companies.noCompanies")})]})]})}export{Ze as default};
