import{u as ce,b as ie,r as i,a2 as xe,j as e,I as h,m as de,a3 as he,a4 as pe,al as be,ak as q,h as F,d as U,e as G,g as me,am as ue,an as ge}from"./index-8fb29835.js";import{u as ye}from"./useEventSubscriptions-b8d1b708.js";import{u as fe}from"./useCompanies-f1922231.js";import{u as je}from"./useAssignments-e32be150.js";import{u as Ne}from"./useMarkerGlyphs-1df7a866.js";import{P as ve,g as we,f as Ce}from"./PhoneInput-bf048d47.js";import"./phone-376c158e.js";function Ie({selectedYear:l}){const{t:o}=ce(),{organizationLogo:W}=ie(),{subscriptions:g,loading:O,error:E,subscribeCompany:R,updateSubscription:V,unsubscribeCompany:H,archiveCurrentYear:J,copyFromPreviousYear:K}=ye(l),{companies:$}=fe(),{assignments:z}=je(l),{markers:A,loading:_e}=Ne(l),[y,Q]=i.useState(""),[X,C]=i.useState(null),[n,x]=i.useState({}),[Z,_]=i.useState(!1),[S,k]=i.useState(""),[b,Y]=i.useState("company"),[f,I]=i.useState("asc"),{confirm:P,toastError:w,toastSuccess:L,toastWarning:ee}=xe(),T=i.useMemo(()=>{const t=new Set(g.map(s=>s.company_id));return $.filter(s=>!t.has(s.id))},[$,g]),M=i.useMemo(()=>{const t={};return z.forEach(s=>{t[s.company_id]||(t[s.company_id]=[]),t[s.company_id].push(s)}),t},[z]),B=i.useMemo(()=>{const t={};return A.forEach(s=>{t[s.id]=s.glyph}),t},[A]),j=i.useCallback(t=>{const s=M[t]||[];if(s.length===0)return"-";const r=s.sort((c,a)=>c.marker_id-a.marker_id).map(c=>B[c.marker_id]||c.marker_id.toString()).filter(Boolean);return r.length>0?r.join(", "):"-"},[M,B]),N=i.useMemo(()=>{let t=g;if(y){const r=y.toLowerCase();t=t.filter(c=>{var a,d;return(d=(a=c.company)==null?void 0:a.name)==null?void 0:d.toLowerCase().includes(r)})}return[...t].sort((r,c)=>{var d,v;let a=0;if(b==="company"){const m=(((d=r.company)==null?void 0:d.name)||"").toLowerCase(),u=(((v=c.company)==null?void 0:v.name)||"").toLowerCase();a=m.localeCompare(u)}else if(b==="booths"){const m=j(r.company_id),u=j(c.company_id);if(m==="-"&&u!=="-")return 1;if(m!=="-"&&u==="-")return-1;if(m==="-"&&u==="-")return 0;a=m.localeCompare(u,void 0,{numeric:!0})}return f==="asc"?a:-a})},[g,y,b,f,j]),p=i.useMemo(()=>N.reduce((t,s)=>(t.booth_count+=s.booth_count||0,t.breakfast_sat+=s.breakfast_sat||0,t.lunch_sat+=s.lunch_sat||0,t.bbq_sat+=s.bbq_sat||0,t.breakfast_sun+=s.breakfast_sun||0,t.lunch_sun+=s.lunch_sun||0,t.coins+=s.coins||0,t),{booth_count:0,breakfast_sat:0,lunch_sat:0,bbq_sat:0,breakfast_sun:0,lunch_sun:0,coins:0}),[N]),te=t=>{C(t.id),x({...t})},se=async()=>{const{id:t,company:s,...r}=n;await V(t,r),C(null),x({})},ae=()=>{C(null),x({})},re=async t=>{var v;const s=((v=t.company)==null?void 0:v.name)||"this company",r=j(t.company_id),c=r?` and their booth assignments (${r})`:"";if(!await P({title:"Unsubscribe Company",message:`Unsubscribe ${s} from ${l}? This will delete their subscription${c}.`,confirmText:"Unsubscribe",variant:"danger"}))return;const{error:d}=await H(t.id);d&&w(`Error unsubscribing company: ${d}`)},ne=async()=>{if(!S){ee("Please select a company");return}const{error:t}=await R(parseInt(S));t?w(`Error subscribing company: ${t}`):(_(!1),k(""))},oe=async()=>{if(!await P({title:"Archive Subscriptions",message:`Archive all subscriptions for ${l}? This will move them to the archive and clear the active list.`,confirmText:"Archive",variant:"warning"}))return;const{data:s,error:r}=await J();r?w(`Error archiving: ${r}`):L(`Archived ${s} subscriptions for ${l}`)},le=async()=>{const t=l-1;if(!await P({title:"Copy Subscriptions",message:`Copy all subscriptions from ${t} to ${l}?`,confirmText:"Copy",variant:"default"}))return;const{error:r}=await K(t);r?w(`Error copying subscriptions: ${r}`):L(`Subscriptions copied from ${t} to ${l}`)},D=t=>{b===t?I(f==="asc"?"desc":"asc"):(Y(t),I("asc"))};return O?e.jsx("div",{className:"p-4",children:"Loading subscriptions..."}):E?e.jsxs("div",{className:"p-4 text-red-600",children:["Error: ",E]}):e.jsxs("div",{className:"h-full flex flex-col p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{path:de,size:1,className:"text-gray-500"}),e.jsx("input",{type:"text",placeholder:o("helpPanel.subscriptions.searchPlaceholder"),value:y,onChange:t=>Q(t.target.value),className:"px-3 py-2 border rounded-lg"}),e.jsxs("span",{className:"text-sm text-gray-600",children:[N.length," of ",g.length]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:le,className:"flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700",title:`Copy from ${l-1}`,children:[e.jsx(h,{path:he,size:.8}),"Copy from ",l-1]}),e.jsxs("button",{onClick:oe,className:"flex items-center gap-2 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700",children:[e.jsx(h,{path:pe,size:.8}),"Archive ",l]}),e.jsxs("button",{onClick:()=>_(!0),className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[e.jsx(h,{path:be,size:.8}),"Subscribe Company"]})]})]}),Z&&e.jsxs("div",{className:"mb-4 p-4 border rounded-lg bg-blue-50 flex-shrink-0",children:[e.jsxs("h3",{className:"font-bold mb-3",children:["Subscribe Company to ",l]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("select",{value:S,onChange:t=>k(t.target.value),className:"flex-1 px-3 py-2 border rounded",children:[e.jsx("option",{value:"",children:"Select a company..."}),T.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("button",{onClick:ne,className:"flex items-center gap-1 px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700",children:[e.jsx(h,{path:q,size:.7}),"Subscribe"]}),e.jsxs("button",{onClick:()=>{_(!1),k("")},className:"flex items-center gap-1 px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600",children:[e.jsx(h,{path:F,size:.7}),"Cancel"]})]}),T.length===0&&e.jsxs("p",{className:"text-sm text-gray-600 mt-2",children:["All companies are already subscribed to ",l]})]}),e.jsxs("div",{className:"flex-1 overflow-auto border rounded-lg",children:[e.jsxs("table",{className:"w-full",style:{fontSize:"11px"},children:[e.jsxs("thead",{className:"bg-gray-100 text-gray-900 sticky top-0 z-10",children:[e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left border-b cursor-pointer hover:bg-gray-200 select-none bg-gray-100",onClick:()=>D("booths"),title:"Click to sort by booth labels",rowSpan:3,children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{children:"Booths"}),b==="booths"&&e.jsx(h,{path:f==="asc"?U:G,size:.6,className:"text-blue-600"})]})}),e.jsx("th",{className:"p-2 text-left border-b cursor-pointer hover:bg-gray-200 select-none bg-gray-100",onClick:()=>D("company"),title:"Click to sort by company name",rowSpan:3,children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{children:"Company"}),b==="company"&&e.jsx(h,{path:f==="asc"?U:G,size:.6,className:"text-blue-600"})]})}),e.jsx("th",{className:"p-2 text-left border-b bg-gray-100",rowSpan:3,children:o("helpPanel.subscriptions.contact")}),e.jsx("th",{className:"p-2 text-left border-b bg-gray-100",rowSpan:3,children:o("helpPanel.subscriptions.phone")}),e.jsx("th",{className:"p-2 text-left border-b bg-gray-100",rowSpan:3,children:o("helpPanel.subscriptions.email")}),e.jsx("th",{className:"p-2 text-center border-b bg-gray-100",children:o("helpPanel.subscriptions.boothCount")}),e.jsx("th",{className:"p-2 text-left border-b bg-gray-100",rowSpan:3,children:o("helpPanel.subscriptions.area")}),e.jsx("th",{className:"p-2 text-center border-b bg-blue-50",colSpan:3,children:e.jsx("span",{className:"font-bold text-blue-700",children:o("helpPanel.subscriptions.saturday")})}),e.jsx("th",{className:"p-2 text-center border-b bg-gray-100",colSpan:2,children:e.jsx("span",{className:"font-bold text-green-700",children:o("helpPanel.subscriptions.sunday")})}),e.jsx("th",{className:"p-2 text-center border-b bg-gray-100",children:o("helpPanel.subscriptions.coins")}),e.jsx("th",{className:"p-2 text-left border-b bg-gray-100",rowSpan:3,children:o("helpPanel.subscriptions.notes")}),e.jsx("th",{className:"p-2 text-center border-b bg-gray-100",rowSpan:3,style:{minWidth:"80px"},children:o("helpPanel.subscriptions.actions")})]}),e.jsxs("tr",{children:[e.jsx("th",{className:"p-1 text-center border-b bg-gray-100 text-xs",style:{width:"60px"}}),e.jsx("th",{className:"p-1 text-center border-b bg-blue-50 text-xs",style:{width:"60px"},children:o("helpPanel.subscriptions.breakfast")}),e.jsx("th",{className:"p-1 text-center border-b bg-blue-50 text-xs",style:{width:"60px"},children:o("helpPanel.subscriptions.lunch")}),e.jsx("th",{className:"p-1 text-center border-b bg-blue-50 text-xs",style:{width:"60px"},children:o("helpPanel.subscriptions.bbq")}),e.jsx("th",{className:"p-1 text-center border-b bg-green-50 text-xs",style:{width:"60px"},children:o("helpPanel.subscriptions.breakfast")}),e.jsx("th",{className:"p-1 text-center border-b bg-green-50 text-xs",style:{width:"60px"},children:o("helpPanel.subscriptions.lunch")}),e.jsx("th",{className:"p-1 text-center border-b bg-gray-100 text-xs",style:{width:"60px"}})]}),e.jsxs("tr",{children:[e.jsx("th",{className:"p-1 text-center border-b bg-gray-200 text-xs font-bold",style:{width:"60px"},children:p.booth_count}),e.jsx("th",{className:"p-1 text-center border-b bg-blue-100 text-xs font-bold text-blue-800",style:{width:"60px"},children:p.breakfast_sat}),e.jsx("th",{className:"p-1 text-center border-b bg-blue-100 text-xs font-bold text-blue-800",style:{width:"60px"},children:p.lunch_sat}),e.jsx("th",{className:"p-1 text-center border-b bg-blue-100 text-xs font-bold text-blue-800",style:{width:"60px"},children:p.bbq_sat}),e.jsx("th",{className:"p-1 text-center border-b bg-green-100 text-xs font-bold text-green-800",style:{width:"60px"},children:p.breakfast_sun}),e.jsx("th",{className:"p-1 text-center border-b bg-green-100 text-xs font-bold text-green-800",style:{width:"60px"},children:p.lunch_sun}),e.jsx("th",{className:"p-1 text-center border-b bg-gray-200 text-xs font-bold",style:{width:"60px"},children:p.coins})]})]}),e.jsx("tbody",{children:N.map(t=>{const s=X===t.id,r=t.company,c=j(t.company_id);return e.jsxs("tr",{className:"bg-white hover:bg-gray-50 border-b",children:[e.jsx("td",{className:"p-2 text-left",children:e.jsx("span",{className:"text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded font-medium",children:c})}),e.jsx("td",{className:"p-2 text-left",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("img",{src:me((r==null?void 0:r.logo)||W),alt:r==null?void 0:r.name,className:"w-8 h-8 object-contain"}),e.jsx("span",{className:"font-semibold text-gray-700",children:r==null?void 0:r.name})]})}),e.jsx("td",{className:"p-2 text-left",children:s?e.jsx("input",{type:"text",value:n.contact||"",onChange:a=>x({...n,contact:a.target.value}),className:"w-full px-2 py-1 border rounded text-xs bg-white text-gray-900"}):e.jsx("span",{className:"text-xs text-gray-700",children:t.contact||"-"})}),e.jsx("td",{className:"p-2 text-left",children:s?e.jsx(ve,{value:n.phone||"",onChange:a=>x({...n,phone:a}),placeholder:"+31612345678",className:"text-xs"}):t.phone?e.jsxs("span",{className:"text-xs text-gray-700 flex items-center gap-1",children:[e.jsx("span",{children:we(t.phone)}),e.jsx("span",{children:Ce(t.phone)})]}):e.jsx("span",{className:"text-xs text-gray-400",children:"-"})}),e.jsx("td",{className:"p-2 text-left",children:s?e.jsx("input",{type:"email",value:n.email||"",onChange:a=>x({...n,email:a.target.value.toLowerCase()}),className:"w-full px-2 py-1 border rounded text-xs bg-white text-gray-900"}):e.jsx("span",{className:"text-xs text-gray-700",children:t.email||"-"})}),e.jsx("td",{className:"p-2 text-center",children:s?e.jsx("input",{type:"number",min:"1",value:n.booth_count||1,onChange:a=>x({...n,booth_count:parseInt(a.target.value)}),className:"w-16 px-2 py-1 border rounded text-xs text-center bg-white text-gray-900"}):e.jsx("span",{className:"text-xs text-gray-700",children:t.booth_count})}),e.jsx("td",{className:"p-2",children:s?e.jsx("input",{type:"text",value:n.area||"",onChange:a=>x({...n,area:a.target.value}),className:"w-full px-2 py-1 border rounded text-xs bg-white text-gray-900",placeholder:o("helpPanel.subscriptions.areaPlaceholder")}):e.jsx("span",{className:"text-xs text-gray-700",children:t.area||"-"})}),["breakfast_sat","lunch_sat","bbq_sat"].map(a=>e.jsx("td",{className:"p-2 text-center bg-blue-50",children:s?e.jsx("input",{type:"number",min:"0",value:n[a]||0,onChange:d=>x({...n,[a]:parseInt(d.target.value)||0}),className:"w-12 px-1 py-1 border rounded text-xs text-center text-gray-900 bg-white"}):e.jsx("span",{className:"text-xs text-gray-700",children:t[a]})},a)),["breakfast_sun","lunch_sun"].map(a=>e.jsx("td",{className:"p-2 text-center bg-green-50",children:s?e.jsx("input",{type:"number",min:"0",value:n[a]||0,onChange:d=>x({...n,[a]:parseInt(d.target.value)||0}),className:"w-12 px-1 py-1 border rounded text-xs text-center text-gray-900 bg-white"}):e.jsx("span",{className:"text-xs text-gray-700",children:t[a]})},a)),e.jsx("td",{className:"p-2 text-center",children:s?e.jsx("input",{type:"number",min:"0",value:n.coins||0,onChange:a=>x({...n,coins:parseInt(a.target.value)||0}),className:"w-12 px-1 py-1 border rounded text-xs text-center bg-white text-gray-900"}):e.jsx("span",{className:"text-xs text-gray-700",children:t.coins})}),e.jsx("td",{className:"p-2 text-left",children:s?e.jsx("textarea",{value:n.notes||"",onChange:a=>x({...n,notes:a.target.value}),className:"w-full px-2 py-1 border rounded text-xs bg-white text-gray-900",rows:2}):e.jsx("span",{className:"text-xs text-gray-700",children:t.notes||"-"})}),e.jsx("td",{className:"p-2 text-center",children:s?e.jsxs("div",{className:"flex gap-1 justify-center",children:[e.jsx("button",{onClick:se,className:"p-1 bg-green-600 text-white rounded hover:bg-green-700",title:"Save",children:e.jsx(h,{path:q,size:.6})}),e.jsx("button",{onClick:ae,className:"p-1 bg-gray-500 text-white rounded hover:bg-gray-600",title:"Cancel",children:e.jsx(h,{path:F,size:.6})})]}):e.jsxs("div",{className:"flex gap-1 justify-center",children:[e.jsx("button",{onClick:()=>te(t),className:"p-1 bg-blue-600 text-white rounded hover:bg-blue-700",title:"Edit",children:e.jsx(h,{path:ue,size:.6})}),e.jsx("button",{onClick:()=>re(t),className:"p-1 bg-red-600 text-white rounded hover:bg-red-700",title:"Unsubscribe",children:e.jsx(h,{path:ge,size:.6})})]})})]},t.id)})})]}),N.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:y?"No subscriptions found matching your search":`No companies subscribed to ${l} yet. Click "Subscribe Company" to add one.`})]})]})}export{Ie as default};
