import{r as u,K as pe,s as N,R as ge,j as e,I as M,L as he,aT as xe,aJ as fe,b0 as ye,p as be,aO as je,bo as ve,M as Ne}from"./index-12ba77bc.js";import{f as ne,p as Ce,s as le}from"./dataExportImport-52bc86db.js";import{a as Ee}from"./ImportButton-fab8056d.js";import"./phone-376c158e.js";import"./useCategories-9824a5e1.js";const h={FILE_SELECT:"file_select",PARSING:"parsing",PREVIEW:"preview",IMPORTING:"importing",COMPLETE:"complete"};function Ae({isOpen:oe,onClose:H,dataType:f,eventYear:C,existingData:O=[],additionalData:K={},onImportComplete:U,onImportError:V}){const[W,E]=u.useState(h.FILE_SELECT),[we,Q]=u.useState(null),[Se,X]=u.useState([]),[k,de]=u.useState(null),[v,Z]=u.useState([]),[x,$]=u.useState(new Set),[w,Y]=u.useState(null),[q,L]=u.useState(null),[T,ce]=u.useState(!1),[I,A]=u.useState({current:0,total:0,message:""}),ee=u.useRef(null),{toastError:S,toastSuccess:z,toastWarning:D}=pe(),m=Ee(f),G=u.useCallback(()=>{E(h.FILE_SELECT),Q(null),X([]),Z([]),$(new Set),Y(null),L(null),ce(!1),A({current:0,total:0,message:""}),H()},[H]),te=u.useCallback(async s=>{try{let t=null,a=null;if(m.yearDependent){const{data:r,error:y}=await N.from("companies").select("id, name");if(y)throw y;if(t=ne(r,"name","id",!1),f==="assignments"){const{data:c,error:_}=await N.from("markers_core").select("id, glyph").eq("event_year",C);if(_)throw _;a={},c.forEach(p=>{p.glyph&&(a[p.glyph.toLowerCase()]=p.id),a[p.id.toString()]=p.id})}}const n=s.map((r,y)=>{var F,b,R;const c=m.validateRow(r,y,t,a);let _="ERROR",p=null;if(c.valid)try{const j=m.transformImport(r,t,a||K.markerMap,C);if(m.matchStrategy.matchFields.includes("name")){const i=(F=r["Company Name"])==null?void 0:F.toLowerCase().trim();p=O.find(o=>{var l;return((l=o.name)==null?void 0:l.toLowerCase().trim())===i})}else if(m.yearDependent&&t){const i=(b=r["Company Name"])==null?void 0:b.toLowerCase().trim(),o=t[i];if(f==="event_subscriptions")p=O.find(l=>l.company_id===o&&l.event_year===C);else if(f==="assignments"){const l=(R=r["Booth Label"])==null?void 0:R.toLowerCase().trim(),P=a[l];p=O.find(g=>g.company_id===o&&g.marker_id===P&&g.event_year===C)}}_=p?"UPDATE":"CREATE"}catch(j){c.valid=!1,c.errors.push({field:"General",message:j.message})}return{index:y,originalRow:r,validation:c,action:_,matchedRecord:p,selected:c.valid}});Z(n);const d=n.filter(r=>r.validation.valid).map(r=>r.index);if($(new Set(d)),E(h.PREVIEW),!T){const r=n.filter(c=>c.validation.valid).length,y=n.filter(c=>!c.validation.valid).length;y>0?D(`Parsed ${s.length} rows: ${r} valid, ${y} errors`):z(`Parsed ${s.length} rows - all valid`)}}catch(t){console.error("Validation error:",t),L(t.message),E(h.FILE_SELECT),S(`Validation failed: ${t.message}`)}},[m,f,C,O,K,D,z,S,T]),se=u.useCallback(async s=>{var r;const t=(r=s.target.files)==null?void 0:r[0];if(!t)return;Q(t),L(null),E(h.PARSING);const{data:a,error:n,metadata:d}=await Ce(t);if(n||!a){L(n||"Failed to parse file"),E(h.FILE_SELECT),T||S(`Failed to parse file: ${n}`);return}if(a.length===0){L("File is empty or has no valid data"),E(h.FILE_SELECT),T||S("File is empty");return}X(a),de(d||null),await te(a)},[T,te,S]),ae=u.useCallback(s=>{const t=new Set(x);t.has(s)?t.delete(s):t.add(s),$(t)},[x]),re=u.useCallback(()=>{if(x.size===v.filter(s=>s.validation.valid).length)$(new Set);else{const s=v.filter(t=>t.validation.valid).map(t=>t.index);$(new Set(s))}},[x,v]),B=u.useCallback(async(s,t,a,n)=>{if(!(!t||t.length===0))try{const d=t.map(c=>a[c.toLowerCase()]).filter(c=>c!==void 0);if(d.length===0)return;await N.from("company_categories").delete().eq("company_id",s);const r=d.map(c=>({company_id:s,category_id:c})),{error:y}=await N.from("company_categories").insert(r);y&&n.push({type:"CATEGORY",companyId:s,message:`Failed to assign categories: ${y.message}`})}catch(d){n.push({type:"CATEGORY",companyId:s,message:`Failed to assign categories: ${d.message}`})}},[]),J=u.useCallback(async(s,t,a)=>{if(!t)return;const n=[];if(t.nl&&t.nl.trim()&&n.push({company_id:s,language_code:"nl",info:t.nl.trim(),updated_at:new Date().toISOString()}),t.en&&t.en.trim()&&n.push({company_id:s,language_code:"en",info:t.en.trim(),updated_at:new Date().toISOString()}),t.de&&t.de.trim()&&n.push({company_id:s,language_code:"de",info:t.de.trim(),updated_at:new Date().toISOString()}),n.length>0){const{error:d}=await N.from("company_translations").upsert(n,{onConflict:"company_id,language_code"});d&&a.push({type:"TRANSLATION",companyId:s,message:`Failed to save translations: ${d.message}`})}},[]),ie=u.useCallback(async()=>{var t;const s=v.filter(a=>x.has(a.index));if(s.length===0){S("No rows selected for import");return}E(h.IMPORTING),A({current:0,total:s.length,message:"Starting import..."});try{let a=null,n=null;if(m.yearDependent){const{data:i}=await N.from("companies").select("id, name");if(a=ne(i,"name","id",!1),f==="assignments"){const{data:o}=await N.from("markers_core").select("id, glyph").eq("event_year",C);n={},o.forEach(l=>{l.glyph&&(n[l.glyph.toLowerCase()]=l.id),n[l.id.toString()]=l.id})}}let d={};if(f==="companies"){const{data:i,error:o}=await N.from("categories").select("id, slug");!o&&i&&i.forEach(l=>{d[l.slug.toLowerCase()]=l.id})}const{data:{user:r}}=await N.auth.getUser(),y=(r==null?void 0:r.email)||"unknown",c=[],_=[],p=[],F=[];for(const i of s){const o=m.transformImport(i.originalRow,a,n,C);if(i.action==="CREATE"){m.yearDependent&&!o.event_year&&(o.event_year=C),m.yearDependent&&(o.created_by=y);const l=le(o);c.push(l),_.push(o)}else if(i.action==="UPDATE"){const l=le(o);p.push({id:i.matchedRecord.id,data:l}),F.push({id:i.matchedRecord.id,original:o})}}let b=0,R=0;const j=[];if(c.length>0){A({current:0,total:s.length,message:`Creating ${c.length} new records...`});const{data:i,error:o}=await N.from(m.table).insert(c).select();if(o)j.push({type:"CREATE_BATCH",message:o.message});else if(b=(i==null?void 0:i.length)||0,A({current:b,total:s.length,message:`Created ${b} records. Processing additional data...`}),f==="companies"&&i)for(let l=0;l<i.length;l++){const P=i[l],g=_[l];g&&g._translations&&await J(P.id,g._translations,j),g&&g._categorySlugs&&await B(P.id,g._categorySlugs,d,j)}}A({current:b,total:s.length,message:`Updating ${p.length} existing records...`});for(let i=0;i<p.length;i++){const o=p[i],l=Math.round((b+i)/s.length*100);A({current:b+i,total:s.length,message:`Updating record ${i+1} of ${p.length}... (${l}%)`});const{error:P}=await N.from(m.table).update(o.data).eq("id",o.id);if(P)j.push({type:"UPDATE",id:o.id,message:P.message});else if(R++,f==="companies"){const g=((t=F.find(ue=>ue.id===o.id))==null?void 0:t.original)||null;g&&g._translations&&await J(o.id,g._translations,j),g&&g._categorySlugs&&await B(o.id,g._categorySlugs,d,j)}}Y({created:b,updated:R,failed:j.length,errors:j}),E(h.COMPLETE),j.length===0?(z(`Import complete: ${b} created, ${R} updated`),U&&U({created:b,updated:R})):D(`Import partial: ${b} created, ${R} updated, ${j.length} failed`)}catch(a){console.error("Import error:",a),L(a.message),S(`Import failed: ${a.message}`),V&&V(a),E(h.PREVIEW)}},[v,x,m,f,C,S,z,B,J,U,V,D]),me=ge.useMemo(()=>function(){switch(W){case h.FILE_SELECT:return e.jsx("div",{className:"p-6 transition-all duration-200 ease-in-out",children:e.jsxs("div",{className:"text-center",children:[e.jsx(M,{path:ve,size:3,className:"mx-auto text-gray-400 mb-4 transition-transform duration-200"}),e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-2",children:"Select a file to import"}),e.jsx("p",{className:"text-sm text-gray-600 mb-6",children:"Supported formats: Excel (.xlsx), CSV (.csv), JSON (.json)"}),e.jsx("input",{ref:ee,type:"file",accept:".xlsx,.xls,.csv,.json",onChange:se,className:"hidden"}),e.jsx("button",{onClick:()=>{var t;return(t=ee.current)==null?void 0:t.click()},className:"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-150",children:"Choose File"}),q&&e.jsx("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm animate-pulse",children:q})]})});case h.PARSING:return e.jsx("div",{className:"p-6 transition-all duration-200 ease-in-out",children:e.jsxs("div",{className:"text-center",children:[e.jsx(M,{path:je,size:3,className:"mx-auto text-blue-600 mb-4 transition-transform duration-200",spin:!0}),e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-2",children:"Parsing file..."}),e.jsx("p",{className:"text-sm text-gray-600",children:"Please wait while we process your file"})]})});case h.PREVIEW:return e.jsxs("div",{className:"flex flex-col h-full transition-all duration-200 ease-in-out",children:[e.jsx("div",{className:"p-6 border-b border-gray-200 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900",children:"Import Preview"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[v.length," rows parsed,"," ",v.filter(t=>t.validation.valid).length," valid,"," ",v.filter(t=>!t.validation.valid).length," errors"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:x.size===v.filter(t=>t.validation.valid).length&&x.size>0,onChange:re,className:"rounded"}),e.jsxs("span",{children:["Select All (",x.size," selected)"]})]})})]})}),e.jsx("div",{className:"flex-1 overflow-auto p-6",children:e.jsx("div",{className:"transition-all duration-200 ease-in-out",children:e.jsxs("table",{className:"w-full text-sm border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200",children:[e.jsx("th",{className:"text-left p-2 font-medium text-gray-700",children:"Select"}),e.jsx("th",{className:"text-left p-2 font-medium text-gray-700",children:"Row"}),e.jsx("th",{className:"text-left p-2 font-medium text-gray-700",children:"Status"}),(()=>{let t;f==="event_subscriptions"?t=m.exportColumns:t=m.exportColumns.slice(0,6);const a=k&&Array.isArray(k.columns)?k.columns.filter(d=>d.key&&String(d.key).startsWith("category:")):[];return[...t,...a].map(d=>e.jsx("th",{className:"text-left p-2 font-medium text-gray-700",children:d.header},d.key))})(),e.jsx("th",{className:"text-left p-2 font-medium text-gray-700",children:"Errors"})]})}),e.jsx("tbody",{children:v.map(t=>e.jsxs("tr",{className:`border-b border-gray-100 transition-colors duration-150 ${t.validation.valid?"hover:bg-gray-50":"bg-red-50"}`,children:[e.jsx("td",{className:"p-2",children:e.jsx("input",{type:"checkbox",checked:x.has(t.index),onChange:()=>ae(t.index),disabled:!t.validation.valid,className:"rounded"})}),e.jsx("td",{className:"p-2 text-gray-600",children:t.index+1}),e.jsx("td",{className:"p-2",children:t.validation.valid?e.jsxs("span",{className:`inline-flex items-center gap-1 text-xs px-2 py-1 rounded ${t.action==="CREATE"?"bg-green-100 text-green-700":"bg-blue-100 text-blue-700"}`,children:[e.jsx(M,{path:t.action==="CREATE"?fe:ye,size:.5}),t.action]}):e.jsxs("span",{className:"inline-flex items-center gap-1 text-xs px-2 py-1 rounded bg-red-100 text-red-700",children:[e.jsx(M,{path:be,size:.5}),"ERROR"]})}),(()=>{let a;f==="event_subscriptions"?a=m.exportColumns:a=m.exportColumns.slice(0,6);const n=k&&Array.isArray(k.columns)?k.columns.filter(r=>r.key&&String(r.key).startsWith("category:")):[];return[...a,...n].map(r=>e.jsx("td",{className:"p-2 text-gray-900 truncate max-w-xs",children:t.originalRow[r.header]||"-"},r.key))})(),e.jsx("td",{className:"p-2",children:t.validation.errors.length>0&&e.jsx("div",{className:"text-xs text-red-600",children:t.validation.errors.map((a,n)=>e.jsxs("div",{children:["• ",a.message]},n))})})]},t.index))})]})})}),e.jsxs("div",{className:"p-6 border-t border-gray-200 flex justify-between flex-shrink-0",children:[e.jsx("button",{onClick:G,className:"px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors duration-150",children:"Cancel"}),e.jsxs("button",{onClick:ie,disabled:x.size===0,className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150",children:["Import Selected (",x.size,")"]})]})]});case h.IMPORTING:const s=I.total>0?Math.round(I.current/I.total*100):0;return e.jsx("div",{className:"p-6 transition-all duration-200 ease-in-out",children:e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"w-full max-w-md mx-auto",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Importing data..."}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-3 mb-4",children:e.jsx("div",{className:"bg-blue-600 h-3 rounded-full transition-all duration-300 ease-out",style:{width:`${s}%`}})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-gray-600",children:I.message||`Processing ${x.size} records`}),e.jsxs("p",{className:"text-xs text-gray-500",children:[I.current," of ",I.total," records (",s,"%)"]})]})]})})});case h.COMPLETE:return e.jsx("div",{className:"p-6 transition-all duration-200 ease-in-out",children:e.jsxs("div",{className:"text-center",children:[w.failed===0?e.jsx(M,{path:he,size:3,className:"mx-auto text-green-600 mb-4 transition-transform duration-200"}):e.jsx(M,{path:xe,size:3,className:"mx-auto text-orange-600 mb-4 transition-transform duration-200"}),e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-2",children:"Import Complete"}),e.jsxs("div",{className:"mt-6 space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 transition-colors duration-200",children:[e.jsx("span",{className:"text-green-600",children:"✓ Created:"}),e.jsx("span",{className:"font-medium",children:w.created})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 transition-colors duration-200",children:[e.jsx("span",{className:"text-blue-600",children:"⟳ Updated:"}),e.jsx("span",{className:"font-medium",children:w.updated})]}),w.failed>0&&e.jsxs("div",{className:"flex items-center justify-center gap-2 transition-colors duration-200",children:[e.jsx("span",{className:"text-red-600",children:"✗ Failed:"}),e.jsx("span",{className:"font-medium",children:w.failed})]})]}),w.errors.length>0&&e.jsxs("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-left text-sm transition-colors duration-200",children:[e.jsx("div",{className:"font-medium text-red-900 mb-2",children:"Errors:"}),w.errors.map((t,a)=>e.jsxs("div",{className:"text-red-700",children:["• ",t.message]},a))]}),e.jsx("button",{onClick:G,className:"mt-6 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-150",children:"Close"})]})});default:return null}},[W,m,x,v,k,q,w,I,f,G,se,ie,re,ae])();return e.jsx(Ne,{isOpen:oe,onClose:G,title:m.labels.modalTitle,size:"lg",closeOnBackdrop:W!==h.IMPORTING,className:"transition-all duration-200 ease-in-out",children:e.jsx("div",{className:"transition-all duration-200 ease-in-out",children:me})})}export{Ae as default};
