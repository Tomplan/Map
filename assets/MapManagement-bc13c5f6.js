import{u as Y,r as b,a2 as k,j as e,I as S,a3 as ee,a4 as se,m as le,d as te,e as ae,s as U,g as re,a5 as ne,a6 as ie,h as oe}from"./index-8fb29835.js";import{P as ce}from"./ProtectedSection-4baf846d.js";import{g as L,E as de}from"./EventMap-661bad58.js";import"./useUserRole-70da92d4.js";import"./useTranslatedCompanyInfo-85383ec9.js";import"./useCategories-278a1a88.js";import"./useEventSubscriptions-b8d1b708.js";import"./phone-376c158e.js";import"./useAssignments-e32be150.js";import"./index-b76b1c62.js";import"./useEventMapSettings-372e3c80.js";function Ce({markersState:s,setMarkersState:d,updateMarker:x,selectedYear:o,archiveMarkers:f,copyMarkers:i}){const{t:m}=Y(),[y,z]=b.useState(""),[l,G]=b.useState(null),[D,j]=b.useState(!1),[c,v]=b.useState(null),[E,O]=b.useState("id"),[A,V]=b.useState("asc"),[N,P]=b.useState([]),{confirm:T,toastError:F,toastSuccess:R}=k();b.useEffect(()=>{async function t(){try{const[r,a]=await Promise.all([U.from("markers_core").select("*").in("id",[-1,-2]).eq("event_year",0),U.from("markers_appearance").select("*").in("id",[-1,-2]).eq("event_year",0)]);if(r.error)throw r.error;if(a.error)throw a.error;const n=(r.data||[]).map(h=>{const w=(a.data||[]).find(M=>M.id===h.id)||{};return{...h,...w}});P(n)}catch(r){console.error("Error fetching default markers:",r)}}t()},[]);const _=b.useMemo(()=>{if(!s)return N;const r=[...s.filter(a=>{var h,w;const n=y.toLowerCase();return a.id.toString().includes(n)||((h=a.glyph)==null?void 0:h.toLowerCase().includes(n))||((w=a.name)==null?void 0:w.toLowerCase().includes(n))})].sort((a,n)=>{let h=0;switch(E){case"id":h=a.id-n.id;break;case"name":h=(a.glyph||a.name||"").localeCompare(n.glyph||n.name||"");break;case"type":a.id>=1e3!=n.id>=1e3?h=a.id>=1e3?-1:1:h=a.id-n.id;break;default:h=a.id-n.id}return A==="desc"?-h:h});return y?r:[...[...N].sort((n,h)=>h.id-n.id),...r]},[s,N,y,E,A]),u=b.useMemo(()=>{if(!l)return null;const t=N.find(r=>r.id===l);return t||(s==null?void 0:s.find(r=>r.id===l))},[l,s,N]),q=t=>{G(t.id),j(!1)},J=()=>{u&&(v({...u}),j(!0))},X=()=>{v(null),j(!1)},K=async()=>{if(!c)return;const t=c.id===-1||c.id===-2;try{if(t){const r={rectWidth:c.rectWidth,rectHeight:c.rectHeight},a={iconUrl:c.iconUrl,iconSize:c.iconSize,glyphColor:c.glyphColor,glyphSize:c.glyphSize,shadowScale:c.shadowScale},[n,h]=await Promise.all([U.from("markers_core").update(r).eq("id",c.id).eq("event_year",0),U.from("markers_appearance").update(a).eq("id",c.id).eq("event_year",0)]);if(n.error)throw n.error;if(h.error)throw h.error;P(w=>w.map(M=>M.id===c.id?{...M,...c}:M))}else{const r={};if(Object.keys(c).forEach(a=>{c[a]!==u[a]&&(r[a]=c[a])}),Object.keys(r).length===0){j(!1),v(null);return}d(a=>a.map(n=>n.id===c.id?{...n,...c}:n)),await x(c.id,r)}j(!1),v(null)}catch(r){console.error("Error saving marker:",r),F("Failed to save marker. Please try again.")}},Q=(t,r)=>{v(a=>({...a,[t]:r}))},Z=async()=>{if(!await T({title:"Archive Markers",message:`Archive all markers for ${o}? This will move them to the archive and clear the current year.`,confirmText:"Archive",variant:"warning"}))return;const{error:r}=await f();r?F(`Error archiving markers: ${r}`):R(`Successfully archived markers for ${o}`)},W=async()=>{const t=o-1;if(!await T({title:"Copy Markers",message:`Copy all markers from ${t} to ${o}?`,confirmText:"Copy",variant:"default"}))return;const{error:a}=await i(t);a?F(`Error copying markers: ${a}`):R(`Markers copied from ${t} to ${o}`)},I=u&&(u.id===-1||u.id===-2),$=u&&u.id>=1e3,B=u&&u.id>0&&u.id<1e3,H=t=>{const r=N.find(n=>n.id===(t?-1:-2));if(!(r!=null&&r.iconUrl))return t?"Blue (assigned)":"Gray (unassigned)";const a=r.iconUrl.match(/glyph-marker-icon-(\w+)\.svg/);return a?`${a[1].charAt(0).toUpperCase()+a[1].slice(1)} (${t?"assigned":"unassigned"})`:t?"Blue (assigned)":"Gray (unassigned)"};return e.jsx(ce,{requiredRole:["super_admin","system_manager"],children:e.jsxs("div",{className:"bg-white rounded-lg shadow",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-xl font-semibold text-gray-900",children:m("mapManagement.title")}),e.jsx("div",{className:"px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium",children:o})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:W,className:"flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700",title:`Copy markers from ${o-1}`,children:[e.jsx(S,{path:ee,size:.8}),"Copy from ",o-1]}),e.jsxs("button",{onClick:Z,className:"flex items-center gap-2 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed",disabled:((s==null?void 0:s.length)||0)===0,title:`Archive all markers for ${o}`,children:[e.jsx(S,{path:se,size:.8}),"Archive ",o]})]})]}),_.length===0&&!y&&e.jsx("div",{className:"bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-4",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("h3",{className:"text-lg font-semibold text-blue-900 mb-2",children:["No Markers Found for ",o]}),e.jsxs("p",{className:"text-blue-700 mb-4",children:["There are no markers configured for ",o,". You can copy markers from the previous year or create new ones."]}),e.jsxs("button",{onClick:W,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:["Copy from ",o-1]})]})}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(S,{path:le,size:1,className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",placeholder:m("mapManagement.searchPlaceholder"),value:y,onChange:t=>z(t.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{className:"flex items-center border border-gray-300 rounded-md shadow-sm bg-white w-64",children:[e.jsxs("select",{value:E,onChange:t=>O(t.target.value),className:"flex-1 pl-3 pr-3 py-1.5 border-0 rounded-l-md bg-white text-gray-900 text-sm focus:ring-0 appearance-none","aria-label":m("mapManagement.sortBy"),children:[e.jsx("option",{value:"id",children:m("mapManagement.sortId")}),e.jsx("option",{value:"name",children:m("mapManagement.sortName")}),e.jsx("option",{value:"type",children:m("mapManagement.sortType")})]}),e.jsx("button",{type:"button",onClick:()=>V(A==="asc"?"desc":"asc"),"aria-label":`Toggle sort direction to ${A==="asc"?"descending":"ascending"}`,className:"px-2 py-1.5 border-l border-gray-300 text-gray-500 hover:bg-gray-50 rounded-r-md",children:e.jsx(S,{path:A==="asc"?te:ae,size:.8})})]})]})]}),e.jsxs("div",{className:"flex h-[calc(100vh-150px)]",children:[e.jsx("div",{className:"w-64 border-r border-gray-200 overflow-y-auto flex-shrink-0",children:e.jsx("div",{className:"p-2",children:_.map(t=>{const r=t.id===l,a=t.id===-1||t.id===-2,n=t.id>=1e3;return e.jsx("button",{onClick:()=>q(t),className:`w-full text-left p-3 rounded-lg mb-2 transition-colors ${r?"bg-blue-50 border-2 border-blue-500":a?"bg-amber-50 border-2 border-amber-300 hover:bg-amber-100":"bg-white border border-gray-200 hover:bg-gray-50"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[t.iconUrl?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:L(t.iconUrl),alt:"icon",className:"w-6 h-6"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-orange-500 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-white text-xs",children:"•"})})]}):e.jsx("div",{className:"w-6 h-6 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-600",children:"D"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-semibold text-gray-900 truncate",children:a?t.id===-1?"Assigned Booth Default":"Unassigned Booth Default":t.glyph||`Marker ${t.id}`}),e.jsxs("div",{className:"text-xs text-gray-500",children:["ID: ",t.id,a&&" ⚙️ Global Default",n&&" (Special)"]}),t.name&&e.jsx("div",{className:"text-xs text-gray-600 truncate",children:t.name})]})]})},t.id)})})}),e.jsx("div",{className:"flex-1 relative bg-gray-50",children:e.jsx(b.Suspense,{fallback:e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:"Loading map..."}),children:e.jsx(de,{isAdminView:!0,previewUseVisitorSizing:!0,markersState:s,updateMarker:x,selectedYear:o,selectedMarkerId:l,editMode:D,onMarkerSelect:t=>{G(t),j(!1)},onMarkerDrag:(t,r,a)=>{D&&l===t&&v(n=>({...n,lat:r,lng:a}))}})})}),e.jsx("div",{className:"w-96 border-l border-gray-200 overflow-y-auto p-6 flex-shrink-0",children:u?e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:I?u.id===-1?"Assigned Booth Default":"Unassigned Booth Default":u.glyph||`Marker ${u.id}`}),e.jsxs("p",{className:"text-sm text-gray-600",children:["ID: ",u.id,I&&" ⚙️ Global Default for Booth Markers",$&&" (Special Marker)",B&&" (Booth - Content managed via Companies/Assignments)"]})]}),!D&&e.jsx("button",{onClick:J,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"Edit"})]}),D?e.jsx(ue,{marker:c,isDefaultMarker:I,isSpecialMarker:$,isBoothMarker:B,getDefaultColorName:H,onChange:Q,onSave:K,onCancel:X}):e.jsx(he,{marker:u,isSpecialMarker:$,isDefaultMarker:I,isBoothMarker:B,getDefaultColorName:H})]}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:m("mapManagement.selectMarker")})})]})]})})}function he({marker:s,isSpecialMarker:d,isDefaultMarker:x,isBoothMarker:o,getDefaultColorName:f}){var i;return e.jsxs("div",{className:"space-y-6",children:[x&&e.jsxs("div",{className:"bg-amber-50 border-2 border-amber-300 rounded-lg p-4",children:[e.jsx("h4",{className:"font-semibold text-amber-900 mb-2",children:"ℹ️ About Default Markers"}),e.jsx("p",{className:"text-sm text-amber-800 mb-2",children:s.id===-1?"This defines the default appearance for booth markers (ID < 1000) that have a company assigned.":"This defines the default appearance for booth markers (ID < 1000) that have no company assigned."}),e.jsx("p",{className:"text-sm text-amber-800",children:"Individual booth markers can override these defaults by having their own values in the Appearance table."})]}),!x&&e.jsxs(C,{title:"Position & Structure",children:[e.jsx(g,{label:"Latitude",value:s.lat}),e.jsx(g,{label:"Longitude",value:s.lng}),e.jsx(g,{label:"Rectangle",value:JSON.stringify(s.rectangle)}),e.jsx(g,{label:"Angle",value:s.angle||0})]}),e.jsxs(C,{title:x?"Default Visual Styling":"Visual Styling",children:[e.jsx(g,{label:"Icon",children:s.iconUrl?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("img",{src:L(s.iconUrl),alt:"icon",className:"w-8 h-8"}),e.jsx("span",{className:"text-xs text-orange-600 font-medium",children:"Custom Color"})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 bg-gray-200 rounded flex items-center justify-center text-[9px] text-gray-600 font-medium leading-none",children:"Default"}),e.jsx("span",{className:"text-xs text-blue-600 font-medium",children:o?f(((i=s.assignments)==null?void 0:i.length)>0):"Based on marker type"})]})}),e.jsx(g,{label:"Icon Size",value:JSON.stringify(s.iconSize)}),!x&&e.jsx(g,{label:"Glyph (Booth Label)",value:s.glyph}),e.jsx(g,{label:"Glyph Color",value:s.glyphColor}),e.jsx(g,{label:"Glyph Size",value:s.glyphSize}),e.jsx(g,{label:"Glyph Anchor",value:s.glyphAnchor?JSON.stringify(s.glyphAnchor):"—"}),e.jsx(g,{label:"Shadow Scale",value:s.shadowScale??"1.0"}),x&&e.jsxs(e.Fragment,{children:[e.jsx(g,{label:"Rectangle Width",value:s.rectWidth}),e.jsx(g,{label:"Rectangle Height",value:s.rectHeight})]})]}),d&&e.jsxs(C,{title:"Content (Special Marker)",children:[e.jsx(g,{label:"Name",value:s.name}),e.jsx(g,{label:"Logo",children:s.logo&&e.jsx("img",{src:re(s.logo),alt:"logo",className:"w-12 h-12"})}),e.jsx(g,{label:"Website",value:s.website}),e.jsx(g,{label:"Info",value:s.info})]})]})}function ue({marker:s,isDefaultMarker:d,isSpecialMarker:x,isBoothMarker:o,getDefaultColorName:f,onChange:i,onSave:m,onCancel:y}){var z;return e.jsxs("div",{className:"space-y-6",children:[d&&e.jsxs("div",{className:"bg-amber-50 border-2 border-amber-300 rounded-lg p-4",children:[e.jsx("h4",{className:"font-semibold text-amber-900 mb-2",children:"⚙️ Editing Global Defaults"}),e.jsx("p",{className:"text-sm text-amber-800 mb-2",children:s.id===-1?"Changes here will affect all booth markers (ID < 1000) that have a company assigned, unless they have individual overrides.":"Changes here will affect all booth markers (ID < 1000) that have no company assigned, unless they have individual overrides."})]}),!d&&e.jsxs(C,{title:"Position & Structure",children:[e.jsx(p,{label:"Latitude",type:"number",step:"0.0001",value:s.lat,onChange:l=>i("lat",parseFloat(l))}),e.jsx(p,{label:"Longitude",type:"number",step:"0.0001",value:s.lng,onChange:l=>i("lng",parseFloat(l))}),e.jsx(p,{label:"Angle",type:"number",step:"0.1",value:s.angle||0,onChange:l=>i("angle",parseFloat(l))})]}),e.jsxs(C,{title:d?"Default Visual Styling":"Visual Styling",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Icon"}),e.jsxs("div",{className:"grid grid-cols-6 gap-2",children:[e.jsx("button",{onClick:()=>i("iconUrl",null),className:`w-10 h-10 border-2 rounded-lg transition-all flex items-center justify-center ${s.iconUrl?"border-gray-200 hover:border-gray-400":"border-blue-500 bg-blue-50"}`,title:"Use default color based on assignment status",children:e.jsx("div",{className:"text-[9px] text-gray-600 font-medium leading-none",children:"Default"})}),ne.map(l=>e.jsx("button",{onClick:()=>i("iconUrl",l),className:`p-2 border-2 rounded-lg transition-all ${s.iconUrl===l?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-400"}`,children:e.jsx("img",{src:L(l),alt:l,className:"w-8 h-8"})},l))]}),s.iconUrl?e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:"Using custom color override"}):e.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:["Using default color: ",o?f(((z=s.assignments)==null?void 0:z.length)>0):"Based on marker type"]})]}),!d&&e.jsx(p,{label:"Glyph (Booth Label)",value:s.glyph,onChange:l=>i("glyph",l)}),e.jsx(p,{label:"Glyph Color",type:"color",value:s.glyphColor,onChange:l=>i("glyphColor",l)}),e.jsx(p,{label:"Glyph Size",type:"number",step:"0.01",value:s.glyphSize,onChange:l=>i("glyphSize",parseFloat(l))}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(p,{label:"Glyph Anchor X",type:"number",step:"0.01",value:s.glyphAnchor?s.glyphAnchor[0]:"",onChange:l=>i("glyphAnchor",[parseFloat(l)||0,s.glyphAnchor&&s.glyphAnchor[1]||0])}),e.jsx(p,{label:"Glyph Anchor Y",type:"number",step:"0.01",value:s.glyphAnchor?s.glyphAnchor[1]:"",onChange:l=>i("glyphAnchor",[s.glyphAnchor&&s.glyphAnchor[0]||0,parseFloat(l)||0])})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(p,{label:"Icon Width",type:"number",step:"0.01",value:s.iconSize?s.iconSize[0]:"",onChange:l=>i("iconSize",[parseFloat(l)||null,s.iconSize?s.iconSize[1]:null])}),e.jsx(p,{label:"Icon Height",type:"number",step:"0.01",value:s.iconSize?s.iconSize[1]:"",onChange:l=>i("iconSize",[s.iconSize?s.iconSize[0]:null,parseFloat(l)||null])})]}),e.jsx(p,{label:"Shadow Scale",type:"number",step:"0.01",value:s.shadowScale??1,onChange:l=>i("shadowScale",parseFloat(l))}),d&&e.jsxs(e.Fragment,{children:[e.jsx(p,{label:"Rectangle Width",type:"number",step:"1",value:s.rectWidth,onChange:l=>i("rectWidth",parseFloat(l))}),e.jsx(p,{label:"Rectangle Height",type:"number",step:"1",value:s.rectHeight,onChange:l=>i("rectHeight",parseFloat(l))})]})]}),x&&e.jsxs(C,{title:"Content (Special Marker)",children:[e.jsx(p,{label:"Name",value:s.name,onChange:l=>i("name",l)}),e.jsx(p,{label:"Logo URL",value:s.logo,onChange:l=>i("logo",l)}),e.jsx(p,{label:"Website",value:s.website,onChange:l=>i("website",l)}),e.jsx(ge,{label:"Info",value:s.info,onChange:l=>i("info",l)})]}),o&&e.jsx("div",{className:"bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4",children:e.jsxs("p",{className:"text-sm text-yellow-800",children:[e.jsx("strong",{children:"Note:"})," This is a booth marker. Content (name, logo, website, info) is managed via the Companies and Assignments tabs."]})}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t border-gray-200",children:[e.jsxs("button",{onClick:m,className:"flex items-center gap-2 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(S,{path:ie,size:.9}),"Save Changes"]}),e.jsxs("button",{onClick:y,className:"flex items-center gap-2 px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors",children:[e.jsx(S,{path:oe,size:.9}),"Cancel"]})]})]})}function C({title:s,children:d}){return e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:s}),e.jsx("div",{className:"space-y-3",children:d})]})}function g({label:s,value:d,children:x}){return e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-700 mb-1",children:s}),x||e.jsx("div",{className:"text-gray-900",children:d||"—"})]})}function p({label:s,value:d,onChange:x,type:o="text",...f}){const i=o==="color"&&!d?"#000000":d||"";return e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s}),e.jsx("input",{type:o,value:i,"aria-label":s,onChange:m=>x(m.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",...f})]})}function ge({label:s,value:d,onChange:x}){return e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s}),e.jsx("textarea",{value:d||"",onChange:o=>x(o.target.value),rows:4,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})}export{Ce as default};
