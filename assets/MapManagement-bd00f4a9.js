import{u as Z,r as f,a1 as Y,R as e,I as N,a2 as k,a3 as ee,m as te,d as ae,e as le,s as D,g as re,a4 as ne,a5 as oe,h as se}from"./index-1e4c7e6c.js";import{P as ce}from"./ProtectedSection-cf76d1b4.js";import{g as P,E as ie}from"./EventMap-0d035665.js";import"./useUserRole-6e97074a.js";import"./useTranslatedCompanyInfo-91e3b8ae.js";import"./useCategories-30773e88.js";import"./jsx-runtime-9bc08dc0.js";import"./useEventSubscriptions-6efe7c48.js";import"./phone-376c158e.js";import"./useAssignments-4f6fb97f.js";import"./index-17768d2d.js";import"./useEventMapSettings-ac641da5.js";function Ce({markersState:t,setMarkersState:m,updateMarker:p,selectedYear:c,archiveMarkers:s,copyMarkers:S}){const{t:h}=Z(),[a,H]=f.useState(""),[y,T]=f.useState(null),[z,E]=f.useState(!1),[i,v]=f.useState(null),[F,O]=f.useState("id"),[C,V]=f.useState("asc"),[A,R]=f.useState([]),{confirm:U,toastError:L,toastSuccess:B}=Y();f.useEffect(()=>{async function l(){try{const[n,r]=await Promise.all([D.from("markers_core").select("*").in("id",[-1,-2]).eq("event_year",0),D.from("markers_appearance").select("*").in("id",[-1,-2]).eq("event_year",0)]);if(n.error)throw n.error;if(r.error)throw r.error;const o=(n.data||[]).map(d=>{const x=(r.data||[]).find(M=>M.id===d.id)||{};return{...d,...x}});R(o)}catch(n){console.error("Error fetching default markers:",n)}}l()},[]);const G=f.useMemo(()=>{if(!t)return A;const n=[...t.filter(r=>{var d,x;const o=a.toLowerCase();return r.id.toString().includes(o)||((d=r.glyph)==null?void 0:d.toLowerCase().includes(o))||((x=r.name)==null?void 0:x.toLowerCase().includes(o))})].sort((r,o)=>{let d=0;switch(F){case"id":d=r.id-o.id;break;case"name":d=(r.glyph||r.name||"").localeCompare(o.glyph||o.name||"");break;case"type":r.id>=1e3!=o.id>=1e3?d=r.id>=1e3?-1:1:d=r.id-o.id;break;default:d=r.id-o.id}return C==="desc"?-d:d});return a?n:[...[...A].sort((o,d)=>d.id-o.id),...n]},[t,A,a,F,C]),u=f.useMemo(()=>{if(!y)return null;const l=A.find(n=>n.id===y);return l||(t==null?void 0:t.find(n=>n.id===y))},[y,t,A]),q=l=>{T(l.id),E(!1)},j=()=>{u&&(v({...u}),E(!0))},J=()=>{v(null),E(!1)},X=async()=>{if(!i)return;const l=i.id===-1||i.id===-2;try{if(l){const n={rectWidth:i.rectWidth,rectHeight:i.rectHeight},r={iconUrl:i.iconUrl,iconSize:i.iconSize,glyphColor:i.glyphColor,glyphSize:i.glyphSize,shadowScale:i.shadowScale},[o,d]=await Promise.all([D.from("markers_core").update(n).eq("id",i.id).eq("event_year",0),D.from("markers_appearance").update(r).eq("id",i.id).eq("event_year",0)]);if(o.error)throw o.error;if(d.error)throw d.error;R(x=>x.map(M=>M.id===i.id?{...M,...i}:M))}else{const n={};if(Object.keys(i).forEach(r=>{i[r]!==u[r]&&(n[r]=i[r])}),Object.keys(n).length===0){E(!1),v(null);return}m(r=>r.map(o=>o.id===i.id?{...o,...i}:o)),await p(i.id,n)}E(!1),v(null)}catch(n){console.error("Error saving marker:",n),L("Failed to save marker. Please try again.")}},K=(l,n)=>{v(r=>({...r,[l]:n}))},Q=async()=>{if(!await U({title:"Archive Markers",message:`Archive all markers for ${c}? This will move them to the archive and clear the current year.`,confirmText:"Archive",variant:"warning"}))return;const{error:n}=await s();n?L(`Error archiving markers: ${n}`):B(`Successfully archived markers for ${c}`)},_=async()=>{const l=c-1;if(!await U({title:"Copy Markers",message:`Copy all markers from ${l} to ${c}?`,confirmText:"Copy",variant:"default"}))return;const{error:r}=await S(l);r?L(`Error copying markers: ${r}`):B(`Markers copied from ${l} to ${c}`)},I=u&&(u.id===-1||u.id===-2),$=u&&u.id>=1e3,W=u&&u.id>0&&u.id<1e3;return e.createElement(ce,{requiredRole:["super_admin","system_manager"]},e.createElement("div",{className:"bg-white rounded-lg shadow"},e.createElement("div",{className:"p-6 border-b border-gray-200"},e.createElement("div",{className:"flex justify-between items-center mb-4"},e.createElement("div",{className:"flex items-center gap-3"},e.createElement("h1",{className:"text-xl font-semibold text-gray-900"},h("mapManagement.title")),e.createElement("div",{className:"px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium"},c)),e.createElement("div",{className:"flex gap-2"},e.createElement("button",{onClick:_,className:"flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700",title:`Copy markers from ${c-1}`},e.createElement(N,{path:k,size:.8}),"Copy from ",c-1),e.createElement("button",{onClick:Q,className:"flex items-center gap-2 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed",disabled:((t==null?void 0:t.length)||0)===0,title:`Archive all markers for ${c}`},e.createElement(N,{path:ee,size:.8}),"Archive ",c))),G.length===0&&!a&&e.createElement("div",{className:"bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-4"},e.createElement("div",{className:"text-center"},e.createElement("h3",{className:"text-lg font-semibold text-blue-900 mb-2"},"No Markers Found for ",c),e.createElement("p",{className:"text-blue-700 mb-4"},"There are no markers configured for ",c,". You can copy markers from the previous year or create new ones."),e.createElement("button",{onClick:_,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"},"Copy from ",c-1))),e.createElement("div",{className:"flex gap-4"},e.createElement("div",{className:"relative flex-1"},e.createElement(N,{path:te,size:1,className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"}),e.createElement("input",{type:"text",placeholder:h("mapManagement.searchPlaceholder"),value:a,onChange:l=>H(l.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})),e.createElement("div",{className:"flex items-center border border-gray-300 rounded-md shadow-sm bg-white w-64"},e.createElement("select",{value:F,onChange:l=>O(l.target.value),className:"flex-1 pl-3 pr-3 py-1.5 border-0 rounded-l-md bg-white text-gray-900 text-sm focus:ring-0 appearance-none","aria-label":h("mapManagement.sortBy")},e.createElement("option",{value:"id"},h("mapManagement.sortId")),e.createElement("option",{value:"name"},h("mapManagement.sortName")),e.createElement("option",{value:"type"},h("mapManagement.sortType"))),e.createElement("button",{type:"button",onClick:()=>V(C==="asc"?"desc":"asc"),"aria-label":`Toggle sort direction to ${C==="asc"?"descending":"ascending"}`,className:"px-2 py-1.5 border-l border-gray-300 text-gray-500 hover:bg-gray-50 rounded-r-md"},e.createElement(N,{path:C==="asc"?ae:le,size:.8}))))),e.createElement("div",{className:"flex h-[calc(100vh-150px)]"},e.createElement("div",{className:"w-64 border-r border-gray-200 overflow-y-auto flex-shrink-0"},e.createElement("div",{className:"p-2"},G.map(l=>{const n=l.id===y,r=l.id===-1||l.id===-2,o=l.id>=1e3;return e.createElement("button",{key:l.id,onClick:()=>q(l),className:`w-full text-left p-3 rounded-lg mb-2 transition-colors ${n?"bg-blue-50 border-2 border-blue-500":r?"bg-amber-50 border-2 border-amber-300 hover:bg-amber-100":"bg-white border border-gray-200 hover:bg-gray-50"}`},e.createElement("div",{className:"flex items-center gap-3"},l.iconUrl&&e.createElement("img",{src:P(l.iconUrl),alt:"icon",className:"w-6 h-6"}),e.createElement("div",{className:"flex-1 min-w-0"},e.createElement("div",{className:"font-semibold text-gray-900 truncate"},r?l.id===-1?"Assigned Booth Default":"Unassigned Booth Default":l.glyph||`Marker ${l.id}`),e.createElement("div",{className:"text-xs text-gray-500"},"ID: ",l.id,r&&" ⚙️ Global Default",o&&" (Special)"),l.name&&e.createElement("div",{className:"text-xs text-gray-600 truncate"},l.name))))}))),e.createElement("div",{className:"flex-1 relative bg-gray-50"},e.createElement(f.Suspense,{fallback:e.createElement("div",{className:"flex items-center justify-center h-full text-gray-500"},"Loading map...")},e.createElement(ie,{isAdminView:!0,previewUseVisitorSizing:!0,markersState:t,updateMarker:p,selectedYear:c,selectedMarkerId:y,editMode:z,onMarkerSelect:l=>{T(l),E(!1)},onMarkerDrag:(l,n,r)=>{z&&y===l&&v(o=>({...o,lat:n,lng:r}))}}))),e.createElement("div",{className:"w-96 border-l border-gray-200 overflow-y-auto p-6 flex-shrink-0"},u?e.createElement("div",null,e.createElement("div",{className:"flex items-center justify-between mb-6"},e.createElement("div",null,e.createElement("h2",{className:"text-xl font-bold text-gray-900"},I?u.id===-1?"Assigned Booth Default":"Unassigned Booth Default":u.glyph||`Marker ${u.id}`),e.createElement("p",{className:"text-sm text-gray-600"},"ID: ",u.id,I&&" ⚙️ Global Default for Booth Markers",$&&" (Special Marker)",W&&" (Booth - Content managed via Companies/Assignments)")),!z&&e.createElement("button",{onClick:j,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"},"Edit")),z?e.createElement(de,{marker:i,isDefaultMarker:I,isSpecialMarker:$,isBoothMarker:W,onChange:K,onSave:X,onCancel:J}):e.createElement(me,{marker:u,isSpecialMarker:$,isDefaultMarker:I})):e.createElement("div",{className:"flex items-center justify-center h-full text-gray-500"},h("mapManagement.selectMarker"))))))}function me({marker:t,isSpecialMarker:m,isDefaultMarker:p}){return e.createElement("div",{className:"space-y-6"},p&&e.createElement("div",{className:"bg-amber-50 border-2 border-amber-300 rounded-lg p-4"},e.createElement("h4",{className:"font-semibold text-amber-900 mb-2"},"ℹ️ About Default Markers"),e.createElement("p",{className:"text-sm text-amber-800 mb-2"},t.id===-1?"This defines the default appearance for booth markers (ID < 1000) that have a company assigned.":"This defines the default appearance for booth markers (ID < 1000) that have no company assigned."),e.createElement("p",{className:"text-sm text-amber-800"},"Individual booth markers can override these defaults by having their own values in the Appearance table.")),!p&&e.createElement(w,{title:"Position & Structure"},e.createElement(g,{label:"Latitude",value:t.lat}),e.createElement(g,{label:"Longitude",value:t.lng}),e.createElement(g,{label:"Rectangle",value:JSON.stringify(t.rectangle)}),e.createElement(g,{label:"Angle",value:t.angle||0})),e.createElement(w,{title:p?"Default Visual Styling":"Visual Styling"},e.createElement(g,{label:"Icon"},t.iconUrl&&e.createElement("img",{src:P(t.iconUrl),alt:"icon",className:"w-8 h-8"})),e.createElement(g,{label:"Icon Size",value:JSON.stringify(t.iconSize)}),!p&&e.createElement(g,{label:"Glyph (Booth Label)",value:t.glyph}),e.createElement(g,{label:"Glyph Color",value:t.glyphColor}),e.createElement(g,{label:"Glyph Size",value:t.glyphSize}),e.createElement(g,{label:"Glyph Anchor",value:t.glyphAnchor?JSON.stringify(t.glyphAnchor):"—"}),e.createElement(g,{label:"Shadow Scale",value:t.shadowScale??"1.0"}),p&&e.createElement(e.Fragment,null,e.createElement(g,{label:"Rectangle Width",value:t.rectWidth}),e.createElement(g,{label:"Rectangle Height",value:t.rectHeight}))),m&&e.createElement(w,{title:"Content (Special Marker)"},e.createElement(g,{label:"Name",value:t.name}),e.createElement(g,{label:"Logo"},t.logo&&e.createElement("img",{src:re(t.logo),alt:"logo",className:"w-12 h-12"})),e.createElement(g,{label:"Website",value:t.website}),e.createElement(g,{label:"Info",value:t.info})))}function de({marker:t,isDefaultMarker:m,isSpecialMarker:p,isBoothMarker:c,onChange:s,onSave:S,onCancel:h}){return e.createElement("div",{className:"space-y-6"},m&&e.createElement("div",{className:"bg-amber-50 border-2 border-amber-300 rounded-lg p-4"},e.createElement("h4",{className:"font-semibold text-amber-900 mb-2"},"⚙️ Editing Global Defaults"),e.createElement("p",{className:"text-sm text-amber-800 mb-2"},t.id===-1?"Changes here will affect all booth markers (ID < 1000) that have a company assigned, unless they have individual overrides.":"Changes here will affect all booth markers (ID < 1000) that have no company assigned, unless they have individual overrides.")),!m&&e.createElement(w,{title:"Position & Structure"},e.createElement(b,{label:"Latitude",type:"number",step:"0.0001",value:t.lat,onChange:a=>s("lat",parseFloat(a))}),e.createElement(b,{label:"Longitude",type:"number",step:"0.0001",value:t.lng,onChange:a=>s("lng",parseFloat(a))}),e.createElement(b,{label:"Angle",type:"number",step:"0.1",value:t.angle||0,onChange:a=>s("angle",parseFloat(a))})),e.createElement(w,{title:m?"Default Visual Styling":"Visual Styling"},e.createElement("div",{className:"space-y-2"},e.createElement("label",{className:"block text-sm font-medium text-gray-700"},"Icon"),e.createElement("div",{className:"grid grid-cols-6 gap-2"},ne.map(a=>e.createElement("button",{key:a,onClick:()=>s("iconUrl",a),className:`p-2 border-2 rounded-lg transition-all ${t.iconUrl===a?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-400"}`},e.createElement("img",{src:P(a),alt:a,className:"w-8 h-8"}))))),!m&&e.createElement(b,{label:"Glyph (Booth Label)",value:t.glyph,onChange:a=>s("glyph",a)}),e.createElement(b,{label:"Glyph Color",type:"color",value:t.glyphColor,onChange:a=>s("glyphColor",a)}),e.createElement(b,{label:"Glyph Size",type:"number",step:"0.01",value:t.glyphSize,onChange:a=>s("glyphSize",parseFloat(a))}),e.createElement("div",{className:"grid grid-cols-2 gap-2"},e.createElement(b,{label:"Glyph Anchor X",type:"number",step:"0.01",value:t.glyphAnchor?t.glyphAnchor[0]:"",onChange:a=>s("glyphAnchor",[parseFloat(a)||0,t.glyphAnchor&&t.glyphAnchor[1]||0])}),e.createElement(b,{label:"Glyph Anchor Y",type:"number",step:"0.01",value:t.glyphAnchor?t.glyphAnchor[1]:"",onChange:a=>s("glyphAnchor",[t.glyphAnchor&&t.glyphAnchor[0]||0,parseFloat(a)||0])})),e.createElement("div",{className:"grid grid-cols-2 gap-2"},e.createElement(b,{label:"Icon Width",type:"number",step:"0.01",value:t.iconSize?t.iconSize[0]:"",onChange:a=>s("iconSize",[parseFloat(a)||null,t.iconSize?t.iconSize[1]:null])}),e.createElement(b,{label:"Icon Height",type:"number",step:"0.01",value:t.iconSize?t.iconSize[1]:"",onChange:a=>s("iconSize",[t.iconSize?t.iconSize[0]:null,parseFloat(a)||null])})),e.createElement(b,{label:"Shadow Scale",type:"number",step:"0.01",value:t.shadowScale??1,onChange:a=>s("shadowScale",parseFloat(a))}),m&&e.createElement(e.Fragment,null,e.createElement(b,{label:"Rectangle Width",type:"number",step:"1",value:t.rectWidth,onChange:a=>s("rectWidth",parseFloat(a))}),e.createElement(b,{label:"Rectangle Height",type:"number",step:"1",value:t.rectHeight,onChange:a=>s("rectHeight",parseFloat(a))}))),p&&e.createElement(w,{title:"Content (Special Marker)"},e.createElement(b,{label:"Name",value:t.name,onChange:a=>s("name",a)}),e.createElement(b,{label:"Logo URL",value:t.logo,onChange:a=>s("logo",a)}),e.createElement(b,{label:"Website",value:t.website,onChange:a=>s("website",a)}),e.createElement(ue,{label:"Info",value:t.info,onChange:a=>s("info",a)})),c&&e.createElement("div",{className:"bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4"},e.createElement("p",{className:"text-sm text-yellow-800"},e.createElement("strong",null,"Note:")," This is a booth marker. Content (name, logo, website, info) is managed via the Companies and Assignments tabs.")),e.createElement("div",{className:"flex gap-3 pt-4 border-t border-gray-200"},e.createElement("button",{onClick:S,className:"flex items-center gap-2 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"},e.createElement(N,{path:oe,size:.9}),"Save Changes"),e.createElement("button",{onClick:h,className:"flex items-center gap-2 px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"},e.createElement(N,{path:se,size:.9}),"Cancel")))}function w({title:t,children:m}){return e.createElement("div",{className:"bg-gray-50 rounded-lg p-4"},e.createElement("h3",{className:"text-lg font-semibold text-gray-900 mb-4"},t),e.createElement("div",{className:"space-y-3"},m))}function g({label:t,value:m,children:p}){return e.createElement("div",null,e.createElement("div",{className:"text-sm font-medium text-gray-700 mb-1"},t),p||e.createElement("div",{className:"text-gray-900"},m||"—"))}function b({label:t,value:m,onChange:p,type:c="text",...s}){const S=c==="color"&&!m?"#000000":m||"";return e.createElement("div",null,e.createElement("label",{className:"block text-sm font-medium text-gray-700 mb-1"},t),e.createElement("input",{type:c,value:S,"aria-label":t,onChange:h=>p(h.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",...s}))}function ue({label:t,value:m,onChange:p}){return e.createElement("div",null,e.createElement("label",{className:"block text-sm font-medium text-gray-700 mb-1"},t),e.createElement("textarea",{value:m||"",onChange:c=>p(c.target.value),rows:4,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}))}export{Ce as default};
