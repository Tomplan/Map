import{r as s}from"./vendor-react-3437b308.js";import{s as i}from"./index-a5e29154.js";function R(a=new Date().getFullYear()){const[g,l]=s.useState([]),[h,f]=s.useState(!0),[k,_]=s.useState(null),y=s.useRef(a);s.useEffect(()=>{y.current=a},[a]);const m=s.useCallback(async e=>{try{f(!0),_(null);const r=e!==void 0?e:y.current,{data:n,error:t}=await i.from("markers_core").select("id").eq("event_year",r);if(t)throw t;const o=(n==null?void 0:n.map(x=>x.id))||[],{data:c,error:u}=await i.from("assignments").select(`
          *,
          company:companies(id, name, logo, website, info, company_translations(language_code, info)),
          marker:markers_core(id, lat, lng)
        `).eq("event_year",r).in("marker_id",o).order("marker_id",{ascending:!0});if(u||(l(c||[]),u))throw u;l(c||[])}catch(r){console.error("Error loading assignments:",r),_(r.message)}finally{f(!1)}},[]),d=s.useCallback(async e=>{try{const r={...e,event_year:e.event_year||a},{data:n,error:t}=await i.from("assignments").insert([r]).select(`
          *,
          company:companies(id, name, logo, website, info, company_translations(language_code, info)),
          marker:markers_core(id, lat, lng)
        `).single();if(t)throw t;return l(o=>[...o,n].sort((c,u)=>c.marker_id-u.marker_id)),{data:n,error:null}}catch(r){return console.error("Error creating assignment:",r),{data:null,error:r.message}}},[a]),p=s.useCallback(async(e,r)=>{try{const{data:n,error:t}=await i.from("assignments").update(r).eq("id",e).select(`
          *,
          company:companies(id, name, logo, website, info, company_translations(language_code, info)),
          marker:markers_core(id, lat, lng)
        `).single();if(t)throw t;return l(o=>o.map(c=>c.id===e?n:c).sort((c,u)=>c.marker_id-u.marker_id)),{data:n,error:null}}catch(n){return console.error("Error updating assignment:",n),{data:null,error:n.message}}},[]),w=s.useCallback(async e=>{try{const{error:r}=await i.from("assignments").delete().eq("id",e);if(r)throw r;return l(n=>n.filter(t=>t.id!==e)),{error:null}}catch(r){return console.error("Error deleting assignment:",r),{error:r.message}}},[]),E=s.useCallback(async(e,r)=>d({marker_id:e,company_id:r}),[d]),b=s.useCallback(async(e,r)=>{try{const{error:n}=await i.from("assignments").delete().eq("marker_id",e).eq("company_id",r).eq("event_year",a);if(n)throw n;return l(t=>t.filter(o=>!(o.marker_id===e&&o.company_id===r))),{error:null}}catch(n){return console.error("Error unassigning company:",n),{error:n.message}}},[a]),C=s.useCallback(e=>g.filter(r=>r.marker_id===e),[g]),A=s.useCallback(e=>g.filter(r=>r.company_id===e),[g]),q=s.useCallback(async()=>{try{const{data:e,error:r}=await i.rpc("archive_assignments",{year_to_archive:a});if(r)throw r;return l([]),{data:e,error:null}}catch(e){return console.error("Error archiving assignments:",e),{data:null,error:e.message}}},[a]),v=s.useCallback(async e=>{try{const{data:r,error:n}=await i.from("assignments_archive").select(`
          *,
          company:companies(id, name, logo, website, info, company_translations(language_code, info))
        `).eq("event_year",e).order("marker_id",{ascending:!0});if(n)throw n;return{data:r,error:null}}catch(r){return console.error("Error loading archived assignments:",r),{data:null,error:r.message}}},[]);return s.useEffect(()=>{m()},[m]),s.useEffect(()=>{m()},[a,m]),s.useEffect(()=>{const e=i.channel(`assignments-changes-${a}`).on("postgres_changes",{event:"*",schema:"public",table:"assignments",filter:`event_year=eq.${a}`},r=>{r.eventType==="INSERT"&&r.new?l(n=>(n.some(o=>o.id===r.new.id)||m(),n)):m()}).subscribe();return()=>{i.removeChannel(e)}},[a,m]),{assignments:g,loading:h,error:k,createAssignment:d,updateAssignment:p,deleteAssignment:w,assignCompanyToMarker:E,unassignCompanyFromMarker:b,getMarkerAssignments:C,getCompanyAssignments:A,archiveCurrentYear:q,loadArchivedAssignments:v,reload:m}}export{R as u};
