import{r as t,s as i}from"./index-46614b82.js";function m(n=new Date().getFullYear()){m.cache||(m.cache=new Map);let e=m.cache.get(n);e||(e={state:{assignments:[],loading:!0,error:null},listeners:new Set,refCount:0,channel:null,reloadTimeout:null,loadPromise:null},m.cache.set(n,e));const[l,g]=t.useState({assignments:e.state.assignments,loading:e.state.loading,error:e.state.error}),f=t.useRef(n);t.useEffect(()=>{f.current=n},[n]);const o=t.useCallback(async(s=!1)=>{if(e.state.assignments.length>0&&!e.state.loading&&!s){l.loading&&g(r=>({...r,loading:!1}));return}return e.loadPromise||(e.state.loading=!0,e.state.error=null,e.listeners.forEach(r=>r(e.state)),e.loadPromise=(async()=>{try{const r=n,{data:a,error:c}=await i.from("markers_core").select("id").eq("event_year",r);if(c)throw c;const b=(a==null?void 0:a.map(A=>A.id))||[],{data:T,error:d}=await i.from("assignments").select(`
            *,
            company:companies(id, name, logo, website, info),
            marker:markers_core(id, lat, lng)

        `).eq("event_year",r).in("marker_id",b).order("marker_id",{ascending:!0});if(d)throw d;e.state.assignments=T||[]}catch(r){console.error("Error loading assignments:",r),e.state.error=r.message}finally{e.state.loading=!1,e.listeners.forEach(r=>r(e.state)),e.loadPromise=null}})()),e.loadPromise},[n]),u=t.useCallback(async s=>{try{const r={...s,event_year:s.event_year||n},{data:a,error:c}=await i.from("assignments").insert([r]).select(`
          *,
            company:companies(id, name, logo, website, info),
            marker:markers_core(id, lat, lng)

        `).single();if(c)throw c;return await o(),{data:a,error:null}}catch(r){return console.error("Error creating assignment:",r),{data:null,error:r.message}}},[n,o]),h=t.useCallback(async(s,r)=>{try{const{data:a,error:c}=await i.from("assignments").update(r).eq("id",s).select(`
          *,
          company:companies(id, name, logo, website, info),
          marker:markers_core(id, lat, lng)
        `).single();if(c)throw c;return await o(),{data:a,error:null}}catch(a){return console.error("Error updating assignment:",a),{data:null,error:a.message}}},[o]),y=t.useCallback(async s=>{try{const{error:r}=await i.from("assignments").delete().eq("id",s);if(r)throw r;return await o(),{error:null}}catch(r){return console.error("Error deleting assignment:",r),{error:r.message}}},[o]),w=t.useCallback(async(s,r)=>u({marker_id:s,company_id:r}),[u]),p=t.useCallback(async(s,r)=>{try{const{error:a}=await i.from("assignments").delete().eq("marker_id",s).eq("company_id",r).eq("event_year",n);if(a)throw a;return await o(),{error:null}}catch(a){return console.error("Error unassigning company:",a),{error:a.message}}},[n,o]),k=t.useCallback(s=>l.assignments.filter(r=>r.marker_id===s),[l.assignments]),_=t.useCallback(s=>l.assignments.filter(r=>r.company_id===s),[l.assignments]),E=t.useCallback(async()=>{try{const{data:s,error:r}=await i.rpc("archive_assignments",{year_to_archive:n});if(r)throw r;return setAssignments([]),{data:s,error:null}}catch(s){return console.error("Error archiving assignments:",s),{data:null,error:s.message}}},[n]),C=t.useCallback(async s=>{try{const{data:r,error:a}=await i.from("assignments_archive").select(`
          *,
          company:companies(id, name, logo, website, info)
        `).eq("event_year",s).order("marker_id",{ascending:!0});if(a)throw a;return{data:r,error:null}}catch(r){return console.error("Error loading archived assignments:",r),{data:null,error:r.message}}},[]);return t.useEffect(()=>{e=m.cache.get(n),e||(e={state:{assignments:[],loading:!0,error:null},listeners:new Set,refCount:0,channel:null,reloadTimeout:null,loadPromise:null},m.cache.set(n,e)),e.refCount+=1;const s=r=>g({assignments:r.assignments,loading:r.loading,error:r.error});return e.listeners.add(s),e.state.assignments.length>0?g({assignments:e.state.assignments,loading:!1,error:e.state.error}):l.assignments!==e.state.assignments&&g({assignments:e.state.assignments,loading:e.state.loading,error:e.state.error}),e.state.assignments.length===0&&(e.loadPromise||o()),e.channel||(e.channel=i.channel(`assignments-changes-${n}`).on("postgres_changes",{event:"*",schema:"public",table:"assignments",filter:`event_year=eq.${n}`},r=>{r.eventType==="INSERT"&&r.new?(e.reloadTimeout&&clearTimeout(e.reloadTimeout),e.reloadTimeout=setTimeout(()=>{o(!0)},500)):(e.reloadTimeout&&clearTimeout(e.reloadTimeout),e.reloadTimeout=setTimeout(()=>{o(!0)},500))}).subscribe()),()=>{e.listeners.delete(s),e.refCount-=1,e.refCount<=0&&(e.channel&&i.removeChannel(e.channel),e.channel=null),e.reloadTimeout&&clearTimeout(e.reloadTimeout)}},[n,o]),{assignments:l.assignments,loading:l.loading,error:l.error,createAssignment:u,updateAssignment:h,deleteAssignment:y,assignCompanyToMarker:w,unassignCompanyFromMarker:p,getMarkerAssignments:k,getCompanyAssignments:_,archiveCurrentYear:E,loadArchivedAssignments:C,reload:o}}export{m as u};
