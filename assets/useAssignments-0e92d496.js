import{r as n,s as i}from"./index-88c468a1.js";function m(f=new Date().getFullYear()){const a=parseInt(f,10);m.cache||(m.cache=new Map);let s=m.cache.get(a);s||(s={state:{assignments:[],loading:!0,error:null},listeners:new Set,refCount:0,channel:null,reloadTimeout:null,loadPromise:null},m.cache.set(a,s));const[c,u]=n.useState({assignments:s.state.assignments,loading:s.state.loading,error:s.state.error}),h=n.useRef(a);n.useEffect(()=>{h.current=a},[a]);const o=n.useCallback(async(e=!1)=>{if(s.state.assignments.length>0&&!s.state.loading&&!e){u(r=>r.loading?{...r,loading:!1}:r);return}return s.loadPromise||(s.state.loading=!0,s.state.error=null,s.listeners.forEach(r=>r(s.state)),s.loadPromise=(async()=>{try{const r=a,{data:t,error:l}=await i.from("markers_core").select("id").eq("event_year",r);if(l)throw l;const v=(t==null?void 0:t.map(A=>A.id))||[],{data:T,error:d}=await i.from("assignments").select(`
            *,
            company:companies(id, name, logo, website, info),
            marker:markers_core(id, lat, lng)

        `).eq("event_year",r).in("marker_id",v).order("marker_id",{ascending:!0});if(d)throw d;s.state.assignments=T||[]}catch(r){console.error("Error loading assignments:",r),s.state.error=r.message}finally{s.state.loading=!1,s.listeners.forEach(r=>r(s.state)),s.loadPromise=null}})()),s.loadPromise},[a,s]),g=n.useCallback(async e=>{try{const r={...e,event_year:e.event_year||a},{data:t,error:l}=await i.from("assignments").insert([r]).select(`
          *,
            company:companies(id, name, logo, website, info),
            marker:markers_core(id, lat, lng)

        `).single();if(l)throw l;return await o(!0),{data:t,error:null}}catch(r){return console.error("Error creating assignment:",r),{data:null,error:r.message}}},[a,o]),y=n.useCallback(async(e,r)=>{try{const{data:t,error:l}=await i.from("assignments").update(r).eq("id",e).select(`
          *,
          company:companies(id, name, logo, website, info),
          marker:markers_core(id, lat, lng)
        `).single();if(l)throw l;return await o(!0),{data:t,error:null}}catch(t){return console.error("Error updating assignment:",t),{data:null,error:t.message}}},[o]),w=n.useCallback(async e=>{try{const{error:r}=await i.from("assignments").delete().eq("id",e);if(r)throw r;return await o(!0),{error:null}}catch(r){return console.error("Error deleting assignment:",r),{error:r.message}}},[o]),k=n.useCallback(async(e,r)=>g({marker_id:e,company_id:r}),[g]),p=n.useCallback(async(e,r)=>{try{const{error:t}=await i.from("assignments").delete().eq("marker_id",e).eq("company_id",r).eq("event_year",a);if(t)throw t;return await o(!0),{error:null}}catch(t){return console.error("Error unassigning company:",t),{error:t.message}}},[a,o]),_=n.useCallback(e=>c.assignments.filter(r=>r.marker_id===e),[c.assignments]),E=n.useCallback(e=>c.assignments.filter(r=>r.company_id===e),[c.assignments]),b=n.useCallback(async()=>{try{const{data:e,error:r}=await i.rpc("archive_assignments",{year_to_archive:a});if(r)throw r;return setAssignments([]),{data:e,error:null}}catch(e){return console.error("Error archiving assignments:",e),{data:null,error:e.message}}},[a]),C=n.useCallback(async e=>{try{const{data:r,error:t}=await i.from("assignments_archive").select(`
          *,
          company:companies(id, name, logo, website, info)
        `).eq("event_year",e).order("marker_id",{ascending:!0});if(t)throw t;return{data:r,error:null}}catch(r){return console.error("Error loading archived assignments:",r),{data:null,error:r.message}}},[]);return n.useEffect(()=>{const e=m.cache.get(a);if(!e)return;e.refCount+=1;const r=t=>u({assignments:t.assignments,loading:t.loading,error:t.error});return e.listeners.add(r),e.state.assignments.length>0?u({assignments:e.state.assignments,loading:!1,error:e.state.error}):u(t=>t.assignments===e.state.assignments?t:{assignments:e.state.assignments,loading:e.state.loading,error:e.state.error}),e.state.assignments.length===0&&(e.loadPromise||o()),e.channel||(e.channel=i.channel(`assignments-changes-${a}`).on("postgres_changes",{event:"*",schema:"public",table:"assignments",filter:`event_year=eq.${a}`},t=>{t.eventType==="INSERT"&&t.new?(e.reloadTimeout&&clearTimeout(e.reloadTimeout),e.reloadTimeout=setTimeout(()=>{o(!0)},500)):(e.reloadTimeout&&clearTimeout(e.reloadTimeout),e.reloadTimeout=setTimeout(()=>{o(!0)},500))}).subscribe()),()=>{e.listeners.delete(r),e.refCount-=1,e.refCount<=0&&(e.channel&&i.removeChannel(e.channel),e.channel=null),e.reloadTimeout&&clearTimeout(e.reloadTimeout)}},[a,o]),{assignments:c.assignments,loading:c.loading,error:c.error,createAssignment:g,updateAssignment:y,deleteAssignment:w,assignCompanyToMarker:k,unassignCompanyFromMarker:p,getMarkerAssignments:_,getCompanyAssignments:E,archiveCurrentYear:b,loadArchivedAssignments:C,reload:o}}export{m as u};
