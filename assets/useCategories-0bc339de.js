import{r as u,s as c,aZ as _,a_ as A,a$ as q,b0 as O,b1 as P,b2 as H,b3 as N,Q as x,b4 as j,b5 as z}from"./index-630dcafa.js";const p={mdiCarOutline:A,mdiTent:q,mdiTrailer:O,mdiCarCog:P,mdiAirplane:H,mdiHomeCity:N,mdiAccountGroup:x,mdiTerrainIcon:j,mdiCellphone:z,mdiDotsHorizontal:_};function m(g="nl"){const f=`categories:${g||"nl"}`;m.cache||(m.cache=new Map),m.cache.has(f)||m.cache.set(f,{state:{categories:[],loading:!0,error:null,categoryStats:{}},listeners:new Set,refCount:0,channel:null,statsChannel:null,loadPromise:null,statsLoadPromise:null});const e=m.cache.get(f),[d,h]=u.useState({categories:e.state.categories,loading:e.state.loading,error:e.state.error,categoryStats:e.state.categoryStats}),l=u.useCallback(async(a=!1)=>{var r;if(e.state.categories.length>0&&!e.state.loading&&!a){d.loading&&h(t=>({...t,loading:!1}));return}try{e.state.loading=!0,e.state.error=null;const{data:t,error:s}=await c.from("categories").select(`
          id,
          slug,
          icon,
          color,
          sort_order,
          active,
          category_translations(
            language,
            name,
            description
          )
        `).eq("active",!0).order("sort_order");if(s)throw s;const n=(t||[]).map(o=>{const i=o.category_translations.find(y=>y.language===g)||o.category_translations.find(y=>y.language==="nl")||o.category_translations[0];return{id:o.id,slug:o.slug,icon:p[o.icon]||_,iconName:o.icon,color:o.color,sort_order:o.sort_order,active:o.active,name:(i==null?void 0:i.name)||o.slug,description:(i==null?void 0:i.description)||"",translations:o.category_translations}});e.state.categories=n,e.state.error=null}catch(t){console.error("Error loading categories:",t),e.state.error=t.message,((r=t.message)!=null&&r.includes("does not exist")||t.code==="42P01")&&(console.warn("Categories table not found. Please run migration 007."),e.state.categories=[])}finally{e.state.loading=!1,e.listeners.forEach(t=>t(e.state))}},[g]),C=u.useCallback(async()=>{try{const{data:a,error:r}=await c.from("company_categories").select("category_id");if(r)throw r;const t={};return a.forEach(s=>{t[s.category_id]||(t[s.category_id]=0),t[s.category_id]++}),e.state.categoryStats=t,e.listeners.forEach(s=>s(e.state)),t}catch(a){return console.error("Error loading category stats:",a),e.state.categoryStats={},e.listeners.forEach(r=>r(e.state)),{}}},[]);u.useEffect(()=>{e.refCount+=1;const a=r=>h({categories:r.categories,loading:r.loading,error:r.error,categoryStats:r.categoryStats});return e.listeners.add(a),h({categories:e.state.categories,loading:e.state.loading,error:e.state.error,categoryStats:e.state.categoryStats}),d.loading!==e.state.loading&&h({categories:e.state.categories,loading:e.state.loading,error:e.state.error,categoryStats:e.state.categoryStats}),e.state.loading&&e.refCount===1&&l(),e.channel||(e.channel=c.channel("categories-changes").on("postgres_changes",{event:"*",schema:"public",table:"categories"},()=>l()).on("postgres_changes",{event:"*",schema:"public",table:"category_translations"},()=>l()).subscribe()),e.statsChannel||(e.statsChannel=c.channel("company-categories-stats").on("postgres_changes",{event:"*",schema:"public",table:"company_categories"},()=>C()).subscribe()),()=>{e.listeners.delete(a),e.refCount-=1,e.refCount<=0&&(e.channel&&(c.removeChannel(e.channel),e.channel=null),e.statsChannel&&(c.removeChannel(e.statsChannel),e.statsChannel=null))}},[f,l,C]);const w=async a=>{try{const{data:r,error:t}=await c.from("categories").insert({slug:a.slug,icon:a.icon,color:a.color,sort_order:a.sort_order||0}).select().single();if(t)throw t;const s=Object.entries(a.translations||{}).map(([n,o])=>({category_id:r.id,language:n,name:o.name,description:o.description||null}));if(s.length>0){const{error:n}=await c.from("category_translations").insert(s);if(n)throw n}return await l(),{success:!0,data:r}}catch(r){return console.error("Error creating category:",r),{success:!1,error:r.message}}},b=async(a,r)=>{try{const{error:t}=await c.from("categories").update({slug:r.slug,icon:r.icon,color:r.color,sort_order:r.sort_order,active:r.active}).eq("id",a);if(t)throw t;if(r.translations)for(const[s,n]of Object.entries(r.translations)){const{error:o}=await c.from("category_translations").upsert({category_id:a,language:s,name:n.name,description:n.description||null},{onConflict:"category_id,language"});if(o)throw o}return await l(),{success:!0}}catch(t){return console.error("Error updating category:",t),{success:!1,error:t.message}}},E=async a=>{try{const{error:r}=await c.from("categories").delete().eq("id",a);if(r)throw r;return await l(),{success:!0}}catch(r){return console.error("Error deleting category:",r),{success:!1,error:r.message}}},S=u.useCallback(async a=>{try{const{data:r,error:t}=await c.from("company_categories").select(`
          category_id,
          categories(
            id,
            slug,
            icon,
            color,
            category_translations(language, name)
          )
        `).eq("company_id",a);if(t)throw t;return r.map(s=>{const n=s.categories,o=n.category_translations.find(i=>i.language===g)||n.category_translations[0];return{id:n.id,slug:n.slug,icon:p[n.icon]||_,iconName:n.icon,color:n.color,name:(o==null?void 0:o.name)||n.slug}})}catch(r){return console.error("Error fetching company categories:",r),[]}},[g]),v=u.useCallback(async a=>{try{const{data:r,error:t}=await c.from("company_categories").select(`
          company_id,
          category_id,
          categories(
            id,
            slug,
            icon,
            color,
            category_translations(language, name)
          )
        `).in("company_id",a);if(t)throw t;const s={};return r.forEach(n=>{s[n.company_id]||(s[n.company_id]=[]);const o=n.categories,i=o.category_translations.find(y=>y.language===g)||o.category_translations[0];s[n.company_id].push({id:o.id,slug:o.slug,icon:p[o.icon]||_,iconName:o.icon,color:o.color,name:(i==null?void 0:i.name)||o.slug})}),s}catch(r){return console.error("Error fetching all company categories:",r),{}}},[g]),T=async(a,r)=>{try{if(await c.from("company_categories").delete().eq("company_id",a),r.length>0){const t=r.map(n=>({company_id:a,category_id:n})),{error:s}=await c.from("company_categories").insert(t);if(s)throw s}return{success:!0}}catch(t){return console.error("Error assigning categories:",t),{success:!1,error:t.message}}},k=async()=>{try{const{data:a,error:r}=await c.from("company_categories").select("category_id");if(r)throw r;const t={};return a.forEach(s=>{t[s.category_id]||(t[s.category_id]=0),t[s.category_id]++}),setCategoryStats(t),t}catch(a){return console.error("Error fetching category stats:",a),{}}};return{categories:d.categories,loading:d.loading,error:d.error,createCategory:w,updateCategory:b,deleteCategory:E,getCompanyCategories:S,getAllCompanyCategories:v,assignCategoriesToCompany:T,getCategoryStats:k,categoryStats:d.categoryStats,refetch:l}}export{m as u};
