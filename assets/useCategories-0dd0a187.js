import{r as d,s as c,aZ as f,a_ as A,a$ as q,b0 as O,b1 as P,b2 as H,b3 as N,Q as x,b4 as j,b5 as z}from"./index-9f8e3d41.js";const h={mdiCarOutline:A,mdiTent:q,mdiTrailer:O,mdiCarCog:P,mdiAirplane:H,mdiHomeCity:N,mdiAccountGroup:x,mdiTerrainIcon:j,mdiCellphone:z,mdiDotsHorizontal:f};function u(g="nl"){const y=`categories:${g||"nl"}`;u.cache||(u.cache=new Map),u.cache.has(y)||u.cache.set(y,{state:{categories:[],loading:!0,error:null,categoryStats:{}},listeners:new Set,refCount:0,channel:null,statsChannel:null,loadPromise:null,statsLoadPromise:null});const r=u.cache.get(y),[m,_]=d.useState({categories:r.state.categories,loading:r.state.loading,error:r.state.error,categoryStats:r.state.categoryStats}),l=d.useCallback(async()=>{var a;try{r.state.loading=!0,r.state.error=null;const{data:e,error:o}=await c.from("categories").select(`
          id,
          slug,
          icon,
          color,
          sort_order,
          active,
          category_translations(
            language,
            name,
            description
          )
        `).eq("active",!0).order("sort_order");if(o)throw o;const s=(e||[]).map(t=>{const n=t.category_translations.find(i=>i.language===g)||t.category_translations.find(i=>i.language==="nl")||t.category_translations[0];return{id:t.id,slug:t.slug,icon:h[t.icon]||f,iconName:t.icon,color:t.color,sort_order:t.sort_order,active:t.active,name:(n==null?void 0:n.name)||t.slug,description:(n==null?void 0:n.description)||"",translations:t.category_translations}});r.state.categories=s,r.state.error=null}catch(e){console.error("Error loading categories:",e),r.state.error=e.message,((a=e.message)!=null&&a.includes("does not exist")||e.code==="42P01")&&(console.warn("Categories table not found. Please run migration 007."),r.state.categories=[])}finally{r.state.loading=!1,r.listeners.forEach(e=>e(r.state))}},[g]),p=d.useCallback(async()=>{try{const{data:a,error:e}=await c.from("company_categories").select("category_id");if(e)throw e;const o={};return a.forEach(s=>{o[s.category_id]||(o[s.category_id]=0),o[s.category_id]++}),r.state.categoryStats=o,r.listeners.forEach(s=>s(r.state)),o}catch(a){return console.error("Error loading category stats:",a),r.state.categoryStats={},r.listeners.forEach(e=>e(r.state)),{}}},[]);d.useEffect(()=>{r.refCount+=1;const a=e=>_({categories:e.categories,loading:e.loading,error:e.error,categoryStats:e.categoryStats});return r.listeners.add(a),_({categories:r.state.categories,loading:r.state.loading,error:r.state.error,categoryStats:r.state.categoryStats}),r.state.loading&&r.refCount===1&&l(),r.channel||(r.channel=c.channel("categories-changes").on("postgres_changes",{event:"*",schema:"public",table:"categories"},()=>l()).on("postgres_changes",{event:"*",schema:"public",table:"category_translations"},()=>l()).subscribe()),r.statsChannel||(r.statsChannel=c.channel("company-categories-stats").on("postgres_changes",{event:"*",schema:"public",table:"company_categories"},()=>p()).subscribe()),()=>{r.listeners.delete(a),r.refCount-=1,r.refCount<=0&&(r.channel&&c.removeChannel(r.channel),r.statsChannel&&c.removeChannel(r.statsChannel),u.cache.delete(y))}},[y,l,p]);const C=async a=>{try{const{data:e,error:o}=await c.from("categories").insert({slug:a.slug,icon:a.icon,color:a.color,sort_order:a.sort_order||0}).select().single();if(o)throw o;const s=Object.entries(a.translations||{}).map(([t,n])=>({category_id:e.id,language:t,name:n.name,description:n.description||null}));if(s.length>0){const{error:t}=await c.from("category_translations").insert(s);if(t)throw t}return await l(),{success:!0,data:e}}catch(e){return console.error("Error creating category:",e),{success:!1,error:e.message}}},w=async(a,e)=>{try{const{error:o}=await c.from("categories").update({slug:e.slug,icon:e.icon,color:e.color,sort_order:e.sort_order,active:e.active}).eq("id",a);if(o)throw o;if(e.translations)for(const[s,t]of Object.entries(e.translations)){const{error:n}=await c.from("category_translations").upsert({category_id:a,language:s,name:t.name,description:t.description||null},{onConflict:"category_id,language"});if(n)throw n}return await l(),{success:!0}}catch(o){return console.error("Error updating category:",o),{success:!1,error:o.message}}},b=async a=>{try{const{error:e}=await c.from("categories").delete().eq("id",a);if(e)throw e;return await l(),{success:!0}}catch(e){return console.error("Error deleting category:",e),{success:!1,error:e.message}}},E=d.useCallback(async a=>{try{const{data:e,error:o}=await c.from("company_categories").select(`
          category_id,
          categories(
            id,
            slug,
            icon,
            color,
            category_translations(language, name)
          )
        `).eq("company_id",a);if(o)throw o;return e.map(s=>{const t=s.categories,n=t.category_translations.find(i=>i.language===g)||t.category_translations[0];return{id:t.id,slug:t.slug,icon:h[t.icon]||f,iconName:t.icon,color:t.color,name:(n==null?void 0:n.name)||t.slug}})}catch(e){return console.error("Error fetching company categories:",e),[]}},[g]),S=d.useCallback(async a=>{try{const{data:e,error:o}=await c.from("company_categories").select(`
          company_id,
          category_id,
          categories(
            id,
            slug,
            icon,
            color,
            category_translations(language, name)
          )
        `).in("company_id",a);if(o)throw o;const s={};return e.forEach(t=>{s[t.company_id]||(s[t.company_id]=[]);const n=t.categories,i=n.category_translations.find(k=>k.language===g)||n.category_translations[0];s[t.company_id].push({id:n.id,slug:n.slug,icon:h[n.icon]||f,iconName:n.icon,color:n.color,name:(i==null?void 0:i.name)||n.slug})}),s}catch(e){return console.error("Error fetching all company categories:",e),{}}},[g]),v=async(a,e)=>{try{if(await c.from("company_categories").delete().eq("company_id",a),e.length>0){const o=e.map(t=>({company_id:a,category_id:t})),{error:s}=await c.from("company_categories").insert(o);if(s)throw s}return{success:!0}}catch(o){return console.error("Error assigning categories:",o),{success:!1,error:o.message}}},T=async()=>{try{const{data:a,error:e}=await c.from("company_categories").select("category_id");if(e)throw e;const o={};return a.forEach(s=>{o[s.category_id]||(o[s.category_id]=0),o[s.category_id]++}),setCategoryStats(o),o}catch(a){return console.error("Error fetching category stats:",a),{}}};return{categories:m.categories,loading:m.loading,error:m.error,createCategory:C,updateCategory:w,deleteCategory:b,getCompanyCategories:E,getAllCompanyCategories:S,assignCategoriesToCompany:v,getCategoryStats:T,categoryStats:m.categoryStats,refetch:l}}export{u};
