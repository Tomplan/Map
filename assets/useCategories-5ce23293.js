import{r as d,s as c,b5 as h,b6 as q,b7 as v,b8 as O,b9 as P,ba as H,bb as N,Q as x,bc as j,bd as z}from"./index-c3c9ac92.js";const C={mdiCarOutline:q,mdiTent:v,mdiTrailer:O,mdiCarCog:P,mdiAirplane:H,mdiHomeCity:N,mdiAccountGroup:x,mdiTerrainIcon:j,mdiCellphone:z,mdiDotsHorizontal:h};function y(g="nl"){const m=`categories:${g||"nl"}`;y.cache||(y.cache=new Map),y.cache.has(m)||y.cache.set(m,{state:{categories:[],loading:!0,error:null,categoryStats:{}},listeners:new Set,refCount:0,channel:null,statsChannel:null,loadPromise:null,statsLoadPromise:null});const r=y.cache.get(m),[f,_]=d.useState({categories:r.state.categories,loading:r.state.loading,error:r.state.error,categoryStats:r.state.categoryStats}),l=d.useCallback(async(a=!1)=>{var e;if(r.state.categories.length>0&&!r.state.loading&&!a){_(t=>t.loading?{...t,loading:!1}:t);return}try{r.state.loading=!0,r.state.error=null;const{data:t,error:s}=await c.from("categories").select(`
          id,
          slug,
          icon,
          color,
          sort_order,
          active,
          category_translations(
            language,
            name,
            description
          )
        `).eq("active",!0).order("sort_order");if(s)throw s;const n=(t||[]).map(o=>{const i=o.category_translations.find(u=>u.language===g)||o.category_translations.find(u=>u.language==="nl")||o.category_translations[0];return{id:o.id,slug:o.slug,icon:C[o.icon]||h,iconName:o.icon,color:o.color,sort_order:o.sort_order,active:o.active,name:(i==null?void 0:i.name)||o.slug,description:(i==null?void 0:i.description)||"",translations:o.category_translations}});r.state.categories=n,r.state.error=null}catch(t){console.error("Error loading categories:",t),r.state.error=t.message,((e=t.message)!=null&&e.includes("does not exist")||t.code==="42P01")&&(console.warn("Categories table not found. Please run migration 007."),r.state.categories=[])}finally{r.state.loading=!1,r.listeners.forEach(t=>t(r.state))}},[g,r]),p=d.useCallback(async()=>{try{const{data:a,error:e}=await c.from("company_categories").select("category_id");if(e)throw e;const t={};return a.forEach(s=>{t[s.category_id]||(t[s.category_id]=0),t[s.category_id]++}),r.state.categoryStats=t,r.listeners.forEach(s=>s(r.state)),t}catch(a){return console.error("Error loading category stats:",a),r.state.categoryStats={},r.listeners.forEach(e=>e(r.state)),{}}},[r]);d.useEffect(()=>{r.refCount+=1;const a=e=>_({categories:e.categories,loading:e.loading,error:e.error,categoryStats:e.categoryStats});return r.listeners.add(a),_(e=>e.categories===r.state.categories&&e.loading===r.state.loading&&e.error===r.state.error&&e.categoryStats===r.state.categoryStats?e:{categories:r.state.categories,loading:r.state.loading,error:r.state.error,categoryStats:r.state.categoryStats}),r.state.loading&&r.refCount===1&&l(),r.channel||(r.channel=c.channel("categories-changes").on("postgres_changes",{event:"*",schema:"public",table:"categories"},()=>l()).on("postgres_changes",{event:"*",schema:"public",table:"category_translations"},()=>l()).subscribe()),r.statsChannel||(r.statsChannel=c.channel("company-categories-stats").on("postgres_changes",{event:"*",schema:"public",table:"company_categories"},()=>p()).subscribe()),()=>{r.listeners.delete(a),r.refCount-=1,r.refCount<=0&&(r.channel&&(c.removeChannel(r.channel),r.channel=null),r.statsChannel&&(c.removeChannel(r.statsChannel),r.statsChannel=null))}},[m,r,l,p]);const w=async a=>{try{const{data:e,error:t}=await c.from("categories").insert({slug:a.slug,icon:a.icon,color:a.color,sort_order:a.sort_order||0}).select().single();if(t)throw t;const s=Object.entries(a.translations||{}).map(([n,o])=>({category_id:e.id,language:n,name:o.name,description:o.description||null}));if(s.length>0){const{error:n}=await c.from("category_translations").insert(s);if(n)throw n}return await l(),{success:!0,data:e}}catch(e){return console.error("Error creating category:",e),{success:!1,error:e.message}}},b=async(a,e)=>{try{const{error:t}=await c.from("categories").update({slug:e.slug,icon:e.icon,color:e.color,sort_order:e.sort_order,active:e.active}).eq("id",a);if(t)throw t;if(e.translations)for(const[s,n]of Object.entries(e.translations)){const{error:o}=await c.from("category_translations").upsert({category_id:a,language:s,name:n.name,description:n.description||null},{onConflict:"category_id,language"});if(o)throw o}return await l(),{success:!0}}catch(t){return console.error("Error updating category:",t),{success:!1,error:t.message}}},E=async a=>{try{const{error:e}=await c.from("categories").delete().eq("id",a);if(e)throw e;return await l(),{success:!0}}catch(e){return console.error("Error deleting category:",e),{success:!1,error:e.message}}},S=d.useCallback(async a=>{try{const{data:e,error:t}=await c.from("company_categories").select(`
          category_id,
          categories(
            id,
            slug,
            icon,
            color,
            category_translations(language, name)
          )
        `).eq("company_id",a);if(t)throw t;return e.map(s=>{const n=s.categories,o=n.category_translations.find(i=>i.language===g)||n.category_translations[0];return{id:n.id,slug:n.slug,icon:C[n.icon]||h,iconName:n.icon,color:n.color,name:(o==null?void 0:o.name)||n.slug}})}catch(e){return console.error("Error fetching company categories:",e),[]}},[g]),T=d.useCallback(async a=>{try{const{data:e,error:t}=await c.from("company_categories").select(`
          company_id,
          category_id,
          categories(
            id,
            slug,
            icon,
            color,
            category_translations(language, name)
          )
        `).in("company_id",a);if(t)throw t;const s={};return e.forEach(n=>{s[n.company_id]||(s[n.company_id]=[]);const o=n.categories,i=o.category_translations.find(u=>u.language===g)||o.category_translations[0];s[n.company_id].push({id:o.id,slug:o.slug,icon:C[o.icon]||h,iconName:o.icon,color:o.color,name:(i==null?void 0:i.name)||o.slug})}),s}catch(e){return console.error("Error fetching all company categories:",e),{}}},[g]),k=async(a,e)=>{try{if(await c.from("company_categories").delete().eq("company_id",a),e.length>0){const t=e.map(n=>({company_id:a,category_id:n})),{error:s}=await c.from("company_categories").insert(t);if(s)throw s}return{success:!0}}catch(t){return console.error("Error assigning categories:",t),{success:!1,error:t.message}}},A=async()=>{try{const{data:a,error:e}=await c.from("company_categories").select("category_id");if(e)throw e;const t={};return a.forEach(s=>{t[s.category_id]||(t[s.category_id]=0),t[s.category_id]++}),setCategoryStats(t),t}catch(a){return console.error("Error fetching category stats:",a),{}}};return{categories:f.categories,loading:f.loading,error:f.error,createCategory:w,updateCategory:b,deleteCategory:E,getCompanyCategories:S,getAllCompanyCategories:T,assignCategoriesToCompany:k,getCategoryStats:A,categoryStats:f.categoryStats,refetch:l}}export{y as u};
