import{r as n,s as c}from"./index-4ec74ce4.js";import{n as C}from"./phone-376c158e.js";function S(){const[a,m]=n.useState([]),[g,f]=n.useState(!0),[w,h]=n.useState(null),l=n.useRef(null),i=n.useCallback(async()=>{try{l.current&&(clearTimeout(l.current),l.current=null),f(!0),h(null);const{data:e,error:r}=await c.from("companies").select("*").order("name",{ascending:!0});if(r)throw r;m(e||[])}catch(e){console.error("Error loading companies:",e),h(e.message)}finally{f(!1)}},[]),E=n.useCallback(async e=>{try{e!=null&&e.phone&&(e.phone=C(e.phone)),e!=null&&e.email&&(e.email=e.email.toLowerCase().trim());const{data:r,error:o}=await c.from("companies").insert([e]).select().single();if(o)throw o;return m(t=>[...t,r].sort((u,s)=>u.name.localeCompare(s.name))),{data:r,error:null}}catch(r){return console.error("Error creating company:",r),{data:null,error:r.message}}},[]),b=n.useCallback(async(e,r)=>{try{(r!=null&&r.phone||(r==null?void 0:r.phone)==="")&&(r.phone=C(r.phone)),r!=null&&r.email&&(r.email=r.email.toLowerCase().trim());const{data:o,error:t}=await c.from("companies").update(r).eq("id",e).select().single();if(t)throw t;return m(u=>u.map(s=>s.id===e?o:s).sort((s,k)=>s.name.localeCompare(k.name))),{data:o,error:null}}catch(o){return console.error("Error updating company:",o),{data:null,error:o.message}}},[]),p=n.useCallback(async e=>{try{const{error:r}=await c.from("companies").delete().eq("id",e);if(r)throw r;return m(o=>o.filter(t=>t.id!==e)),{error:null}}catch(r){return console.error("Error deleting company:",r),{error:r.message}}},[]),d=n.useCallback(e=>{if(!e)return a;const r=e.toLowerCase();return a.filter(o=>{var t;return(t=o.name)==null?void 0:t.toLowerCase().includes(r)})},[a]);return n.useEffect(()=>{i()},[i]),n.useEffect(()=>{const e=c.channel("companies-changes").on("postgres_changes",{event:"*",schema:"public",table:"companies"},()=>{l.current&&clearTimeout(l.current),l.current=setTimeout(()=>{i()},500)}).subscribe();return()=>{l.current&&clearTimeout(l.current),c.removeChannel(e)}},[i]),{companies:a,loading:g,error:w,createCompany:E,updateCompany:b,deleteCompany:p,searchCompanies:d,reload:i}}export{S as u};
