import{r as i,s as u}from"./index-12ba77bc.js";import{n as d}from"./phone-376c158e.js";const E={state:{companies:[],loading:!0,error:null},listeners:new Set,refCount:0,loadPromise:null,reloadTimeout:null};c.cache||(c.cache=E);function c(){c.cache||(c.cache={state:{companies:[],loading:!0,error:null},listeners:new Set,refCount:0,loadPromise:null,reloadTimeout:null});const r=c.cache,[m,f]=i.useState({companies:r.state.companies,loading:r.state.loading,error:r.state.error}),l=i.useCallback(async(o=!1)=>{const e=c.cache;return e.loadPromise?e.loadPromise:e.state.companies.length>0&&!e.state.loading&&!o?(f(t=>t.loading?{...t,loading:!1}:t),Promise.resolve()):(e.loadPromise=(async()=>{try{e.reloadTimeout&&(clearTimeout(e.reloadTimeout),e.reloadTimeout=null),e.state.loading=!0,e.state.error=null;const{data:t,error:n}=await u.from("companies").select("*").order("name",{ascending:!0});if(n)throw n;e.state.companies=t||[]}catch(t){console.error("Error loading companies:",t),e.state.error=t.message}finally{e.state.loading=!1,e.listeners.forEach(t=>t(e.state)),e.loadPromise=null}})(),e.loadPromise)},[]),h=i.useCallback(async o=>{try{o!=null&&o.phone&&(o.phone=d(o.phone)),o!=null&&o.email&&(o.email=o.email.toLowerCase().trim());const{data:e,error:t}=await u.from("companies").insert([o]).select().single();if(t)throw t;const n=[...r.state.companies,e].sort((a,s)=>a.name.localeCompare(s.name));return r.state.companies=n,r.listeners.forEach(a=>a(r.state)),{data:e,error:null}}catch(e){return console.error("Error creating company:",e),{data:null,error:e.message}}},[r]),g=i.useCallback(async(o,e)=>{try{(e!=null&&e.phone||(e==null?void 0:e.phone)==="")&&(e.phone=d(e.phone)),e!=null&&e.email&&(e.email=e.email.toLowerCase().trim());const{data:t,error:n}=await u.from("companies").update(e).eq("id",o).select().single();if(n)throw n;const a=r.state.companies.map(s=>s.id===o?t:s).sort((s,w)=>s.name.localeCompare(w.name));return r.state.companies=a,r.listeners.forEach(s=>s(r.state)),{data:t,error:null}}catch(t){return console.error("Error updating company:",t),{data:null,error:t.message}}},[r]),p=i.useCallback(async o=>{try{const{error:e}=await u.from("companies").delete().eq("id",o);if(e)throw e;const t=r.state.companies.filter(n=>n.id!==o);return r.state.companies=t,r.listeners.forEach(n=>n(r.state)),{error:null}}catch(e){return console.error("Error deleting company:",e),{error:e.message}}},[r]),C=i.useCallback(o=>{const e=m.companies||[];if(!o)return e;const t=o.toLowerCase();return e.filter(n=>{var a;return(a=n.name)==null?void 0:a.toLowerCase().includes(t)})},[m]);return i.useEffect(()=>{r.refCount+=1;const o=e=>{f({companies:e.companies,loading:e.loading,error:e.error})};return r.listeners.add(o),r.state.companies.length>0?f({companies:r.state.companies,loading:!1,error:r.state.error}):f(e=>e.companies===r.state.companies?e:{companies:r.state.companies,loading:r.state.loading,error:r.state.error}),r.state.companies.length===0&&(!r.state.loading&&!r.loadPromise||r.state.loading&&!r.loadPromise||r.refCount===1&&!r.loadPromise)&&l(),r.channel||(r.channel=u.channel("companies-changes").on("postgres_changes",{event:"*",schema:"public",table:"companies"},()=>{r.reloadTimeout&&clearTimeout(r.reloadTimeout),r.reloadTimeout=setTimeout(()=>{l(!0)},500)}).subscribe()),()=>{r.listeners.delete(o),r.refCount-=1,r.reloadTimeout&&clearTimeout(r.reloadTimeout)}},[r,l]),{companies:m.companies,loading:m.loading,error:m.error,createCompany:h,updateCompany:g,deleteCompany:p,searchCompanies:C,reload:l}}export{c as u};
