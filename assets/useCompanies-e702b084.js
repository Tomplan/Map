import{r as l,s as f}from"./index-46614b82.js";import{n as d}from"./phone-376c158e.js";const E={state:{companies:[],loading:!0,error:null},listeners:new Set,refCount:0,loadPromise:null,reloadTimeout:null};m.cache||(m.cache=E);function m(){m.cache||(m.cache={state:{companies:[],loading:!0,error:null},listeners:new Set,refCount:0,loadPromise:null,reloadTimeout:null});const r=m.cache,[i,u]=l.useState({companies:r.state.companies,loading:r.state.loading,error:r.state.error}),c=l.useCallback(async(o=!1)=>{const e=m.cache;return e.loadPromise?e.loadPromise:e.state.companies.length>0&&!e.state.loading&&!o?(i.loading&&u(t=>({...t,loading:!1})),Promise.resolve()):(e.loadPromise=(async()=>{try{e.reloadTimeout&&(clearTimeout(e.reloadTimeout),e.reloadTimeout=null),e.state.loading=!0,e.state.error=null;const{data:t,error:n}=await f.from("companies").select("*").order("name",{ascending:!0});if(n)throw n;e.state.companies=t||[]}catch(t){console.error("Error loading companies:",t),e.state.error=t.message}finally{e.state.loading=!1,e.listeners.forEach(t=>t(e.state)),e.loadPromise=null}})(),e.loadPromise)},[]),h=l.useCallback(async o=>{try{o!=null&&o.phone&&(o.phone=d(o.phone)),o!=null&&o.email&&(o.email=o.email.toLowerCase().trim());const{data:e,error:t}=await f.from("companies").insert([o]).select().single();if(t)throw t;const n=[...r.state.companies,e].sort((a,s)=>a.name.localeCompare(s.name));return r.state.companies=n,r.listeners.forEach(a=>a(r.state)),{data:e,error:null}}catch(e){return console.error("Error creating company:",e),{data:null,error:e.message}}},[]),g=l.useCallback(async(o,e)=>{try{(e!=null&&e.phone||(e==null?void 0:e.phone)==="")&&(e.phone=d(e.phone)),e!=null&&e.email&&(e.email=e.email.toLowerCase().trim());const{data:t,error:n}=await f.from("companies").update(e).eq("id",o).select().single();if(n)throw n;const a=r.state.companies.map(s=>s.id===o?t:s).sort((s,w)=>s.name.localeCompare(w.name));return r.state.companies=a,r.listeners.forEach(s=>s(r.state)),{data:t,error:null}}catch(t){return console.error("Error updating company:",t),{data:null,error:t.message}}},[]),p=l.useCallback(async o=>{try{const{error:e}=await f.from("companies").delete().eq("id",o);if(e)throw e;const t=r.state.companies.filter(n=>n.id!==o);return r.state.companies=t,r.listeners.forEach(n=>n(r.state)),{error:null}}catch(e){return console.error("Error deleting company:",e),{error:e.message}}},[]),C=l.useCallback(o=>{const e=i.companies||[];if(!o)return e;const t=o.toLowerCase();return e.filter(n=>{var a;return(a=n.name)==null?void 0:a.toLowerCase().includes(t)})},[i]);return l.useEffect(()=>{r.refCount+=1;const o=e=>{u({companies:e.companies,loading:e.loading,error:e.error})};return r.listeners.add(o),r.state.companies.length>0?u({companies:r.state.companies,loading:!1,error:r.state.error}):i.companies!==r.state.companies&&u({companies:r.state.companies,loading:r.state.loading,error:r.state.error}),r.state.companies.length===0&&(!r.state.loading&&!r.loadPromise||r.state.loading&&!r.loadPromise||r.refCount===1&&!r.loadPromise)&&c(),r.channel||(r.channel=f.channel("companies-changes").on("postgres_changes",{event:"*",schema:"public",table:"companies"},()=>{r.reloadTimeout&&clearTimeout(r.reloadTimeout),r.reloadTimeout=setTimeout(()=>{c(!0)},500)}).subscribe()),()=>{r.listeners.delete(o),r.refCount-=1,r.reloadTimeout&&clearTimeout(r.reloadTimeout)}},[c]),{companies:i.companies,loading:i.loading,error:i.error,createCompany:h,updateCompany:g,deleteCompany:p,searchCompanies:C,reload:c}}export{m as u};
