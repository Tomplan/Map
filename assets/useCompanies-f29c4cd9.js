import{r as l,s}from"./index-98182962.js";import{n as h}from"./phone-376c158e.js";function u(){u.cache||(u.cache={state:{companies:[],loading:!0,error:null},listeners:new Set,refCount:0,channel:null,reloadTimeout:null,loadPromise:null});const r=u.cache,[c,f]=l.useState({companies:r.state.companies,loading:r.state.loading,error:r.state.error}),m=l.useCallback(async()=>{try{r.reloadTimeout&&(clearTimeout(r.reloadTimeout),r.reloadTimeout=null),r.state.loading=!0,r.state.error=null;const{data:o,error:e}=await s.from("companies").select("*").order("name",{ascending:!0});if(e)throw e;r.state.companies=o||[]}catch(o){console.error("Error loading companies:",o),r.state.error=o.message}finally{r.state.loading=!1,r.listeners.forEach(o=>o(r.state))}},[]),d=l.useCallback(async o=>{try{o!=null&&o.phone&&(o.phone=h(o.phone)),o!=null&&o.email&&(o.email=o.email.toLowerCase().trim());const{data:e,error:n}=await s.from("companies").insert([o]).select().single();if(n)throw n;return setCompanies(t=>[...t,e].sort((a,i)=>a.name.localeCompare(i.name))),{data:e,error:null}}catch(e){return console.error("Error creating company:",e),{data:null,error:e.message}}},[]),g=l.useCallback(async(o,e)=>{try{(e!=null&&e.phone||(e==null?void 0:e.phone)==="")&&(e.phone=h(e.phone)),e!=null&&e.email&&(e.email=e.email.toLowerCase().trim());const{data:n,error:t}=await s.from("companies").update(e).eq("id",o).select().single();if(t)throw t;return setCompanies(a=>a.map(i=>i.id===o?n:i).sort((i,w)=>i.name.localeCompare(w.name))),{data:n,error:null}}catch(n){return console.error("Error updating company:",n),{data:null,error:n.message}}},[]),C=l.useCallback(async o=>{try{const{error:e}=await s.from("companies").delete().eq("id",o);if(e)throw e;return setCompanies(n=>n.filter(t=>t.id!==o)),{error:null}}catch(e){return console.error("Error deleting company:",e),{error:e.message}}},[]),p=l.useCallback(o=>{const e=c.companies||[];if(!o)return e;const n=o.toLowerCase();return e.filter(t=>{var a;return(a=t.name)==null?void 0:a.toLowerCase().includes(n)})},[c]);return l.useEffect(()=>{r.refCount+=1;const o=e=>f({companies:e.companies,loading:e.loading,error:e.error});return r.listeners.add(o),f({companies:r.state.companies,loading:r.state.loading,error:r.state.error}),r.state.loading&&r.refCount===1&&m(),r.channel||(r.channel=s.channel("companies-changes").on("postgres_changes",{event:"*",schema:"public",table:"companies"},()=>{r.reloadTimeout&&clearTimeout(r.reloadTimeout),r.reloadTimeout=setTimeout(()=>{m()},500)}).subscribe()),()=>{r.listeners.delete(o),r.refCount-=1,r.refCount<=0&&(r.channel&&s.removeChannel(r.channel),u.cache=null),r.reloadTimeout&&clearTimeout(r.reloadTimeout)}},[m]),{companies:c.companies,loading:c.loading,error:c.error,createCompany:d,updateCompany:g,deleteCompany:C,searchCompanies:p,reload:m}}export{u};
