import{r as c,s as l}from"./index-98182962.js";const u=new Map;function _(t){return`event_map_settings:${t}`}function g(t){const e=_(t);if(u.has(e))return u.get(e);const s={state:{settings:null,loading:!0,error:null},listeners:new Set,refCount:0,channel:null,loadPromise:null};return u.set(e,s),s}async function f(t,e){return e.loadPromise||(e.loadPromise=(async()=>{try{const{data:s,error:a}=await l.from("event_map_settings").select("*").eq("event_year",t).maybeSingle();a&&a.code!=="PGRST116"?(e.state.settings=null,e.state.error=a.message||String(a)):(e.state.settings=s||null,e.state.error=null)}catch(s){console.error("Error loading event_map_settings for",t,s),e.state.settings=null,e.state.error=(s==null?void 0:s.message)||String(s)}finally{e.state.loading=!1,e.listeners.forEach(s=>s(e.state))}})()),e.loadPromise}function C(t,e){if(e.channel)return;const s=`event-map-settings-${t}`;e.channel=l.channel(s).on("postgres_changes",{event:"*",schema:"public",table:"event_map_settings",filter:`event_year=eq.${t}`},()=>{f(t,e)}).subscribe()}function b(t){const e=_(t),s=u.get(e);s&&(s.channel&&l.removeChannel(s.channel),u.delete(e))}function E(t){const[e,s]=c.useState({settings:null,loading:!0,error:null});c.useEffect(()=>{if(!t){s({settings:null,loading:!1,error:null});return}const n=g(t);n.refCount+=1;const r=o=>s({...o});return n.listeners.add(r),s({...n.state}),n.state.loading&&f(t,n),C(t,n),()=>{n.listeners.delete(r),n.refCount-=1,n.refCount<=0&&b(t)}},[t]);const a=c.useCallback(async n=>{if(!t)return console.error("Cannot update settings: No event year specified"),!1;const{data:{user:r}}=await l.auth.getUser();if(!r)return console.error("Cannot update settings: No user logged in"),!1;try{const{data:o,error:d}=await l.from("event_map_settings").upsert([{event_year:t,...n,updated_by:r.id}],{onConflict:"event_year"}).select().maybeSingle();if(d)throw d;const i=g(t);return i.state.settings=o||null,i.state.loading=!1,i.state.error=null,i.listeners.forEach(p=>p(i.state)),!0}catch(o){throw console.error("Error updating event_map_settings:",o),o}},[t]),m=c.useCallback(async()=>{if(!t)return!1;try{const{error:n}=await l.from("event_map_settings").delete().eq("event_year",t);if(n)throw n;const r=g(t);return r.state.settings=null,r.state.error=null,r.state.loading=!1,r.listeners.forEach(o=>o(r.state)),!0}catch(n){throw console.error("Error resetting event_map_settings:",n),n}},[t]),h=c.useCallback(()=>{if(!t)return Promise.resolve();const n=g(t);return f(t,n)},[t]);return{settings:e.settings,loading:e.loading,error:e.error,updateSettings:a,resetToGlobal:m,refetch:h}}export{E as u};
