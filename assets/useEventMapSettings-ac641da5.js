import{r as n,s as c}from"./index-1e4c7e6c.js";function y(){const[r,a]=n.useState(null),[g,d]=n.useState(!0),[w,p]=n.useState(null),i=n.useRef(null),u=n.useCallback(async()=>{var e;try{d(!0);const{data:t,error:s}=await c.from("organization_settings").select("*").eq("id",1).maybeSingle();if(s){if(s.code==="42P01"||(e=s.message)!=null&&e.includes("does not exist")){console.warn("organization_settings table does not exist. Run migrations 25 & 26."),a(null),p(null),d(!1);return}console.error("Error fetching organization settings:",s),p(s.message),a(null),d(!1);return}if(!t){console.warn("Organization settings row not found (id=1). Database migration may not have run."),a(null),p(null),d(!1);return}a(t),p(null),d(!1)}catch(t){console.error("Error in fetchSettings:",t),p(t.message),a(null),d(!1)}},[]),h=n.useCallback(async(e,t)=>{var s;if(!r)return console.error("Cannot update setting: Settings not loaded"),!1;try{const{data:{user:l}}=await c.auth.getUser();if(!l)return console.error("Cannot update setting: No user logged in"),!1;const o=r.row_version||0,{data:f,error:m}=await c.from("organization_settings").update({[e]:t,row_version:o+1,updated_by:l.id}).eq("id",1).eq("row_version",o).select().single();if(m)throw m.code==="PGRST301"||(s=m.message)!=null&&s.includes("permission")?new Error("Permission denied. Only super_admin or system_manager can update organization settings."):(console.error(`Error updating setting ${e}:`,m),new Error(m.message||`Failed to update setting: ${e}`));if(!f)throw await u(),new Error("Organization settings were updated by another admin. Please try again.");return a(f),!0}catch(l){throw console.error("Error in updateSetting:",l),l}},[r,u]),E=n.useCallback(async e=>{var t;if(!r)return console.error("Cannot update settings: Settings not loaded"),!1;try{const{data:{user:s}}=await c.auth.getUser();if(!s)return console.error("Cannot update settings: No user logged in"),!1;const l=r.row_version||0,{data:o,error:f}=await c.from("organization_settings").update({...e,row_version:l+1,updated_by:s.id}).eq("id",1).eq("row_version",l).select().single();if(f)throw f.code==="PGRST301"||(t=f.message)!=null&&t.includes("permission")?new Error("Permission denied. Only super_admin or system_manager can update organization settings."):(console.error("Error updating settings:",f),new Error(f.message||"Failed to update organization settings"));if(!o)throw await u(),new Error("Organization settings were updated by another admin. Please try again.");return a(o),!0}catch(s){throw console.error("Error in updateSettings:",s),s}},[r,u]);return n.useEffect(()=>{u()},[u]),n.useEffect(()=>{if(r)return i.current&&(i.current.unsubscribe(),i.current=null),i.current=c.channel("organization-settings-changes").on("postgres_changes",{event:"UPDATE",schema:"public",table:"organization_settings",filter:"id=eq.1"},e=>{e.new.row_version>(r.row_version||0)&&a(e.new)}).subscribe(),()=>{i.current&&(i.current.unsubscribe(),i.current=null)}},[r==null?void 0:r.row_version]),{settings:r,loading:g,error:w,updateSetting:h,updateSettings:E,refreshSettings:u}}function S(r){const[a,g]=n.useState(null),[d,w]=n.useState(!0),[p,i]=n.useState(null),u=n.useCallback(async()=>{if(!r){g(null),w(!1);return}try{w(!0),i(null);const{data:e,error:t}=await c.from("event_map_settings").select("*").eq("event_year",r).maybeSingle();t&&t.code!=="PGRST116"?(console.error("Error fetching event map settings:",t),i(t.message),g(null)):(g(e),i(null))}catch(e){console.error("Error in fetchSettings:",e),i(e.message),g(null)}finally{w(!1)}},[r]),h=n.useCallback(async e=>{if(!r)return console.error("Cannot update settings: No event year specified"),!1;try{const{data:{user:t}}=await c.auth.getUser();if(!t)return console.error("Cannot update settings: No user logged in"),!1;if(a){const{data:l,error:o}=await c.from("event_map_settings").update({...e,updated_by:t.id}).eq("event_year",r).select().single();if(o)throw console.error("Error updating event map settings:",o),new Error(o.message);g(l)}else{const{data:l,error:o}=await c.from("event_map_settings").insert([{event_year:r,...e,created_by:t.id,updated_by:t.id}]).select().single();if(o)throw console.error("Error creating event map settings:",o),new Error(o.message);g(l)}return!0}catch(t){throw console.error("Error in updateSettings:",t),t}},[r,a]),E=n.useCallback(async()=>{if(!r)return console.error("Cannot reset settings: No event year specified"),!1;try{const{error:e}=await c.from("event_map_settings").delete().eq("event_year",r);if(e)throw console.error("Error resetting event map settings:",e),new Error(e.message);return g(null),!0}catch(e){throw console.error("Error in resetToGlobal:",e),e}},[r]);return n.useEffect(()=>{u()},[u]),{settings:a,loading:d,error:p,updateSettings:h,resetToGlobal:E,refetch:u}}export{S as a,y as u};
