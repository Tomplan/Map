import{r as _}from"./vendor-react-505adfae.js";import{s as a}from"./index-5891cb02.js";import{n as d}from"./phone-a3a14bef.js";function F(u){const[y,w]=_.useState([]),[g,m]=_.useState(!0),[v,p]=_.useState(null),l=_.useRef(null),i=_.useCallback(async()=>{try{l.current&&(clearTimeout(l.current),l.current=null),m(!0),p(null);const{data:r,error:e}=await a.from("event_subscriptions").select(`
          *,
          company:companies(id, name, logo, website, info, contact, phone, email, company_translations(language_code, info))
        `).eq("event_year",u).order("id",{ascending:!0});if(e)throw e;w(r||[])}catch(r){console.error("Error loading event subscriptions:",r),p(r.message)}finally{m(!1)}},[u]),E=async(r,e={})=>{try{const{data:{user:t}}=await a.auth.getUser(),c=(t==null?void 0:t.email)||"unknown",{data:o}=await a.from("companies").select("contact, phone, email").eq("id",r).single(),{data:n}=await a.from("organization_profile").select("default_breakfast_sat, default_lunch_sat, default_bbq_sat, default_breakfast_sun, default_lunch_sun").eq("id",1).single(),h=(n==null?void 0:n.default_breakfast_sat)||0,f=(n==null?void 0:n.default_lunch_sat)||0,s=(n==null?void 0:n.default_bbq_sat)||0,L=(n==null?void 0:n.default_breakfast_sun)||0,B=(n==null?void 0:n.default_lunch_sun)||0,U=e.phone?d(e.phone):o!=null&&o.phone?d(o.phone):"",x=(e.email||(o==null?void 0:o.email)||"").toLowerCase().trim(),{data:z,error:b}=await a.from("event_subscriptions").insert({company_id:r,event_year:u,contact:e.contact||(o==null?void 0:o.contact)||"",phone:U,email:x,booth_count:e.booth_count||1,area:e.area||"",breakfast_sat:e.breakfast_sat??h,lunch_sat:e.lunch_sat??f,bbq_sat:e.bbq_sat??s,breakfast_sun:e.breakfast_sun??L,lunch_sun:e.lunch_sun??B,coins:e.coins||0,notes:e.notes||"",created_by:c}).select().single();if(b)throw b;return await i(),{data:z,error:null}}catch(t){return console.error("Error subscribing company:",t),{data:null,error:t.message}}},k=async(r,e)=>{try{typeof e.phone<"u"&&(e.phone=d(e.phone)),e.email&&(e.email=e.email.toLowerCase().trim());const{data:t,error:c}=await a.from("event_subscriptions").update(e).eq("id",r).select(`
          *,
          company:companies(id, name, logo, website, info, contact, phone, email, company_translations(language_code, info))
        `).single();if(c)throw c;return await i(),{data:t,error:null}}catch(t){return console.error("Error updating subscription:",t),{data:null,error:t.message}}},q=async r=>{try{const{data:e,error:t}=await a.from("event_subscriptions").select("company_id, event_year").eq("id",r).single();if(t)throw t;const{error:c}=await a.from("assignments").delete().eq("company_id",e.company_id).eq("event_year",e.event_year);if(c)throw c;const{error:o}=await a.from("event_subscriptions").delete().eq("id",r);if(o)throw o;return await i(),{error:null}}catch(e){return console.error("Error unsubscribing company:",e),{error:e.message}}},S=async()=>{try{const{data:{user:r}}=await a.auth.getUser(),e=(r==null?void 0:r.email)||"unknown",{data:t,error:c}=await a.rpc("archive_event_subscriptions",{year_to_archive:u,archived_by_user:e});if(c)throw c;return await i(),{data:t,error:null}}catch(r){return console.error("Error archiving subscriptions:",r),{data:null,error:r.message}}},C=async r=>{try{const{data:e,error:t}=await a.from("event_subscriptions_archive").select("*").eq("event_year",r).order("archived_at",{ascending:!1});if(t)throw t;return{data:e,error:null}}catch(e){return console.error("Error loading archived subscriptions:",e),{data:null,error:e.message}}},T=async r=>{try{const{data:{user:e}}=await a.auth.getUser(),t=(e==null?void 0:e.email)||"unknown",{data:c,error:o}=await a.from("event_subscriptions").select("*").eq("event_year",r);if(o)throw o;if(!c||c.length===0)return{data:null,error:"No subscriptions found for source year"};const n=c.map(s=>({company_id:s.company_id,event_year:u,contact:s.contact,phone:s.phone,email:s.email,booth_count:s.booth_count,area:s.area,breakfast_sat:s.breakfast_sat,lunch_sat:s.lunch_sat,bbq_sat:s.bbq_sat,breakfast_sun:s.breakfast_sun,lunch_sun:s.lunch_sun,coins:s.coins,notes:s.notes,created_by:t})),{data:h,error:f}=await a.from("event_subscriptions").insert(n).select();if(f)throw f;return await i(),{data:h,error:null}}catch(e){return console.error("Error copying subscriptions from previous year:",e),{data:null,error:e.message}}};return _.useEffect(()=>{i()},[i]),_.useEffect(()=>{const r=a.channel(`event-subscriptions-changes-${u}`).on("postgres_changes",{event:"*",schema:"public",table:"event_subscriptions",filter:`event_year=eq.${u}`},()=>{l.current&&clearTimeout(l.current),l.current=setTimeout(()=>{i()},500)}).subscribe();return()=>{l.current&&clearTimeout(l.current),a.removeChannel(r)}},[u,i]),{subscriptions:y,loading:g,error:v,subscribeCompany:E,updateSubscription:k,unsubscribeCompany:q,archiveCurrentYear:S,loadArchivedSubscriptions:C,copyFromPreviousYear:T,reload:i}}export{F as u};
