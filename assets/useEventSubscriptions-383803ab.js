import{r as b,s as o}from"./index-12ba77bc.js";import{n as p}from"./phone-376c158e.js";function d(l){d.cache||(d.cache=new Map);let n=d.cache.get(l);n||(n={state:{subscriptions:[],loading:!0,error:null},listeners:new Set,refCount:0,channel:null,reloadTimeout:null,loadPromise:null},d.cache.set(l,n));const[_,f]=b.useState({subscriptions:n.state.subscriptions,loading:n.state.loading,error:n.state.error}),u=b.useCallback(async(r=!1)=>{if(n.loadPromise&&!r)return n.loadPromise;if(n.state.subscriptions.length>0&&!n.state.loading&&!r)return f(e=>e.loading?{...e,loading:!1}:e),Promise.resolve();n.loadPromise=(async()=>{try{n.reloadTimeout&&(clearTimeout(n.reloadTimeout),n.reloadTimeout=null),n.state.loading=!0,n.state.error=null;const{data:e,error:t}=await o.from("event_subscriptions").select(`
            *,
              company:companies(id, name, logo, website, info, contact, phone, email)

          `).eq("event_year",l).order("id",{ascending:!0});if(t)throw t;n.state.subscriptions=e||[]}catch(e){console.error("Error loading event subscriptions:",e),n.state.error=e.message}finally{n.state.loading=!1,n.listeners.forEach(e=>e(n.state)),n.loadPromise=null}})(),await n.loadPromise},[l,n]),g=async(r,e={})=>{try{const{data:{user:t}}=await o.auth.getUser(),c=(t==null?void 0:t.email)||"unknown",{data:s}=await o.from("companies").select("contact, phone, email").eq("id",r).single(),{data:a}=await o.from("organization_profile").select("default_breakfast_sat, default_lunch_sat, default_bbq_sat, default_breakfast_sun, default_lunch_sun, default_coins").eq("id",1).single(),m=(a==null?void 0:a.default_breakfast_sat)||0,h=(a==null?void 0:a.default_lunch_sat)||0,i=(a==null?void 0:a.default_bbq_sat)||0,T=(a==null?void 0:a.default_breakfast_sun)||0,S=(a==null?void 0:a.default_lunch_sun)||0,C=typeof(a==null?void 0:a.default_coins)=="number"?a.default_coins:0,L=e.phone?p(e.phone):s!=null&&s.phone?p(s.phone):"",B=(e.email||(s==null?void 0:s.email)||"").toLowerCase().trim(),{data:U,error:y}=await o.from("event_subscriptions").insert({company_id:r,event_year:l,contact:e.contact||(s==null?void 0:s.contact)||"",phone:L,email:B,booth_count:e.booth_count||1,area:e.area||"",breakfast_sat:e.breakfast_sat??m,lunch_sat:e.lunch_sat??h,bbq_sat:e.bbq_sat??i,breakfast_sun:e.breakfast_sun??T,lunch_sun:e.lunch_sun??S,coins:e.coins??C,notes:e.notes||"",created_by:c}).select().single();if(y)throw y;return await u(),{data:U,error:null}}catch(t){return console.error("Error subscribing company:",t),{data:null,error:t.message}}},w=async(r,e)=>{try{typeof e.phone<"u"&&(e.phone=p(e.phone)),e.email&&(e.email=e.email.toLowerCase().trim());const{data:t,error:c}=await o.from("event_subscriptions").update(e).eq("id",r).select(`
          *,
            company:companies(id, name, logo, website, info, contact, phone, email)

        `).single();if(c)throw c;return await u(),{data:t,error:null}}catch(t){return console.error("Error updating subscription:",t),{data:null,error:t.message}}},v=async r=>{try{const{data:e,error:t}=await o.from("event_subscriptions").select("company_id, event_year").eq("id",r).single();if(t)throw t;const{error:c}=await o.from("assignments").delete().eq("company_id",e.company_id).eq("event_year",e.event_year);if(c)throw c;const{error:s}=await o.from("event_subscriptions").delete().eq("id",r);if(s)throw s;return await u(),{error:null}}catch(e){return console.error("Error unsubscribing company:",e),{error:e.message}}},E=async()=>{try{const{data:{user:r}}=await o.auth.getUser(),e=(r==null?void 0:r.email)||"unknown",{data:t,error:c}=await o.rpc("archive_event_subscriptions",{year_to_archive:l,archived_by_user:e});if(c)throw c;return await u(),{data:t,error:null}}catch(r){return console.error("Error archiving subscriptions:",r),{data:null,error:r.message}}},k=async r=>{try{const{data:e,error:t}=await o.from("event_subscriptions_archive").select("*").eq("event_year",r).order("archived_at",{ascending:!1});if(t)throw t;return{data:e,error:null}}catch(e){return console.error("Error loading archived subscriptions:",e),{data:null,error:e.message}}},q=async r=>{try{const{data:{user:e}}=await o.auth.getUser(),t=(e==null?void 0:e.email)||"unknown",{data:c,error:s}=await o.from("event_subscriptions").select("*").eq("event_year",r);if(s)throw s;if(!c||c.length===0)return{data:null,error:"No subscriptions found for source year"};const a=c.map(i=>({company_id:i.company_id,event_year:l,contact:i.contact,phone:i.phone,email:i.email,booth_count:i.booth_count,area:i.area,breakfast_sat:i.breakfast_sat,lunch_sat:i.lunch_sat,bbq_sat:i.bbq_sat,breakfast_sun:i.breakfast_sun,lunch_sun:i.lunch_sun,coins:i.coins,notes:i.notes,created_by:t})),{data:m,error:h}=await o.from("event_subscriptions").insert(a).select();if(h)throw h;return await u(),{data:m,error:null}}catch(e){return console.error("Error copying subscriptions from previous year:",e),{data:null,error:e.message}}};return b.useEffect(()=>{let r=d.cache.get(l);r||(r={state:{subscriptions:[],loading:!0,error:null},listeners:new Set,refCount:0,channel:null,reloadTimeout:null,loadPromise:null},d.cache.set(l,r)),r.refCount+=1;const e=t=>f({subscriptions:t.subscriptions,loading:t.loading,error:t.error});return r.listeners.add(e),r.state.subscriptions.length>0?f({subscriptions:r.state.subscriptions,loading:!1,error:r.state.error}):f(t=>t.subscriptions===r.state.subscriptions?t:{subscriptions:r.state.subscriptions,loading:r.state.loading,error:r.state.error}),r.state.subscriptions.length===0&&(r.loadPromise||u()),r.channel||(r.channel=o.channel(`event-subscriptions-changes-${l}`).on("postgres_changes",{event:"*",schema:"public",table:"event_subscriptions",filter:`event_year=eq.${l}`},()=>{r.reloadTimeout&&clearTimeout(r.reloadTimeout),r.reloadTimeout=setTimeout(()=>{u(!0)},500)}).subscribe()),()=>{r.listeners.delete(e),r.refCount-=1,r.refCount<=0&&r.channel&&(o.removeChannel(r.channel),r.channel=null),r.reloadTimeout&&clearTimeout(r.reloadTimeout)}},[l,u]),{subscriptions:_.subscriptions,loading:_.loading,error:_.error,subscribeCompany:g,updateSubscription:w,unsubscribeCompany:v,archiveCurrentYear:E,loadArchivedSubscriptions:k,copyFromPreviousYear:q,reload:u}}export{d as u};
