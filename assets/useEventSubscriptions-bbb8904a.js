import{r as b,s as o}from"./index-630dcafa.js";import{n as p}from"./phone-376c158e.js";function d(l){d.cache||(d.cache=new Map);let r=d.cache.get(l);r||(r={state:{subscriptions:[],loading:!0,error:null},listeners:new Set,refCount:0,channel:null,reloadTimeout:null,loadPromise:null},d.cache.set(l,r));const[f,h]=b.useState({subscriptions:r.state.subscriptions,loading:r.state.loading,error:r.state.error}),u=b.useCallback(async(t=!1)=>{if(r.loadPromise&&!t)return r.loadPromise;if(r.state.subscriptions.length>0&&!r.state.loading&&!t)return f.loading&&h(e=>({...e,loading:!1})),Promise.resolve();r.loadPromise=(async()=>{try{r.reloadTimeout&&(clearTimeout(r.reloadTimeout),r.reloadTimeout=null),r.state.loading=!0,r.state.error=null;const{data:e,error:n}=await o.from("event_subscriptions").select(`
            *,
              company:companies(id, name, logo, website, info, contact, phone, email)

          `).eq("event_year",l).order("id",{ascending:!0});if(n)throw n;r.state.subscriptions=e||[]}catch(e){console.error("Error loading event subscriptions:",e),r.state.error=e.message}finally{r.state.loading=!1,r.listeners.forEach(e=>e(r.state)),r.loadPromise=null}})(),await r.loadPromise},[l]),y=async(t,e={})=>{try{const{data:{user:n}}=await o.auth.getUser(),c=(n==null?void 0:n.email)||"unknown",{data:s}=await o.from("companies").select("contact, phone, email").eq("id",t).single(),{data:a}=await o.from("organization_profile").select("default_breakfast_sat, default_lunch_sat, default_bbq_sat, default_breakfast_sun, default_lunch_sun, default_coins").eq("id",1).single(),m=(a==null?void 0:a.default_breakfast_sat)||0,_=(a==null?void 0:a.default_lunch_sat)||0,i=(a==null?void 0:a.default_bbq_sat)||0,T=(a==null?void 0:a.default_breakfast_sun)||0,S=(a==null?void 0:a.default_lunch_sun)||0,C=typeof(a==null?void 0:a.default_coins)=="number"?a.default_coins:0,L=e.phone?p(e.phone):s!=null&&s.phone?p(s.phone):"",B=(e.email||(s==null?void 0:s.email)||"").toLowerCase().trim(),{data:U,error:g}=await o.from("event_subscriptions").insert({company_id:t,event_year:l,contact:e.contact||(s==null?void 0:s.contact)||"",phone:L,email:B,booth_count:e.booth_count||1,area:e.area||"",breakfast_sat:e.breakfast_sat??m,lunch_sat:e.lunch_sat??_,bbq_sat:e.bbq_sat??i,breakfast_sun:e.breakfast_sun??T,lunch_sun:e.lunch_sun??S,coins:e.coins??C,notes:e.notes||"",created_by:c}).select().single();if(g)throw g;return await u(),{data:U,error:null}}catch(n){return console.error("Error subscribing company:",n),{data:null,error:n.message}}},w=async(t,e)=>{try{typeof e.phone<"u"&&(e.phone=p(e.phone)),e.email&&(e.email=e.email.toLowerCase().trim());const{data:n,error:c}=await o.from("event_subscriptions").update(e).eq("id",t).select(`
          *,
            company:companies(id, name, logo, website, info, contact, phone, email)

        `).single();if(c)throw c;return await u(),{data:n,error:null}}catch(n){return console.error("Error updating subscription:",n),{data:null,error:n.message}}},v=async t=>{try{const{data:e,error:n}=await o.from("event_subscriptions").select("company_id, event_year").eq("id",t).single();if(n)throw n;const{error:c}=await o.from("assignments").delete().eq("company_id",e.company_id).eq("event_year",e.event_year);if(c)throw c;const{error:s}=await o.from("event_subscriptions").delete().eq("id",t);if(s)throw s;return await u(),{error:null}}catch(e){return console.error("Error unsubscribing company:",e),{error:e.message}}},E=async()=>{try{const{data:{user:t}}=await o.auth.getUser(),e=(t==null?void 0:t.email)||"unknown",{data:n,error:c}=await o.rpc("archive_event_subscriptions",{year_to_archive:l,archived_by_user:e});if(c)throw c;return await u(),{data:n,error:null}}catch(t){return console.error("Error archiving subscriptions:",t),{data:null,error:t.message}}},k=async t=>{try{const{data:e,error:n}=await o.from("event_subscriptions_archive").select("*").eq("event_year",t).order("archived_at",{ascending:!1});if(n)throw n;return{data:e,error:null}}catch(e){return console.error("Error loading archived subscriptions:",e),{data:null,error:e.message}}},q=async t=>{try{const{data:{user:e}}=await o.auth.getUser(),n=(e==null?void 0:e.email)||"unknown",{data:c,error:s}=await o.from("event_subscriptions").select("*").eq("event_year",t);if(s)throw s;if(!c||c.length===0)return{data:null,error:"No subscriptions found for source year"};const a=c.map(i=>({company_id:i.company_id,event_year:l,contact:i.contact,phone:i.phone,email:i.email,booth_count:i.booth_count,area:i.area,breakfast_sat:i.breakfast_sat,lunch_sat:i.lunch_sat,bbq_sat:i.bbq_sat,breakfast_sun:i.breakfast_sun,lunch_sun:i.lunch_sun,coins:i.coins,notes:i.notes,created_by:n})),{data:m,error:_}=await o.from("event_subscriptions").insert(a).select();if(_)throw _;return await u(),{data:m,error:null}}catch(e){return console.error("Error copying subscriptions from previous year:",e),{data:null,error:e.message}}};return b.useEffect(()=>{r=d.cache.get(l),r||(r={state:{subscriptions:[],loading:!0,error:null},listeners:new Set,refCount:0,channel:null,reloadTimeout:null,loadPromise:null},d.cache.set(l,r)),r.refCount+=1;const t=e=>h({subscriptions:e.subscriptions,loading:e.loading,error:e.error});return r.listeners.add(t),r.state.subscriptions.length>0?h({subscriptions:r.state.subscriptions,loading:!1,error:r.state.error}):f.subscriptions!==r.state.subscriptions&&h({subscriptions:r.state.subscriptions,loading:r.state.loading,error:r.state.error}),r.state.subscriptions.length===0&&(r.loadPromise||u()),r.channel||(r.channel=o.channel(`event-subscriptions-changes-${l}`).on("postgres_changes",{event:"*",schema:"public",table:"event_subscriptions",filter:`event_year=eq.${l}`},()=>{r.reloadTimeout&&clearTimeout(r.reloadTimeout),r.reloadTimeout=setTimeout(()=>{u(!0)},500)}).subscribe()),()=>{r.listeners.delete(t),r.refCount-=1,r.refCount<=0&&r.channel&&(o.removeChannel(r.channel),r.channel=null),r.reloadTimeout&&clearTimeout(r.reloadTimeout)}},[l,u]),{subscriptions:f.subscriptions,loading:f.loading,error:f.error,subscribeCompany:y,updateSubscription:w,unsubscribeCompany:v,archiveCurrentYear:E,loadArchivedSubscriptions:k,copyFromPreviousYear:q,reload:u}}export{d as u};
