import{r as m,s as o}from"./index-9f8e3d41.js";import{n as p}from"./phone-376c158e.js";function d(l){d.cache||(d.cache=new Map);let r=d.cache.get(l);r||(r={state:{subscriptions:[],loading:!0,error:null},listeners:new Set,refCount:0,channel:null,reloadTimeout:null,loadPromise:null},d.cache.set(l,r));const[h,b]=m.useState({subscriptions:r.state.subscriptions,loading:r.state.loading,error:r.state.error}),u=m.useCallback(async()=>{try{r.reloadTimeout&&(clearTimeout(r.reloadTimeout),r.reloadTimeout=null),r.state.loading=!0,r.state.error=null;const{data:t,error:e}=await o.from("event_subscriptions").select(`
          *,
          company:companies(id, name, logo, website, info, contact, phone, email, company_translations(language_code, info))
        `).eq("event_year",l).order("id",{ascending:!0});if(e)throw e;r.state.subscriptions=t||[]}catch(t){console.error("Error loading event subscriptions:",t),r.state.error=t.message}finally{r.state.loading=!1,r.listeners.forEach(t=>t(r.state))}},[l]),g=async(t,e={})=>{try{const{data:{user:a}}=await o.auth.getUser(),i=(a==null?void 0:a.email)||"unknown",{data:s}=await o.from("companies").select("contact, phone, email").eq("id",t).single(),{data:n}=await o.from("organization_profile").select("default_breakfast_sat, default_lunch_sat, default_bbq_sat, default_breakfast_sun, default_lunch_sun, default_coins").eq("id",1).single(),f=(n==null?void 0:n.default_breakfast_sat)||0,_=(n==null?void 0:n.default_lunch_sat)||0,c=(n==null?void 0:n.default_bbq_sat)||0,T=(n==null?void 0:n.default_breakfast_sun)||0,C=(n==null?void 0:n.default_lunch_sun)||0,S=typeof(n==null?void 0:n.default_coins)=="number"?n.default_coins:0,L=e.phone?p(e.phone):s!=null&&s.phone?p(s.phone):"",B=(e.email||(s==null?void 0:s.email)||"").toLowerCase().trim(),{data:U,error:y}=await o.from("event_subscriptions").insert({company_id:t,event_year:l,contact:e.contact||(s==null?void 0:s.contact)||"",phone:L,email:B,booth_count:e.booth_count||1,area:e.area||"",breakfast_sat:e.breakfast_sat??f,lunch_sat:e.lunch_sat??_,bbq_sat:e.bbq_sat??c,breakfast_sun:e.breakfast_sun??T,lunch_sun:e.lunch_sun??C,coins:e.coins??S,notes:e.notes||"",created_by:i}).select().single();if(y)throw y;return await u(),{data:U,error:null}}catch(a){return console.error("Error subscribing company:",a),{data:null,error:a.message}}},w=async(t,e)=>{try{typeof e.phone<"u"&&(e.phone=p(e.phone)),e.email&&(e.email=e.email.toLowerCase().trim());const{data:a,error:i}=await o.from("event_subscriptions").update(e).eq("id",t).select(`
          *,
          company:companies(id, name, logo, website, info, contact, phone, email, company_translations(language_code, info))
        `).single();if(i)throw i;return await u(),{data:a,error:null}}catch(a){return console.error("Error updating subscription:",a),{data:null,error:a.message}}},v=async t=>{try{const{data:e,error:a}=await o.from("event_subscriptions").select("company_id, event_year").eq("id",t).single();if(a)throw a;const{error:i}=await o.from("assignments").delete().eq("company_id",e.company_id).eq("event_year",e.event_year);if(i)throw i;const{error:s}=await o.from("event_subscriptions").delete().eq("id",t);if(s)throw s;return await u(),{error:null}}catch(e){return console.error("Error unsubscribing company:",e),{error:e.message}}},E=async()=>{try{const{data:{user:t}}=await o.auth.getUser(),e=(t==null?void 0:t.email)||"unknown",{data:a,error:i}=await o.rpc("archive_event_subscriptions",{year_to_archive:l,archived_by_user:e});if(i)throw i;return await u(),{data:a,error:null}}catch(t){return console.error("Error archiving subscriptions:",t),{data:null,error:t.message}}},k=async t=>{try{const{data:e,error:a}=await o.from("event_subscriptions_archive").select("*").eq("event_year",t).order("archived_at",{ascending:!1});if(a)throw a;return{data:e,error:null}}catch(e){return console.error("Error loading archived subscriptions:",e),{data:null,error:e.message}}},q=async t=>{try{const{data:{user:e}}=await o.auth.getUser(),a=(e==null?void 0:e.email)||"unknown",{data:i,error:s}=await o.from("event_subscriptions").select("*").eq("event_year",t);if(s)throw s;if(!i||i.length===0)return{data:null,error:"No subscriptions found for source year"};const n=i.map(c=>({company_id:c.company_id,event_year:l,contact:c.contact,phone:c.phone,email:c.email,booth_count:c.booth_count,area:c.area,breakfast_sat:c.breakfast_sat,lunch_sat:c.lunch_sat,bbq_sat:c.bbq_sat,breakfast_sun:c.breakfast_sun,lunch_sun:c.lunch_sun,coins:c.coins,notes:c.notes,created_by:a})),{data:f,error:_}=await o.from("event_subscriptions").insert(n).select();if(_)throw _;return await u(),{data:f,error:null}}catch(e){return console.error("Error copying subscriptions from previous year:",e),{data:null,error:e.message}}};return m.useEffect(()=>{r=d.cache.get(l),r.refCount+=1;const t=e=>b({subscriptions:e.subscriptions,loading:e.loading,error:e.error});return r.listeners.add(t),b({subscriptions:r.state.subscriptions,loading:r.state.loading,error:r.state.error}),r.state.loading&&r.refCount===1&&u(),r.channel||(r.channel=o.channel(`event-subscriptions-changes-${l}`).on("postgres_changes",{event:"*",schema:"public",table:"event_subscriptions",filter:`event_year=eq.${l}`},()=>{r.reloadTimeout&&clearTimeout(r.reloadTimeout),r.reloadTimeout=setTimeout(()=>{u()},500)}).subscribe()),()=>{r.listeners.delete(t),r.refCount-=1,r.refCount<=0&&(r.channel&&o.removeChannel(r.channel),d.cache.delete(l)),r.reloadTimeout&&clearTimeout(r.reloadTimeout)}},[l,u]),{subscriptions:h.subscriptions,loading:h.loading,error:h.error,subscribeCompany:g,updateSubscription:w,unsubscribeCompany:v,archiveCurrentYear:E,loadArchivedSubscriptions:k,copyFromPreviousYear:q,reload:u}}export{d as u};
