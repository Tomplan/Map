import{r as h,s as t}from"./index-630dcafa.js";const i=new Map;function f(r){return`markerGlyphs:${r}`}async function c(r,e){return e.loadPromise||(e.loadPromise=(async()=>{try{e.state.loading=!0;const[a,n]=await Promise.all([t.from("markers_core").select("id").lt("id",1e3).eq("event_year",r).order("id",{ascending:!0}),t.from("markers_appearance").select("id, glyph").lt("id",1e3).eq("event_year",r)]);if(a.error)throw a.error;if(n.error)throw n.error;const s={};(n.data||[]).forEach(o=>{o&&o.id&&(s[o.id]=o.glyph||"")});const l=(a.data||[]).map(o=>({id:o.id,glyph:s[o.id]||String(o.id)}));e.state.markers=l,e.state.error=null}catch(a){console.error("Error loading marker glyphs for",r,a),e.state.markers=[],e.state.error=(a==null?void 0:a.message)||String(a)}finally{e.state.loading=!1,e.listeners.forEach(a=>a(e.state))}})()),e.loadPromise}function p(r,e){if(e.channels&&e.channels.length>0)return;const a=t.channel(`markers-core-glyphs-${r}`).on("postgres_changes",{event:"*",schema:"public",table:"markers_core",filter:`event_year=eq.${r}`},()=>c(r,e)).subscribe(),n=t.channel(`markers-appearance-glyphs-${r}`).on("postgres_changes",{event:"*",schema:"public",table:"markers_appearance",filter:`event_year=eq.${r}`},()=>c(r,e)).subscribe();e.channels=[a,n]}function u(r){const e=f(r),a=i.get(e);if(a){for(const n of a.channels||[])t.removeChannel(n);a.channels=[]}}function g(r){const[e,a]=h.useState({markers:[],loading:!0,error:null});return h.useEffect(()=>{if(!r){a({markers:[],loading:!1,error:null});return}const n=f(r);let s=i.get(n);s||(s={state:{markers:[],loading:!0,error:null},listeners:new Set,refCount:0,channels:[],loadPromise:null},i.set(n,s)),s.refCount+=1;const l=o=>a({...o});return s.listeners.add(l),a({...s.state}),s.state.loading&&!s.loadPromise&&c(r,s),(!s.channels||s.channels.length===0)&&p(r,s),()=>{s.listeners.delete(l),s.refCount-=1,s.refCount<=0&&u(r)}},[r]),{markers:e.markers,loading:e.loading,error:e.error}}export{g as u};
