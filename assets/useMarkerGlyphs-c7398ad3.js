import{r as u,s as l}from"./index-9f8e3d41.js";const o=new Map;function h(r){return`markerGlyphs:${r}`}function p(r){const e=h(r);if(o.has(e))return o.get(e);const s={state:{markers:[],loading:!0,error:null},listeners:new Set,refCount:0,channels:[],loadPromise:null};return o.set(e,s),s}async function c(r,e){return e.loadPromise||(e.loadPromise=(async()=>{try{e.state.loading=!0;const[s,n]=await Promise.all([l.from("markers_core").select("id").lt("id",1e3).eq("event_year",r).order("id",{ascending:!0}),l.from("markers_appearance").select("id, glyph").lt("id",1e3).eq("event_year",r)]);if(s.error)throw s.error;if(n.error)throw n.error;const t={};(n.data||[]).forEach(a=>{a&&a.id&&(t[a.id]=a.glyph||"")});const i=(s.data||[]).map(a=>({id:a.id,glyph:t[a.id]||String(a.id)}));e.state.markers=i,e.state.error=null}catch(s){console.error("Error loading marker glyphs for",r,s),e.state.markers=[],e.state.error=(s==null?void 0:s.message)||String(s)}finally{e.state.loading=!1,e.listeners.forEach(s=>s(e.state))}})()),e.loadPromise}function f(r,e){if(e.channels&&e.channels.length>0)return;const s=l.channel(`markers-core-glyphs-${r}`).on("postgres_changes",{event:"*",schema:"public",table:"markers_core",filter:`event_year=eq.${r}`},()=>c(r,e)).subscribe(),n=l.channel(`markers-appearance-glyphs-${r}`).on("postgres_changes",{event:"*",schema:"public",table:"markers_appearance",filter:`event_year=eq.${r}`},()=>c(r,e)).subscribe();e.channels=[s,n]}function d(r){const e=h(r),s=o.get(e);if(s){for(const n of s.channels||[])l.removeChannel(n);o.delete(e)}}function m(r){const[e,s]=u.useState({markers:[],loading:!0,error:null});return u.useEffect(()=>{if(!r){s({markers:[],loading:!1,error:null});return}const n=p(r);n.refCount+=1;const t=i=>s({...i});return n.listeners.add(t),s({...n.state}),n.state.loading&&c(r,n),f(r,n),()=>{n.listeners.delete(t),n.refCount-=1,n.refCount<=0&&d(r)}},[r]),{markers:e.markers,loading:e.loading,error:e.error}}export{m as u};
