import{r as f,s as a}from"./index-d4e44bf1.js";import{n as g}from"./phone-376c158e.js";const i={state:{profile:null,loading:!0,error:null},listeners:new Set,refCount:0,channel:null,loadPromise:null};async function h(e){return e.loadPromise||(e.loadPromise=(async()=>{try{const{data:o,error:l}=await a.from("organization_profile").select("*").single();if(l)if(l.code==="PGRST116")console.warn("No organization profile found. A default one should be created by the migration."),e.state.profile=null;else throw l;else e.state.profile=o;e.state.error=null}catch(o){console.error("Error fetching organization profile:",o),e.state.error=o.message,e.state.profile=null}finally{e.state.loading=!1,e.listeners.forEach(o=>o(e.state))}})()),e.loadPromise}function u(e){e.channel||(e.channel=a.channel("organization-profile").on("postgres_changes",{event:"*",schema:"public",table:"organization_profile",filter:"id=eq.1"},o=>{o.new&&(e.state.profile=o.new,e.listeners.forEach(l=>l(e.state)))}).subscribe())}function m(){i.channel&&a.removeChannel(i.channel),i.state={profile:null,loading:!0,error:null}}function d(){const[e,o]=f.useState({profile:null,loading:!0,error:null});f.useEffect(()=>{const r=i;r.refCount+=1;const n=t=>o({...t});return r.listeners.add(n),o({...r.state}),r.state.loading&&h(r),u(r),()=>{r.listeners.delete(n),r.refCount-=1,r.refCount<=0&&m()}},[]);const l=async r=>{try{(r!=null&&r.phone||(r==null?void 0:r.phone)==="")&&(r.phone=g(r.phone)),r!=null&&r.email&&(r.email=r.email.toLowerCase().trim());const{data:n,error:t}=await a.from("organization_profile").update(r).eq("id",1).select().single();if(t)throw t;const s=i;return s.state.profile=n,s.listeners.forEach(c=>c(s.state)),{data:n,error:null}}catch(n){return console.error("Error updating organization profile:",n),{data:null,error:n.message}}};return{profile:e.profile,loading:e.loading,error:e.error,updateProfile:l}}export{d as u};
