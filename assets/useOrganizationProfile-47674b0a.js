import{r as f,s as t}from"./index-630dcafa.js";import{n as g}from"./phone-376c158e.js";const l={state:{profile:null,loading:!0,error:null},listeners:new Set,refCount:0,channel:null,loadPromise:null};async function h(e){return e.loadPromise||(e.loadPromise=(async()=>{try{const{data:o,error:i}=await t.from("organization_profile").select("*").single();if(i)if(i.code==="PGRST116")console.warn("No organization profile found. A default one should be created by the migration."),e.state.profile=null;else throw i;else e.state.profile=o;e.state.error=null}catch(o){console.error("Error fetching organization profile:",o),e.state.error=o.message,e.state.profile=null}finally{e.state.loading=!1,e.listeners.forEach(o=>o(e.state))}})()),e.loadPromise}function m(e){e.channel||(e.channel=t.channel("organization-profile").on("postgres_changes",{event:"*",schema:"public",table:"organization_profile",filter:"id=eq.1"},o=>{o.new&&(e.state.profile=o.new,e.listeners.forEach(i=>i(e.state)))}).subscribe())}function u(){if(l.channel){try{t.removeChannel(l.channel)}catch(e){console.error("Error removing channel:",e)}l.channel=null}}function P(){const[e,o]=f.useState({profile:l.state.profile,loading:l.state.loading,error:l.state.error});f.useEffect(()=>{const r=l;r.refCount+=1;const n=a=>o({...a});return r.listeners.add(n),(e.profile!==r.state.profile||e.loading!==r.state.loading)&&o({...r.state}),r.state.loading&&!r.loadPromise&&h(r),r.channel||m(r),()=>{r.listeners.delete(n),r.refCount-=1,r.refCount<=0&&u()}},[]);const i=async r=>{try{(r!=null&&r.phone||(r==null?void 0:r.phone)==="")&&(r.phone=g(r.phone)),r!=null&&r.email&&(r.email=r.email.toLowerCase().trim());const{data:n,error:a}=await t.from("organization_profile").update(r).eq("id",1).select().single();if(a)throw a;const s=l;return s.state.profile=n,s.listeners.forEach(c=>c(s.state)),{data:n,error:null}}catch(n){return console.error("Error updating organization profile:",n),{data:null,error:n.message}}};return{profile:e.profile,loading:e.loading,error:e.error,updateProfile:i}}export{P as u};
