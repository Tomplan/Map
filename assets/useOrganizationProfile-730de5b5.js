import{r as f,s as t}from"./index-7f5811f0.js";import{n as g}from"./phone-376c158e.js";const i={state:{profile:null,loading:!0,error:null},listeners:new Set,refCount:0,channel:null,loadPromise:null};async function h(e){return e.loadPromise||(e.loadPromise=(async()=>{try{const{data:o,error:a}=await t.from("organization_profile").select("*").single();if(a)if(a.code==="PGRST116")console.warn("No organization profile found. A default one should be created by the migration."),e.state.profile=null;else throw a;else e.state.profile=o;e.state.error=null}catch(o){console.error("Error fetching organization profile:",o),e.state.error=o.message,e.state.profile=null}finally{e.state.loading=!1,e.listeners.forEach(o=>o(e.state))}})()),e.loadPromise}function m(e){e.channel||(e.channel=t.channel("organization-profile").on("postgres_changes",{event:"*",schema:"public",table:"organization_profile",filter:"id=eq.1"},o=>{o.new&&(e.state.profile=o.new,e.listeners.forEach(a=>a(e.state)))}).subscribe())}function u(){if(i.channel){try{t.removeChannel(i.channel)}catch(e){console.error("Error removing channel:",e)}i.channel=null}}function P(){const[e,o]=f.useState({profile:i.state.profile,loading:i.state.loading,error:i.state.error});f.useEffect(()=>{const r=i;r.refCount+=1;const n=l=>o({...l});return r.listeners.add(n),o(l=>l.profile===r.state.profile&&l.loading===r.state.loading?l:{...r.state}),r.state.loading&&!r.loadPromise&&h(r),r.channel||m(r),()=>{r.listeners.delete(n),r.refCount-=1,r.refCount<=0&&u()}},[]);const a=async r=>{try{(r!=null&&r.phone||(r==null?void 0:r.phone)==="")&&(r.phone=g(r.phone)),r!=null&&r.email&&(r.email=r.email.toLowerCase().trim());const{data:n,error:l}=await t.from("organization_profile").update(r).eq("id",1).select().single();if(l)throw l;const s=i;return s.state.profile=n,s.listeners.forEach(c=>c(s.state)),{data:n,error:null}}catch(n){return console.error("Error updating organization profile:",n),{data:null,error:n.message}}};return{profile:e.profile,loading:e.loading,error:e.error,updateProfile:a}}export{P as u};
