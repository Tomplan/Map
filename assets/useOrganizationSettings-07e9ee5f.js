import{r as s}from"./vendor-react-600751b5.js";import{s as g}from"./index-c9551a19.js";function y(){const[t,o]=s.useState(null),[m,l]=s.useState(!0),[h,d]=s.useState(null),u=s.useRef(null),c=s.useCallback(async()=>{var r;try{l(!0);const{data:n,error:e}=await g.from("organization_settings").select("*").eq("id",1).maybeSingle();if(e){if(e.code==="42P01"||(r=e.message)!=null&&r.includes("does not exist")){console.warn("organization_settings table does not exist. Run migrations 25 & 26."),o(null),d(null),l(!1);return}console.error("Error fetching organization settings:",e),d(e.message),o(null),l(!1);return}if(!n){console.warn("Organization settings row not found (id=1). Database migration may not have run."),o(null),d(null),l(!1);return}o(n),d(null),l(!1)}catch(n){console.error("Error in fetchSettings:",n),d(n.message),o(null),l(!1)}},[]),E=s.useCallback(async(r,n)=>{var e;if(!t)return console.error("Cannot update setting: Settings not loaded"),!1;try{const{data:{user:a}}=await g.auth.getUser();if(!a)return console.error("Cannot update setting: No user logged in"),!1;const f=t.row_version||0,{data:i,error:w}=await g.from("organization_settings").update({[r]:n,row_version:f+1,updated_by:a.id}).eq("id",1).eq("row_version",f).select().single();if(w)throw w.code==="PGRST301"||(e=w.message)!=null&&e.includes("permission")?new Error("Permission denied. Only super_admin or system_manager can update organization settings."):(console.error(`Error updating setting ${r}:`,w),new Error(w.message||`Failed to update setting: ${r}`));if(!i)throw await c(),new Error("Organization settings were updated by another admin. Please try again.");return o(i),!0}catch(a){throw console.error("Error in updateSetting:",a),a}},[t,c]),_=s.useCallback(async r=>{var n;if(!t)return console.error("Cannot update settings: Settings not loaded"),!1;try{const{data:{user:e}}=await g.auth.getUser();if(!e)return console.error("Cannot update settings: No user logged in"),!1;const a=t.row_version||0,{data:f,error:i}=await g.from("organization_settings").update({...r,row_version:a+1,updated_by:e.id}).eq("id",1).eq("row_version",a).select().single();if(i)throw i.code==="PGRST301"||(n=i.message)!=null&&n.includes("permission")?new Error("Permission denied. Only super_admin or system_manager can update organization settings."):(console.error("Error updating settings:",i),new Error(i.message||"Failed to update organization settings"));if(!f)throw await c(),new Error("Organization settings were updated by another admin. Please try again.");return o(f),!0}catch(e){throw console.error("Error in updateSettings:",e),e}},[t,c]);s.useEffect(()=>{c()},[c]);const p=(t==null?void 0:t.row_version)??0;return s.useEffect(()=>(u.current&&(u.current.unsubscribe(),u.current=null),u.current=g.channel("organization-settings-changes").on("postgres_changes",{event:"UPDATE",schema:"public",table:"organization_settings",filter:"id=eq.1"},r=>{r.new.row_version>p&&o(r.new)}).subscribe(),()=>{u.current&&(u.current.unsubscribe(),u.current=null)}),[p]),{settings:t,loading:m,error:h,updateSetting:E,updateSettings:_,refreshSettings:c}}export{y as u};
