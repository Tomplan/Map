-- 23_normalize_phones_conservative.sql
-- Conservative, idempotent phone normalization for companies and event_subscriptions
-- - removes formatting characters (spaces, parentheses, dashes, dots)
-- - converts leading 00 to +
-- - collapses multiple + signs to a single +
-- - converts empty strings to NULL
-- This is conservative and does NOT validate country-specific E.164 rules.

BEGIN;

-- Helper inlined: produce a cleaned version of the phone number
-- Steps applied in order:
-- 1. trim whitespace
-- 2. replace leading 00 with +
-- 3. keep digits and + only
-- 4. collapse multiple leading + signs to single +
-- 5. empty -> NULL

-- UPDATE companies table
WITH proposed AS (
  SELECT
    id,
    phone,
    NULLIF(
      regexp_replace(
        regexp_replace(trim(phone), '^00', '+'),
        '[^0-9+]+', '', 'g'
      ),
      ''
    ) AS cleaned
  FROM companies
  WHERE phone IS NOT NULL
)
UPDATE companies c
SET phone = CASE
  WHEN cleaned = '+' THEN NULL
  ELSE regexp_replace(cleaned, '^\++', '+')
END
FROM proposed p
WHERE c.id = p.id
  AND (
    (p.cleaned IS DISTINCT FROM NULL AND c.phone IS DISTINCT FROM p.cleaned)
    OR (p.cleaned IS NULL AND c.phone IS NOT NULL)
  );

-- UPDATE event_subscriptions table
WITH proposed AS (
  SELECT
    id,
    phone,
    NULLIF(
      regexp_replace(
        regexp_replace(trim(phone), '^00', '+'),
        '[^0-9+]+', '', 'g'
      ),
      ''
    ) AS cleaned
  FROM event_subscriptions
  WHERE phone IS NOT NULL
)
UPDATE event_subscriptions e
SET phone = CASE
  WHEN cleaned = '+' THEN NULL
  ELSE regexp_replace(cleaned, '^\++', '+')
END
FROM proposed p
WHERE e.id = p.id
  AND (
    (p.cleaned IS DISTINCT FROM NULL AND e.phone IS DISTINCT FROM p.cleaned)
    OR (p.cleaned IS NULL AND e.phone IS NOT NULL)
  );

COMMIT;

-- Notes:
-- * Idempotent: running again will not change rows where phone is already normalized.
-- * This intentionally avoids guessing country codes or validating numbers; use the JS normalization script
--   (libphonenumber based) if you want stricter E.164 results.
